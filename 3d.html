<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Modeler Pro ‚Äì BowesProduct</title>

  <!-- ES Module Shims for browser compatibility -->
  <script async src="https://unpkg.com/es-module-shims@1.8.2/dist/es-module-shims.js"></script>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
    }
  }
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; background: #020617; color: white; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; -webkit-font-smoothing: antialiased; }

    /* HEADER */
    .site-header { position: sticky; top: 0; z-index: 1000; background: rgba(2,6,23,0.95); border-bottom: 1px solid #1e293b; backdrop-filter: blur(10px); }
    .header-inner { max-width: 1200px; margin: 0 auto; padding: 0.6rem 1rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; }
    .header-left { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .logo a { font-size: 1.3rem; font-weight: 700; color: white; text-decoration: none; white-space: nowrap; }
    .main-nav { display: flex; gap: 1rem; flex-wrap: wrap; }
    .main-nav a { color: #e5e7eb; text-decoration: none; font-size: 0.9rem; white-space: nowrap; }
    .main-nav a:hover, .main-nav a.active { color: #60a5fa; }
    .header-right { display: flex; align-items: center; gap: 0.8rem; min-height: 44px; flex-wrap: wrap; }
    #profilePic { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #60a5fa; object-fit: cover; display: none; }
    .login-btn { padding: 0.45rem 1.1rem; border-radius: 999px; border: 1.5px solid #60a5fa; background: transparent; color: #60a5fa; font-size: 0.95rem; cursor: pointer; }
    #levelInfo { display: none; font-size: 0.8rem; color: #cbd5e1; }
    #levelText { white-space: nowrap; font-size: 0.75rem; }
    #xpOuter { width: 100px; height: 5px; background: #1e293b; border-radius: 3px; margin-top: 4px; }
    #xpBar { height: 100%; width: 0%; background: #60a5fa; border-radius: 3px; transition: width 0.35s ease; }

    /* MAIN LAYOUT */
    #container { position: relative; width: 100%; height: 100%; padding-top: 70px; padding-bottom: 80px; }
    #canvas { display: block; width: 100%; height: 100%; touch-action: none; outline: none; }

    /* LOADER */
    #loader {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: #60a5fa; font-size: 1.5rem; font-weight: bold; pointer-events: none; z-index: 5;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }

    /* PANEL */
    .panel { position: absolute; top: 90px; right: 20px; width: 380px; max-height: calc(100vh - 220px); background: rgba(2, 6, 23, 0.95); border: 1px solid #1e293b; border-radius: 12px; padding: 1.5rem; overflow-y: auto; z-index: 20; backdrop-filter: blur(10px); transition: transform 0.3s ease; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    .panel.hidden { transform: translateX(420px); }
    .panel::-webkit-scrollbar { width: 6px; }
    .panel::-webkit-scrollbar-track { background: #0f172a; }
    .panel::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

    #panelToggle { position: absolute; left: -60px; top: 50%; transform: translateY(-50%); width: 60px; height: 110px; background: rgba(2, 6, 23, 0.98); border: 1px solid #1e293b; border-right: none; border-radius: 20px 0 0 20px; color: #60a5fa; font-size: 2.4rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 21; backdrop-filter: blur(12px); box-shadow: 0 6px 30px rgba(0,0,0,0.5); transition: all 0.3s ease; }
    #panelToggle:hover { background: rgba(30, 41, 59, 0.98); color: white; transform: translateY(-50%) translateX(-4px); }

    /* MOBILE */
    @media (max-width: 900px) {
      .panel { position: absolute; top: auto; right: 0; left: 0; bottom: 0; width: 100%; height: 85vh; max-height: none; border-radius: 20px 20px 0 0; transform: translateY(calc(100% - 60px)); transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1); padding-top: 20px; padding-bottom: 120px; z-index: 1100; overflow-y: auto; background: rgba(2, 6, 23, 0.95); border: 1px solid #1e293b; border-bottom: none; box-shadow: 0 -5px 25px rgba(0,0,0,0.5); }
      .panel.visible { transform: translateY(0); }
      #panelToggle { display: none; }
    }

    #mobilePanelToggle { position: fixed; bottom: 20px; right: 20px; width: 140px; height: 44px; background: rgba(2, 6, 23, 0.9); border: 1px solid #60a5fa; border-radius: 22px; color: #60a5fa; font-size: 0.85rem; font-weight: 700; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1200; backdrop-filter: blur(12px); box-shadow: 0 4px 20px rgba(0,0,0,0.6); transition: background 0.2s, transform 0.1s; text-transform: uppercase; letter-spacing: 0.5px; }
    #mobilePanelToggle:active { transform: scale(0.96); }
    #mobilePanelToggle::before { content: ''; position: absolute; top: -6px; left: 50%; transform: translateX(-50%); width: 40px; height: 4px; background: #94a3b8; border-radius: 2px; opacity: 0.5; }
    @media (min-width: 901px) { #mobilePanelToggle { display: none; } }
    @media (max-width: 900px) { #mobilePanelToggle { display: flex; } }

    /* FLOATING CONTROLS */
    #floatingControls { position: fixed; bottom: 20px; left: 20px; display: flex; gap: 10px; z-index: 1150; pointer-events: none; }
    .floater { pointer-events: auto; width: 44px; height: 44px; border-radius: 50%; border: 1px solid #475569; background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(8px); color: #94a3b8; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.4); transition: all 0.2s; font-size: 1.2rem; }
    .floater:hover { background: rgba(51, 65, 85, 1); color: white; transform: translateY(-2px); }
    .floater.active { color: #60a5fa; border-color: #60a5fa; background: rgba(2, 6, 23, 1); }

    /* PANEL CONTENT */
    .panel h2 { color: #60a5fa; margin: 1.5rem 0 1rem; font-size: 1.1rem; border-bottom: 1px solid #1e293b; padding-bottom: 0.5rem; }
    .control-group { margin-bottom: 1.2rem; }
    label { display: block; font-size: 0.9rem; color: #e5e7eb; margin-bottom: 0.4rem; }
    input, select, button { width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #1f2937; background: #020617; color: #e5e7eb; font: inherit; }
    input[type="range"] { padding: 0.3rem 0; accent-color: #60a5fa; }
    input[type="color"] { height: 44px; padding: 0.2rem; }
    button { background: #60a5fa; border: none; color: white; cursor: pointer; margin-top: 0.8rem; font-weight: 600; transition: background 0.2s; }
    button:hover { background: #3b82f6; }
    button:disabled { background: #475569; cursor: not-allowed; }
    #layersList { list-style: none; padding: 0; margin: 0 0 1rem; }
    .layer-item { display: flex; align-items: center; gap: 8px; padding: 10px; background: #0f172a; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; }
    .layer-item.active { background: #1e293b; border-color: #60a5fa; }
    .layer-item.group { background: #162032; }
    .layer-item.group > .layer-name::before { content: "üìÅ "; }
    .layer-visibility { font-size: 1.3rem; cursor: pointer; width: 24px; text-align: center; }
    .layer-name { flex: 1; font-size: 0.95rem; }
    .layer-delete { color: #ef4444; cursor: pointer; font-size: 1.2rem; width: 24px; text-align: center; }
    .layer-toggle { cursor: pointer; font-size: 1rem; width: 20px; }
    .hint { font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem; }
    .transform-controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 1rem; }
    .transform-input label { font-size: 0.75rem; color: #94a3b8; margin: 0; }
    .object-info { background: #0f172a; padding: 10px; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #1e293b; }
    .object-info h3 { margin: 0 0 8px; font-size: 0.95rem; color: #60a5fa; }

    /* FOOTER */
    .site-footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(2,6,23,0.95); border-top: 1px solid #1e293b; padding: 1rem; z-index: 1000; backdrop-filter: blur(10px); }
    .footer-inner { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1.5rem; font-size: 0.85rem; }
    .footer-nav a { color: #cbd5e1; text-decoration: none; }
    .footer-nav a:hover { color: #60a5fa; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <div class="header-left">
        <div class="logo"><a href="index.html">BowesProduct</a></div>
        <nav class="main-nav">
          <a href="index.html">Home</a>
          <a href="models.html">Models</a>
          <a href="retexture.html">Retexture</a>
          <a href="editor.html">Editor</a>
          <a href="3d.html" class="active">3D</a>
        </nav>
      </div>
      <div class="header-right">
        <img id="profilePic" alt="Profile">
        <div id="levelInfo">
          <div id="levelText"></div>
          <div id="xpOuter"><div id="xpBar"></div></div>
        </div>
        <button id="authBtn" class="login-btn">Login</button>
      </div>
    </div>
  </header>

  <div id="container">
    <div id="loader">Add objects or upload a model to start</div>
    <canvas id="canvas"></canvas>

    <div id="floatingControls">
      <div class="floater active" id="floaterSelect" title="Select Mode">üëÜ</div>
      <div class="floater" id="floaterMove" title="Move (G)">‚ú•</div>
      <div class="floater" id="floaterRotate" title="Rotate (R)">‚Üª</div>
      <div class="floater" id="floaterScale" title="Scale (S)">‚§¢</div>
    </div>

    <div class="panel visible" id="panel">
      <button id="panelToggle">‚Üê</button>

      <div style="padding:0.8rem;background:rgba(30,41,59,0.4);border-radius:8px;margin-bottom:1rem;font-size:0.85rem;line-height:1.4;border:1px solid #334155;">
        <strong style="color:#60a5fa">Controls:</strong><br>
        ‚Ä¢ Left click + drag: Rotate view<br>
        ‚Ä¢ Right click + drag: Pan<br>
        ‚Ä¢ Scroll: Zoom<br>
        ‚Ä¢ Click object: Select ‚Ä¢ Ctrl/Cmd + click: Multi-select<br>
        ‚Ä¢ G/R/S: Move/Rotate/Scale<br>
        ‚Ä¢ Delete: Delete ‚Ä¢ Ctrl+D: Duplicate ‚Ä¢ Ctrl+Z/Y: Undo/Redo
      </div>

      <h2>Add Objects</h2>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:1rem;">
        <button id="addBox">Box</button>
        <button id="addSphere">Sphere</button>
        <button id="addCylinder">Cylinder</button>
        <button id="addTorus">Torus</button>
        <button id="addCone">Cone</button>
        <button id="addPlane">Plane</button>
        <button id="addIcosahedron">Icosahedron</button>
        <button id="addDodecahedron">Dodecahedron</button>
        <button id="addOctahedron">Octahedron</button>
        <button id="addTetrahedron">Tetrahedron</button>
        <button id="addRing">Ring</button>
        <button id="addTube">Tube</button>
      </div>

      <h2>Group</h2>
      <button id="createGroup">Create Group from Selected</button>
      <button id="ungroup">Ungroup Selected</button>
      <div class="hint">Hold Ctrl/Cmd and click objects to multi-select</div>

      <h2>Model</h2>
      <div class="control-group">
        <label for="uploadModel">Upload GLB/GLTF</label>
        <input type="file" id="uploadModel" accept=".glb,.gltf">
        <div class="hint">Supports GLB/GLTF. Auto-centers model.</div>
      </div>

      <h2>Selected Object(s)</h2>
      <div id="selectedObjectInfo">
        <p style="color:#94a3b8;font-size:0.85rem;">No object selected</p>
      </div>

      <div id="transformControls" style="display:none;">
        <div class="control-group"><label>Position</label><div class="transform-controls">
          <div class="transform-input"><label>X</label><input type="number" id="posX" step="0.1"></div>
          <div class="transform-input"><label>Y</label><input type="number" id="posY" step="0.1"></div>
          <div class="transform-input"><label>Z</label><input type="number" id="posZ" step="0.1"></div>
        </div></div>
        <div class="control-group"><label>Rotation (degrees)</label><div class="transform-controls">
          <div class="transform-input"><label>X</label><input type="number" id="rotX" step="5"></div>
          <div class="transform-input"><label>Y</label><input type="number" id="rotY" step="5"></div>
          <div class="transform-input"><label>Z</label><input type="number" id="rotZ" step="5"></div>
        </div></div>
        <div class="control-group"><label>Scale</label><div class="transform-controls">
          <div class="transform-input"><label>X</label><input type="number" id="scaleX" step="0.1" min="0.01"></div>
          <div class="transform-input"><label>Y</label><input type="number" id="scaleY" step="0.1" min="0.01"></div>
          <div class="transform-input"><label>Z</label><input type="number" id="scaleZ" step="0.1" min="0.01"></div>
        </div></div>
        <button id="duplicateBtn">Duplicate (Ctrl+D)</button>
        <button id="deleteBtn" style="background:#ef4444;">Delete Selected</button>
      </div>

      <h2>Material (applies to single mesh)</h2>
      <div class="control-group">
        <label for="materialColor">Color</label>
        <input type="color" id="materialColor" value="#60a5fa">
      </div>
      <div class="control-group">
        <label for="metallicSlider">Metallic <span id="metallicVal">0.00</span></label>
        <input type="range" id="metallicSlider" min="0" max="1" step="0.01" value="0">
      </div>
      <div class="control-group">
        <label for="roughnessSlider">Roughness <span id="roughnessVal">0.50</span></label>
        <input type="range" id="roughnessSlider" min="0" max="1" step="0.01" value="0.5">
      </div>

      <h2>Layers / Objects</h2>
      <ol id="layersList"></ol>
      <div id="undoRedoGroup">
        <button id="undoBtn" disabled>Undo (Ctrl+Z)</button>
        <button id="redoBtn" disabled>Redo (Ctrl+Y)</button>
      </div>

      <h2>Lighting</h2>
      <div class="control-group">
        <label for="envPreset">Environment</label>
        <select id="envPreset">
          <option value="neutral">Neutral</option>
          <option value="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r182/examples/textures/equirect/royal_esplanade_1k.hdr">Royal Esplanade</option>
          <option value="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r182/examples/textures/equirect/spruit_sunrise_1k.hdr">Sunrise</option>
          <option value="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r182/examples/textures/equirect/moonless_golf_1k.hdr">Night</option>
        </select>
      </div>

      <h2>Export</h2>
      <button id="exportBtn">Export Scene as GLB</button>
      <div id="exportStatus" style="margin-top:0.5rem;font-size:0.8rem;color:#94a3b8;"></div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-inner">
      <nav class="footer-nav">
        <a href="about.html">About</a>
        <a href="privacy.html">Privacy</a>
        <a href="terms.html">Terms</a>
        <a href="license.html">License</a>
        <a href="refund.html">Refund</a>
        <a href="rewards.html">Rewards</a>
      </nav>
      <p>¬© 2026 BowesProduct</p>
    </div>
  </footer>

  <div id="mobilePanelToggle"><span>‚ñ≤ Controls</span></div>

<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
  import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
  import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';
  import { TransformControls } from 'three/addons/controls/TransformControls.js';

  const canvas = document.getElementById('canvas');
  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, preserveDrawingBuffer: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.0;
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x020617);

  const gridHelper = new THREE.GridHelper(20, 20, 0x1e293b, 0x0f172a);
  scene.add(gridHelper);

  scene.add(new THREE.AmbientLight(0xffffff, 0.4));
  const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
  dirLight.position.set(5, 10, 7);
  dirLight.castShadow = true;
  dirLight.shadow.mapSize.width = 2048;
  dirLight.shadow.mapSize.height = 2048;
  scene.add(dirLight);

  const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(5, 4, 5);

  const controls = new OrbitControls(camera, canvas);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;

  const transformControl = new TransformControls(camera, canvas);
  transformControl.addEventListener('dragging-changed', (event) => controls.enabled = !event.value);
  transformControl.addEventListener('change', updateTransformInputs);
  scene.add(transformControl);

  const pmremGenerator = new THREE.PMREMGenerator(renderer);
  pmremGenerator.compileEquirectangularShader();
  let currentEnvMap = null;

  function loadEnvironment(url) {
    if (url === 'neutral') {
      scene.environment = null;
      if (currentEnvMap) currentEnvMap.dispose();
      return;
    }
    new RGBELoader().load(url, (tex) => {
      const envMap = pmremGenerator.fromEquirectangular(tex).texture;
      scene.environment = envMap;
      tex.dispose();
      if (currentEnvMap) currentEnvMap.dispose();
      currentEnvMap = envMap;
    });
  }
  loadEnvironment('neutral');

  // Apple green selection glow
  const HIGHLIGHT_COLOR = new THREE.Color(0x22c55e); // Apple green

  function highlightObject(obj) {
    if (obj.isMesh) {
      if (!obj.userData.originalMaterial) {
        obj.userData.originalMaterial = obj.material.clone();
      }
      const highlightedMat = obj.material.clone();
      highlightedMat.emissive = HIGHLIGHT_COLOR;
      highlightedMat.emissiveIntensity = 0.4; // Strong glow
      obj.material = highlightedMat;
    }
  }

  function unhighlightObject(obj) {
    if (obj.isMesh && obj.userData.originalMaterial) {
      obj.material = obj.userData.originalMaterial;
      delete obj.userData.originalMaterial;
    }
  }

  // Root objects & selection
  const rootObjects = [];
  let selectedObjects = [];
  let objectCounter = 0;

  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();

  function selectObject(object, multi = false) {
    if (!multi) {
      selectedObjects.forEach(unhighlightObject);
      selectedObjects = [];
    }
    if (object && !selectedObjects.includes(object)) {
      selectedObjects.push(object);
      highlightObject(object);
    }
    updateSelectedObjectUI();
    updateFloaterActiveState();

    if (selectedObjects.length === 1) {
      transformControl.attach(selectedObjects[0]);
    } else {
      transformControl.detach();
    }
    updateLayersList();
  }

  canvas.addEventListener('pointerdown', (e) => {
    if (transformControl.dragging) return;
    const rect = canvas.getBoundingClientRect();
    mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const allMeshes = [];
    rootObjects.forEach(obj => obj.traverse(child => { if (child.isMesh) allMeshes.push(child); }));
    const intersects = raycaster.intersectObjects(allMeshes, false);
    if (intersects.length > 0) {
      selectObject(intersects[0].object, e.ctrlKey || e.metaKey);
    } else if (! (e.ctrlKey || e.metaKey)) {
      selectedObjects.forEach(unhighlightObject);
      selectedObjects = [];
      transformControl.detach();
      updateSelectedObjectUI();
      updateLayersList();
    }
  });

  // Floating transform mode buttons
  const modeMap = {
    floaterSelect: null,
    floaterMove: 'translate',
    floaterRotate: 'rotate',
    floaterScale: 'scale'
  };

  Object.keys(modeMap).forEach(id => {
    document.getElementById(id).addEventListener('click', () => {
      document.querySelectorAll('.floater').forEach(f => f.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      const mode = modeMap[id];
      if (mode) {
        transformControl.setMode(mode);
        if (selectedObjects.length === 1) transformControl.attach(selectedObjects[0]);
      } else {
        transformControl.detach();
      }
    });
  });

  function updateFloaterActiveState() {
    if (transformControl.mode === '') {
      document.querySelectorAll('.floater').forEach(f => f.classList.remove('active'));
      document.getElementById('floaterSelect').classList.add('active');
    }
  }

  // Primitive creation
  function createGeometryForName(name) {
    switch(name) {
      case 'Box': return new THREE.BoxGeometry(1, 1, 1);
      case 'Sphere': return new THREE.SphereGeometry(0.5, 32, 32);
      case 'Cylinder': return new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
      case 'Torus': return new THREE.TorusGeometry(0.5, 0.2, 16, 48);
      case 'Cone': return new THREE.ConeGeometry(0.5, 1, 32);
      case 'Plane': return new THREE.PlaneGeometry(1, 1);
      case 'Icosahedron': return new THREE.IcosahedronGeometry(0.6);
      case 'Dodecahedron': return new THREE.DodecahedronGeometry(0.6);
      case 'Octahedron': return new THREE.OctahedronGeometry(0.7);
      case 'Tetrahedron': return new THREE.TetrahedronGeometry(0.7);
      case 'Ring': return new THREE.RingGeometry(0.3, 0.6, 32);
      case 'Tube': return new THREE.TubeGeometry(new THREE.CatmullRomCurve3([
        new THREE.Vector3(-1, 0, 0),
        new THREE.Vector3(-0.5, 1, 0),
        new THREE.Vector3(0.5, -1, 0),
        new THREE.Vector3(1, 0, 0)
      ]), 64, 0.1, 8, false);
      default: return new THREE.BoxGeometry(1, 1, 1);
    }
  }

  function addPrimitive(name) {
    const geometry = createGeometryForName(name);
    const material = new THREE.MeshStandardMaterial({ color: 0x60a5fa, metalness: 0, roughness: 0.5 });
    const mesh = new THREE.Mesh(geometry, material);
    mesh.position.y = 0.5;
    mesh.castShadow = true;
    mesh.receiveShadow = true;
    mesh.userData.name = name;
    mesh.userData.geometryName = name;
    mesh.userData.id = objectCounter++;
    scene.add(mesh);
    rootObjects.push(mesh);
    selectObject(mesh);
    document.getElementById('loader').style.display = 'none';
    updateLayersList();
  }

  // Primitive buttons
  document.getElementById('addBox').onclick = () => addPrimitive('Box');
  document.getElementById('addSphere').onclick = () => addPrimitive('Sphere');
  document.getElementById('addCylinder').onclick = () => addPrimitive('Cylinder');
  document.getElementById('addTorus').onclick = () => addPrimitive('Torus');
  document.getElementById('addCone').onclick = () => addPrimitive('Cone');
  document.getElementById('addPlane').onclick = () => addPrimitive('Plane');
  document.getElementById('addIcosahedron').onclick = () => addPrimitive('Icosahedron');
  document.getElementById('addDodecahedron').onclick = () => addPrimitive('Dodecahedron');
  document.getElementById('addOctahedron').onclick = () => addPrimitive('Octahedron');
  document.getElementById('addTetrahedron').onclick = () => addPrimitive('Tetrahedron');
  document.getElementById('addRing').onclick = () => addPrimitive('Ring');
  document.getElementById('addTube').onclick = () => addPrimitive('Tube');

  // Model upload
  document.getElementById('uploadModel').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    new GLTFLoader().load(url, (gltf) => {
      const model = gltf.scene;
      model.traverse(child => {
        if (child.isMesh) {
          child.castShadow = true;
          child.receiveShadow = true;
        }
      });
      const box = new THREE.Box3().setFromObject(model);
      const center = box.getCenter(new THREE.Vector3());
      model.position.sub(center);
      model.position.y -= box.min.y;
      scene.add(model);
      rootObjects.push(model);
      document.getElementById('loader').style.display = 'none';
      updateLayersList();
    });
  });

  // Environment preset
  document.getElementById('envPreset').addEventListener('change', (e) => loadEnvironment(e.target.value));

  // Export
  const exportStatus = document.getElementById('exportStatus');
  document.getElementById('exportBtn').onclick = () => {
    if (rootObjects.length === 0) {
      exportStatus.textContent = 'No objects to export';
      exportStatus.style.color = '#ef4444';
      return;
    }
    exportStatus.textContent = 'Exporting...';
    exportStatus.style.color = '#60a5fa';
    const exporter = new GLTFExporter();
    exporter.parse(scene, (result) => {
      const blob = new Blob([result], { type: 'application/octet-stream' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'scene.glb';
      link.click();
      exportStatus.textContent = 'Exported!';
      exportStatus.style.color = '#4ade80';
    }, { binary: true });
  };

  // Panel toggle
  const panel = document.getElementById('panel');
  const panelToggle = document.getElementById('panelToggle');
  const mobilePanelToggle = document.getElementById('mobilePanelToggle');
  let panelVisible = true;

  function togglePanel() {
    panelVisible = !panelVisible;
    panel.classList.toggle('hidden', !panelVisible);
    panel.classList.toggle('visible', panelVisible);
    panelToggle.textContent = panelVisible ? '‚Üê' : '‚Üí';
    const span = mobilePanelToggle.querySelector('span');
    if (span) span.textContent = panelVisible ? '‚ñº Hide Controls' : '‚ñ≤ Controls';
  }

  panelToggle.onclick = togglePanel;
  mobilePanelToggle.onclick = togglePanel;

  // Resize
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // Animation loop
  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();
</script>
</body>
</html>

