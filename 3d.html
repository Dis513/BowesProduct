<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Modeler Pro ‚Äì BowesProduct</title>
  <script async src="https://unpkg.com/es-module-shims@1.8.2/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
    }
  }
  </script>
  <style>
  *, *::before, *::after { box-sizing: border-box; }
  html, body { margin: 0; height: 100%; background: #020617; color: white; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; -webkit-font-smoothing: antialiased; }
  .site-header {
    position: sticky; top: 0; z-index: 1000; background: rgba(2,6,23,0.95); border-bottom: 1px solid #1e293b; backdrop-filter: blur(10px);
  }
  .header-inner { max-width: 1200px; margin: 0 auto; padding: 0.6rem 1rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; }
  .header-left { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
  .logo a { font-size: 1.3rem; font-weight: 700; color: white; text-decoration: none; white-space: nowrap; }
  .main-nav { display: flex; gap: 1rem; flex-wrap: wrap; }
  .main-nav a { color: #e5e7eb; text-decoration: none; font-size: 0.9rem; white-space: nowrap; }
  .main-nav a:hover, .main-nav a.active { color: #60a5fa; }
  .header-right { display: flex; align-items: center; gap: 0.8rem; min-height: 44px; flex-wrap: wrap; }
  #profilePic { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #60a5fa; object-fit: cover; display: none; }
  .login-btn { padding: 0.45rem 1.1rem; border-radius: 999px; border: 1.5px solid #60a5fa; background: transparent; color: #60a5fa; font-size: 0.95rem; cursor: pointer; }
  #levelInfo { display: none; font-size: 0.8rem; color: #cbd5e1; }
  #levelText { white-space: nowrap; font-size: 0.75rem; }
  #xpOuter { width: 100px; height: 5px; background: #1e293b; border-radius: 3px; margin-top: 4px; }
  #xpBar { height: 100%; width: 0%; background: #60a5fa; border-radius: 3px; transition: width 0.35s ease; }
  @media (max-width: 900px) {
    .header-inner { padding: 0.5rem; }
    .header-left { width: 100%; justify-content: space-between; }
    .main-nav { gap: 0.8rem; order: 3; width: 100%; }
    .main-nav a { font-size: 0.85rem; }
    .header-right { width: 100%; justify-content: space-between; }
    #levelInfo { flex: 1; }
    #xpOuter { width: 100%; }
  }

  /* Top Menu Bar */
  .app-menu-bar {
    position: sticky; top: 70px; z-index: 999; background: rgba(15,23,42,0.98); border-bottom: 1px solid #1e293b; padding: 0 1rem; display: flex; height: 36px; align-items: center; backdrop-filter: blur(10px); overflow-x: auto; white-space: nowrap; flex-wrap: nowrap;
  }
  .menu-item {
    padding: 0 1rem; cursor: pointer; height: 100%; display: flex; align-items: center; font-size: 0.85rem;
  }
  .menu-item:hover { background: rgba(96,165,250,0.1); color: #60a5fa; }
  .dropdown {
    position: absolute; top: 100%; left: 0; background: #0f172a; border: 1px solid #1e293b; min-width: 220px; display: none; flex-direction: column; box-shadow: 0 8px 25px rgba(0,0,0,0.6); border-radius: 8px; overflow: hidden; z-index: 10000;
  }
  .dropdown div { padding: 0.6rem 1rem; cursor: pointer; white-space: nowrap; }
  .dropdown div:hover { background: #1e293b; }
  .menu-item:hover .dropdown { display: flex; }

  #container { position: relative; width: 100%; height: calc(100vh - 106px); }
  #canvas { display: block; width: 100%; height: 100%; touch-action: none; outline: none; }

  .panel {
    position: absolute; top: 20px; right: 20px; width: 380px; max-height: calc(100vh - 160px); background: rgba(2,6,23,0.95); border: 1px solid #1e293b; border-radius: 12px; padding: 1.5rem; overflow-y: auto; z-index: 20; backdrop-filter: blur(10px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); transition: transform 0.3s ease;
  }
  .panel.hidden { transform: translateX(420px); }
  #panelToggle {
    position: absolute; left: -60px; top: 50%; transform: translateY(-50%); width: 60px; height: 110px; background: rgba(2,6,23,0.98); border: 1px solid #1e293b; border-right: none; border-radius: 20px 0 0 20px; color: #60a5fa; font-size: 2.4rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 21; backdrop-filter: blur(12px);
  }
  #panelToggle:hover { background: rgba(30,41,59,0.98); color: white; }

  #floatingControls {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 1150; pointer-events: none;
  }
  .floater {
    pointer-events: auto; width: 56px; height: 56px; border-radius: 50%; background: rgba(30,41,59,0.95); border: 1px solid #475569; color: #94a3b8; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.6rem; box-shadow: 0 6px 20px rgba(0,0,0,0.5); transition: all 0.2s;
  }
  .floater:hover { background: rgba(51,65,85,1); color: white; transform: translateY(-4px); }
  .floater.active { color: #60a5fa; border-color: #60a5fa; background: rgba(2,6,23,1); }

  .tool-notification {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0.8); background: linear-gradient(135deg,rgba(96,165,250,0.95),rgba(59,130,246,0.95)); color: white; padding: 1.5rem 3rem; border-radius: 20px; font-size: 1.8rem; font-weight: 700; z-index: 10000; pointer-events: none; opacity: 0; box-shadow: 0 20px 60px rgba(96,165,250,0.4); backdrop-filter: blur(10px); transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  }
  .tool-notification.show { opacity: 1; transform: translate(-50%,-50%) scale(1); }

  button { background: #60a5fa; border: none; color: white; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 0.5rem; width: 100%; }
  button:hover { background: #3b82f6; }
  input[type="color"] { height: 44px; width: 100%; }
  input[type="range"] { accent-color: #60a5fa; }

  .hint { font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem; }
  #layersList { list-style: none; padding: 0; margin: 1rem 0; }
  .layer-item {
    display: flex; align-items: center; gap: 8px; padding: 10px; background: #0f172a; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent;
  }
  .layer-item.active { background: #1e293b; border-color: #60a5fa; }
  .layer-item.group { background: #162032; }
  .layer-item.group > .layer-name::before { content: "üìÅ "; }
  .layer-visibility { font-size: 1.3rem; cursor: pointer; }
  .layer-name { flex: 1; font-size: 0.95rem; }
  .layer-delete { color: #ef4444; cursor: pointer; font-size: 1.2rem; }

  @media (max-width: 900px) {
    .panel { top: auto; bottom: 0; left: 0; right: 0; width: 100%; height: 80vh; border-radius: 20px 20px 0 0; max-height: none; transform: translateY(calc(100% - 60px)); }
    .panel.visible { transform: translateY(0); }
    #panelToggle { display: none; }
    #floatingControls { bottom: 90px; }
    .app-menu-bar { padding: 0 0.5rem; }
  }
  </style>
  <script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
<header class="site-header">
  <div class="header-inner">
    <div class="header-left">
      <div class="logo"><a href="index.html">BowesProduct</a></div>
      <nav class="main-nav">
        <a href="index.html">Home</a>
        <a href="models.html">Models</a>
        <a href="retexture.html">Retexture</a>
        <a href="editor.html">Editor</a>
        <a href="3d.html" class="active">3D</a>
      </nav>
    </div>
    <div class="header-right">
      <img id="profilePic" alt="Profile">
      <div id="levelInfo">
        <div id="levelText"></div>
        <div id="xpOuter"><div id="xpBar"></div></div>
      </div>
      <button id="authBtn" class="login-btn">Login</button>
    </div>
  </div>
</header>

<div class="app-menu-bar">
  <div class="menu-item">File
    <div class="dropdown">
      <div onclick="document.getElementById('uploadModel').click()">Import Model (GLB/GLTF/OBJ/FBX)</div>
      <div onclick="exportModel()">Export Scene as GLB</div>
    </div>
  </div>
  <div class="menu-item">Edit
    <div class="dropdown">
      <div onclick="undo()">Undo (Ctrl+Z)</div>
      <div onclick="redo()">Redo (Ctrl+Y)</div>
      <hr>
      <div onclick="duplicateSelected()">Duplicate (Ctrl+D)</div>
      <div onclick="deleteSelected()">Delete</div>
    </div>
  </div>
  <div class="menu-item">Object
    <div class="dropdown">
      <div onclick="setTransformMode('translate')">Move (G)</div>
      <div onclick="setTransformMode('rotate')">Rotate (R)</div>
      <div onclick="setTransformMode('scale')">Scale (S)</div>
      <hr>
      <div onclick="createGroup()">Create Group from Selected</div>
      <div onclick="ungroup()">Ungroup Selected</div>
    </div>
  </div>
  <div class="menu-item">Add
    <div class="dropdown">
      <div onclick="addPrimitive('Box')">Box</div>
      <div onclick="addPrimitive('Sphere')">Sphere</div>
      <div onclick="addPrimitive('Cylinder')">Cylinder</div>
      <div onclick="addPrimitive('Torus')">Torus</div>
      <div onclick="addPrimitive('Cone')">Cone</div>
      <div onclick="addPrimitive('Plane')">Plane</div>
      <div onclick="addPrimitive('Icosahedron')">Icosahedron</div>
      <div onclick="addPrimitive('Dodecahedron')">Dodecahedron</div>
      <div onclick="addPrimitive('Octahedron')">Octahedron</div>
      <div onclick="addPrimitive('Tetrahedron')">Tetrahedron</div>
      <div onclick="addPrimitive('Ring')">Ring</div>
      <div onclick="addPrimitive('Tube')">Tube</div>
    </div>
  </div>
</div>

<div id="container">
  <div id="loader">Add objects or upload a model to start</div>
  <canvas id="canvas"></canvas>

  <div id="floatingControls">
    <div class="floater active" id="floaterSelect" title="Select">üëÜ</div>
    <div class="floater" id="floaterMove" title="Move (G)">‚ú•</div>
    <div class="floater" id="floaterRotate" title="Rotate (R)">‚Üª</div>
    <div class="floater" id="floaterScale" title="Scale (S)">‚§¢</div>
  </div>

  <div class="tool-notification" id="toolNotification"></div>

  <input type="file" id="uploadModel" accept=".glb,.gltf,.obj,.fbx" style="display:none;">

  <div class="panel visible" id="panel">
    <button id="panelToggle">‚Üê</button>

    <div style="padding:0.8rem;background:rgba(30,41,59,0.4);border-radius:8px;margin-bottom:1rem;font-size:0.85rem;line-height:1.4;border:1px solid #334155;">
      <strong style="color:#60a5fa">Controls:</strong><br>
      ‚Ä¢ Left drag: Orbit view ‚Ä¢ Right drag: Pan ‚Ä¢ Scroll: Zoom<br>
      ‚Ä¢ Click: Select ‚Ä¢ Ctrl+Click: Multi-select<br>
      ‚Ä¢ G / R / S: Move / Rotate / Scale<br>
      ‚Ä¢ Ctrl+Z/Y: Undo/Redo ‚Ä¢ Ctrl+D: Duplicate ‚Ä¢ Del: Delete
    </div>

    <h2>Add Primitives</h2>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:1rem;">
      <button onclick="addPrimitive('Box')">Box</button>
      <button onclick="addPrimitive('Sphere')">Sphere</button>
      <button onclick="addPrimitive('Cylinder')">Cylinder</button>
      <button onclick="addPrimitive('Torus')">Torus</button>
      <button onclick="addPrimitive('Cone')">Cone</button>
      <button onclick="addPrimitive('Plane')">Plane</button>
      <button onclick="addPrimitive('Icosahedron')">Icosahedron</button>
      <button onclick="addPrimitive('Dodecahedron')">Dodecahedron</button>
      <button onclick="addPrimitive('Octahedron')">Octahedron</button>
      <button onclick="addPrimitive('Tetrahedron')">Tetrahedron</button>
      <button onclick="addPrimitive('Ring')">Ring</button>
      <button onclick="addPrimitive('Tube')">Tube</button>
    </div>

    <h2>Group</h2>
    <button onclick="createGroup()">Create Group from Selected</button>
    <button onclick="ungroup()">Ungroup Selected</button>
    <div class="hint">Hold Ctrl/Cmd to multi-select</div>

    <h2>Model Import</h2>
    <button onclick="document.getElementById('uploadModel').click()">Upload GLB/GLTF/OBJ/FBX</button>
    <div class="hint">Auto-centers and scales imported models</div>

    <h2>Selected Object(s)</h2>
    <div id="selectedObjectInfo"><p style="color:#94a3b8;font-size:0.85rem;">No object selected</p></div>

    <div id="transformControls" style="display:none;">
      <h3>Position</h3>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
        <input type="number" id="posX" step="0.1" placeholder="X">
        <input type="number" id="posY" step="0.1" placeholder="Y">
        <input type="number" id="posZ" step="0.1" placeholder="Z">
      </div>
      <h3>Rotation (degrees)</h3>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
        <input type="number" id="rotX" step="5">
        <input type="number" id="rotY" step="5">
        <input type="number" id="rotZ" step="5">
      </div>
      <h3>Scale</h3>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
        <input type="number" id="scaleX" step="0.1" min="0.01">
        <input type="number" id="scaleY" step="0.1" min="0.01">
        <input type="number" id="scaleZ" step="0.1" min="0.01">
      </div>
      <button onclick="duplicateSelected()">Duplicate (Ctrl+D)</button>
      <button onclick="deleteSelected()" style="background:#ef4444;">Delete Selected</button>
    </div>

    <h2>Material (single mesh)</h2>
    <label>Color</label>
    <input type="color" id="materialColor" value="#60a5fa">
    <label>Metallic <span id="metallicVal">0.00</span></label>
    <input type="range" id="metallicSlider" min="0" max="1" step="0.01" value="0">
    <label>Roughness <span id="roughnessVal">0.50</span></label>
    <input type="range" id="roughnessSlider" min="0" max="1" step="0.01" value="0.5">

    <h2>Lighting & Environment</h2>
    <label>Environment Preset</label>
    <select id="envPreset">
      <option value="neutral">Neutral</option>
      <option value="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r182/examples/textures/equirect/royal_esplanade_1k.hdr">Royal Esplanade</option>
      <option value="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r182/examples/textures/equirect/spruit_sunrise_1k.hdr">Sunrise</option>
      <option value="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r182/examples/textures/equirect/moonless_golf_1k.hdr">Night</option>
    </select>

    <h2>Objects / Layers</h2>
    <ol id="layersList"></ol>

    <h2>Export</h2>
    <button onclick="exportModel()">Export Scene as GLB</button>
    <div id="exportStatus" style="margin-top:0.5rem;font-size:0.8rem;color:#94a3b8;"></div>

    <h2>Undo / Redo</h2>
    <button onclick="undo()" id="undoBtn">Undo (Ctrl+Z)</button>
    <button onclick="redo()" id="redoBtn">Redo (Ctrl+Y)</button>
  </div>
</div>

<footer class="site-footer">
  <div style="max-width:1200px;margin:0 auto;padding:1rem;text-align:center;font-size:0.85rem;">
    ¬© 2026 BowesProduct
  </div>
</footer>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';

const canvas = document.getElementById('canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, preserveDrawingBuffer: true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0;
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x020617);
const grid = new THREE.GridHelper(20, 20, 0x1e293b, 0x0f172a);
scene.add(grid);
scene.add(new THREE.AmbientLight(0xffffff, 0.4));
const dirLight = new THREE.DirectionalLight(0xffffff, 1);
dirLight.position.set(5,10,7);
dirLight.castShadow = true;
dirLight.shadow.mapSize.width = dirLight.shadow.mapSize.height = 2048;
scene.add(dirLight);

const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(5, 4, 5);

const controls = new OrbitControls(camera, canvas);
controls.enableDamping = true;
controls.dampingFactor = 0.05;

const transformControl = new TransformControls(camera, canvas);
transformControl.addEventListener('dragging-changed', event => controls.enabled = !event.value);
transformControl.addEventListener('change', updateTransformInputs);
scene.add(transformControl);

const pmremGenerator = new THREE.PMREMGenerator(renderer);
pmremGenerator.compileEquirectangularShader();
let currentEnvMap = null;

function loadEnvironment(url) {
  if (url === 'neutral') {
    scene.environment = null;
    if (currentEnvMap) currentEnvMap.dispose();
    return;
  }
  new RGBELoader().load(url, tex => {
    const envMap = pmremGenerator.fromEquirectangular(tex).texture;
    scene.environment = envMap;
    if (currentEnvMap) currentEnvMap.dispose();
    currentEnvMap = envMap;
    tex.dispose();
  });
}
loadEnvironment('neutral');
document.getElementById('envPreset').addEventListener('change', e => loadEnvironment(e.target.value));

const rootObjects = [];
let selectedObjects = [];
let objectCounter = 0;

const undoStack = [];
const redoStack = [];
const MAX_UNDO = 50;

function saveState() {
  const state = rootObjects.map(obj => serializeObject(obj));
  undoStack.push(state);
  if (undoStack.length > MAX_UNDO) undoStack.shift();
  redoStack.length = 0;
}

function serializeObject(obj) {
  if (obj.userData.isGroup) {
    return {
      type: 'group',
      name: obj.userData.name,
      visible: obj.visible,
      position: obj.position.toArray(),
      rotation: obj.rotation.toArray(),
      scale: obj.scale.toArray(),
      children: obj.children.map(child => serializeObject(child))
    };
  } else {
    return {
      type: 'mesh',
      name: obj.userData.name,
      geometry: obj.userData.geometryName || 'imported',
      visible: obj.visible,
      position: obj.position.toArray(),
      rotation: obj.rotation.toArray(),
      scale: obj.scale.toArray(),
      color: obj.material.color.getHex(),
      metallic: obj.material.metalness,
      roughness: obj.material.roughness
    };
  }
}

function deserializeObject(data) {
  let obj;
  if (data.type === 'group') {
    obj = new THREE.Group();
    obj.userData.isGroup = true;
    data.children.forEach(childData => obj.add(deserializeObject(childData)));
  } else {
    const geometry = data.geometry !== 'imported' ? createGeometryForName(data.geometry) : new THREE.BoxGeometry(1,1,1);
    const material = new THREE.MeshStandardMaterial({
      color: data.color,
      metalness: data.metallic,
      roughness: data.roughness
    });
    obj = new THREE.Mesh(geometry, material);
    obj.castShadow = obj.receiveShadow = true;
  }
  obj.userData.name = data.name;
  obj.userData.id = objectCounter++;
  obj.visible = data.visible;
  obj.position.fromArray(data.position);
  obj.rotation.fromArray(data.rotation);
  obj.scale.fromArray(data.scale);
  return obj;
}

function restoreState(state) {
  rootObjects.forEach(o => scene.remove(o));
  rootObjects.length = 0;
  state.forEach(data => {
    const obj = deserializeObject(data);
    scene.add(obj);
    rootObjects.push(obj);
  });
  selectedObjects = [];
  updateSelectedObjectUI();
  updateLayersList();
}

function undo() {
  if (undoStack.length <= 1) return;
  redoStack.push(undoStack.pop());
  restoreState(undoStack[undoStack.length - 1]);
}

function redo() {
  if (redoStack.length === 0) return;
  undoStack.push(redoStack.pop());
  restoreState(undoStack[undoStack.length - 1]);
}

function createGeometryForName(name) {
  switch(name) {
    case 'Box': return new THREE.BoxGeometry(1,1,1);
    case 'Sphere': return new THREE.SphereGeometry(0.5,32,32);
    case 'Cylinder': return new THREE.CylinderGeometry(0.5,0.5,1,32);
    case 'Torus': return new THREE.TorusGeometry(0.5,0.2,16,48);
    case 'Cone': return new THREE.ConeGeometry(0.5,1,32);
    case 'Plane': return new THREE.PlaneGeometry(1,1);
    case 'Icosahedron': return new THREE.IcosahedronGeometry(0.6);
    case 'Dodecahedron': return new THREE.DodecahedronGeometry(0.6);
    case 'Octahedron': return new THREE.OctahedronGeometry(0.7);
    case 'Tetrahedron': return new THREE.TetrahedronGeometry(0.7);
    case 'Ring': return new THREE.RingGeometry(0.3,0.6,32);
    case 'Tube': return new THREE.TubeGeometry(new THREE.CatmullRomCurve3([new THREE.Vector3(-1,0,0),new THREE.Vector3(-0.5,1,0),new THREE.Vector3(0.5,-1,0),new THREE.Vector3(1,0,0)]),64,0.1,8,false);
    default: return new THREE.BoxGeometry(1,1,1);
  }
}

function addPrimitive(name) {
  saveState();
  const geometry = createGeometryForName(name);
  const material = new THREE.MeshStandardMaterial({ color: 0x60a5fa, metalness: 0, roughness: 0.5 });
  const mesh = new THREE.Mesh(geometry, material);
  mesh.position.y = 0.5;
  mesh.castShadow = true;
  mesh.receiveShadow = true;
  mesh.userData.name = name;
  mesh.userData.geometryName = name;
  mesh.userData.id = objectCounter++;
  scene.add(mesh);
  rootObjects.push(mesh);
  selectObject(mesh);
  updateLayersList();
  document.getElementById('loader').style.display = 'none';
  showNotification(`Added ${name}`);
}

const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

function selectObject(object, multi = false) {
  if (!multi) selectedObjects = [];
  if (object) {
    if (!selectedObjects.includes(object)) selectedObjects.push(object);
  }
  updateSelectedObjectUI();
  updateLayersList();
  if (selectedObjects.length === 1) {
    transformControl.attach(selectedObjects[0]);
  } else {
    transformControl.detach();
  }
}

canvas.addEventListener('pointerdown', e => {
  if (transformControl.dragging) return;
  if (e.button !== 0) return;
  const rect = canvas.getBoundingClientRect();
  mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const allMeshes = [];
  rootObjects.forEach(obj => obj.traverse(child => { if (child.isMesh) allMeshes.push(child); }));
  const intersects = raycaster.intersectObjects(allMeshes, false);
  if (intersects.length > 0) {
    selectObject(intersects[0].object, e.ctrlKey || e.metaKey);
  } else if (!(e.ctrlKey || e.metaKey)) {
    selectedObjects = [];
    transformControl.detach();
    updateSelectedObjectUI();
    updateLayersList();
  }
});

function updateSelectedObjectUI() {
  const info = document.getElementById('selectedObjectInfo');
  const trans = document.getElementById('transformControls');
  if (selectedObjects.length === 0) {
    info.innerHTML = '<p style="color:#94a3b8;font-size:0.85rem;">No object selected</p>';
    trans.style.display = 'none';
    return;
  }
  info.innerHTML = `<p style="color:#e5e7eb;">${selectedObjects.length} object${selectedObjects.length > 1 ? 's' : ''} selected</p>`;
  trans.style.display = selectedObjects.length === 1 ? 'block' : 'none';
  if (selectedObjects.length === 1 && selectedObjects[0].isMesh) {
    const mat = selectedObjects[0].material;
    document.getElementById('materialColor').value = '#' + mat.color.getHexString();
    document.getElementById('metallicSlider').value = mat.metalness;
    document.getElementById('roughnessSlider').value = mat.roughness;
    document.getElementById('metallicVal').textContent = mat.metalness.toFixed(2);
    document.getElementById('roughnessVal').textContent = mat.roughness.toFixed(2);
  }
  updateTransformInputs();
}

function updateTransformInputs() {
  if (selectedObjects.length !== 1) return;
  const obj = selectedObjects[0];
  document.getElementById('posX').value = obj.position.x.toFixed(2);
  document.getElementById('posY').value = obj.position.y.toFixed(2);
  document.getElementById('posZ').value = obj.position.z.toFixed(2);
  document.getElementById('rotX').value = THREE.MathUtils.radToDeg(obj.rotation.x).toFixed(1);
  document.getElementById('rotY').value = THREE.MathUtils.radToDeg(obj.rotation.y).toFixed(1);
  document.getElementById('rotZ').value = THREE.MathUtils.radToDeg(obj.rotation.z).toFixed(1);
  document.getElementById('scaleX').value = obj.scale.x.toFixed(2);
  document.getElementById('scaleY').value = obj.scale.y.toFixed(2);
  document.getElementById('scaleZ').value = obj.scale.z.toFixed(2);
}

['posX','posY','posZ','rotX','rotY','rotZ','scaleX','scaleY','scaleZ'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => {
    if (selectedObjects.length === 0) return;
    saveState();
    const obj = selectedObjects[0];
    obj.position.set(parseFloat(document.getElementById('posX').value)||0, parseFloat(document.getElementById('posY').value)||0, parseFloat(document.getElementById('posZ').value)||0);
    obj.rotation.set(THREE.MathUtils.degToRad(parseFloat(document.getElementById('rotX').value)||0), THREE.MathUtils.degToRad(parseFloat(document.getElementById('rotY').value)||0), THREE.MathUtils.degToRad(parseFloat(document.getElementById('rotZ').value)||0));
    obj.scale.set(parseFloat(document.getElementById('scaleX').value)||1, parseFloat(document.getElementById('scaleY').value)||1, parseFloat(document.getElementById('scaleZ').value)||1);
  });
});

document.getElementById('materialColor').addEventListener('input', e => {
  if (selectedObjects.length === 1 && selectedObjects[0].isMesh) selectedObjects[0].material.color.set(e.target.value);
});
document.getElementById('metallicSlider').addEventListener('input', e => {
  const v = parseFloat(e.target.value);
  document.getElementById('metallicVal').textContent = v.toFixed(2);
  if (selectedObjects.length === 1 && selectedObjects[0].isMesh) selectedObjects[0].material.metalness = v;
});
document.getElementById('roughnessSlider').addEventListener('input', e => {
  const v = parseFloat(e.target.value);
  document.getElementById('roughnessVal').textContent = v.toFixed(2);
  if (selectedObjects.length === 1 && selectedObjects[0].isMesh) selectedObjects[0].material.roughness = v;
});

function duplicateSelected() {
  if (selectedObjects.length === 0) return;
  saveState();
  const clones = [];
  selectedObjects.forEach(obj => {
    const clone = obj.clone(true);
    if (obj.isMesh) clone.material = obj.material.clone();
    clone.position.x += 1;
    clone.userData.id = objectCounter++;
    scene.add(clone);
    rootObjects.push(clone);
    clones.push(clone);
  });
  selectedObjects = clones;
  updateLayersList();
  updateSelectedObjectUI();
}

function deleteSelected() {
  if (selectedObjects.length === 0) return;
  saveState();
  selectedObjects.forEach(obj => {
    if (obj.parent && obj.parent.userData.isGroup) obj.parent.remove(obj);
    else scene.remove(obj);
    const idx = rootObjects.indexOf(obj);
    if (idx > -1) rootObjects.splice(idx, 1);
  });
  selectedObjects = [];
  transformControl.detach();
  updateLayersList();
  updateSelectedObjectUI();
}

function createGroup() {
  if (selectedObjects.length < 2) return;
  saveState();
  const group = new THREE.Group();
  group.userData.isGroup = true;
  group.userData.name = `Group ${rootObjects.filter(o => o.userData.isGroup).length + 1}`;
  group.userData.id = objectCounter++;
  selectedObjects.forEach(obj => {
    obj.parent.remove(obj);
    group.add(obj);
  });
  scene.add(group);
  rootObjects.push(group);
  selectedObjects = [group];
  updateLayersList();
  updateSelectedObjectUI();
}

function ungroup() {
  const groups = selectedObjects.filter(o => o.userData.isGroup);
  if (groups.length === 0) return;
  saveState();
  groups.forEach(group => {
    const children = [...group.children];
    children.forEach(child => {
      group.remove(child);
      scene.add(child);
      rootObjects.push(child);
    });
    scene.remove(group);
    const idx = rootObjects.indexOf(group);
    if (idx > -1) rootObjects.splice(idx, 1);
  });
  selectedObjects = [];
  updateLayersList();
  updateSelectedObjectUI();
}

function updateLayersList() {
  const list = document.getElementById('layersList');
  list.innerHTML = '';
  rootObjects.slice().reverse().forEach(obj => addLayerItem(obj, list));
}

function addLayerItem(obj, parentList) {
  const li = document.createElement('li');
  li.className = 'layer-item' + (selectedObjects.includes(obj) ? ' active' : '') + (obj.userData.isGroup ? ' group' : '');
  li.innerHTML = `
    <span class="layer-visibility">${obj.visible ? 'üëÅ' : 'üö´'}</span>
    <span class="layer-name">${obj.userData.name || 'Object'}</span>
    <span class="layer-delete">√ó</span>
  `;
  parentList.appendChild(li);
  li.querySelector('.layer-visibility').onclick = e => {
    e.stopPropagation();
    obj.visible = !obj.visible;
    li.querySelector('.layer-visibility').textContent = obj.visible ? 'üëÅ' : 'üö´';
    obj.traverse(child => child.visible = obj.visible);
    saveState();
  };
  li.querySelector('.layer-delete').onclick = e => {
    e.stopPropagation();
    saveState();
    scene.remove(obj);
    const idx = rootObjects.indexOf(obj);
    if (idx > -1) rootObjects.splice(idx, 1);
    selectedObjects = selectedObjects.filter(o => o !== obj);
    updateLayersList();
    updateSelectedObjectUI();
  };
  li.onclick = e => {
    if (e.target.classList.contains('layer-delete') || e.target.classList.contains('layer-visibility')) return;
    selectObject(obj, e.ctrlKey || e.metaKey);
  };
  if (obj.userData.isGroup) {
    const childList = document.createElement('ol');
    childList.style.marginLeft = '20px';
    childList.style.display = 'block';
    obj.children.forEach(child => addLayerItem(child, childList));
    li.appendChild(childList);
  }
}

function loadModel(object) {
  saveState();
  const box = new THREE.Box3().setFromObject(object);
  const size = box.getSize(new THREE.Vector3());
  const center = box.getCenter(new THREE.Vector3());
  const maxDim = Math.max(size.x, size.y, size.z);
  const scale = 5 / maxDim;
  object.scale.multiplyScalar(scale);
  object.position.sub(center.multiplyScalar(scale));
  object.position.y -= size.y * scale / 2;
  object.traverse(child => {
    if (child.isMesh) {
      child.castShadow = true;
      child.receiveShadow = true;
      child.userData.name = child.name || 'Imported Mesh';
      child.userData.id = objectCounter++;
    }
  });
  scene.add(object);
  rootObjects.push(object);
  document.getElementById('loader').style.display = 'none';
  updateLayersList();
}

document.getElementById('uploadModel').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  const name = file.name.toLowerCase();
  if (name.endsWith('.glb') || name.endsWith('.gltf')) {
    new GLTFLoader().load(url, gltf => loadModel(gltf.scene));
  } else if (name.endsWith('.obj')) {
    new OBJLoader().load(url, obj => loadModel(obj));
  } else if (name.endsWith('.fbx')) {
    new FBXLoader().load(url, fbx => loadModel(fbx));
  }
});

function exportModel() {
  if (rootObjects.length === 0) {
    document.getElementById('exportStatus').textContent = 'Nothing to export';
    return;
  }
  document.getElementById('exportStatus').textContent = 'Exporting...';
  const exporter = new GLTFExporter();
  exporter.parse(scene, result => {
    const blob = new Blob([result], { type: 'application/octet-stream' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'scene.glb';
    link.click();
    document.getElementById('exportStatus').textContent = 'Exported successfully!';
    document.getElementById('exportStatus').style.color = '#4ade80';
  }, { binary: true });
}

function setTransformMode(mode) {
  transformControl.setMode(mode);
  document.querySelectorAll('.floater').forEach(f => f.classList.remove('active'));
  if (mode === 'translate') document.getElementById('floaterMove').classList.add('active');
  else if (mode === 'rotate') document.getElementById('floaterRotate').classList.add('active');
  else if (mode === 'scale') document.getElementById('floaterScale').classList.add('active');
  showNotification(mode.charAt(0).toUpperCase() + mode.slice(1));
}

document.getElementById('floaterMove').onclick = () => setTransformMode('translate');
document.getElementById('floaterRotate').onclick = () => setTransformMode('rotate');
document.getElementById('floaterScale').onclick = () => setTransformMode('scale');

function showNotification(text) {
  const n = document.getElementById('toolNotification');
  n.textContent = text;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 1500);
}

const panel = document.getElementById('panel');
const panelToggle = document.getElementById('panelToggle');
let panelVisible = true;
function togglePanel() {
  panelVisible = !panelVisible;
  panel.classList.toggle('hidden', !panelVisible);
  panelToggle.textContent = panelVisible ? '‚Üê' : '‚Üí';
}
panelToggle.onclick = togglePanel;

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

window.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
  if (selectedObjects.length === 0) return;
  if (e.key.toLowerCase() === 'g') setTransformMode('translate');
  if (e.key.toLowerCase() === 'r') setTransformMode('rotate');
  if (e.key.toLowerCase() === 's') setTransformMode('scale');
});

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();

saveState();
addPrimitive('Box');
</script>
</body>
</html>
