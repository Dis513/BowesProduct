<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Modeler Pro ‚Äì BowesProduct</title>
  <script async src="https://unpkg.com/es-module-shims@1.8.2/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
    }
  }
  </script>
  <style>
  *, *::before, *::after { box-sizing: border-box; }
  html, body { margin: 0; height: 100%; background: #020617; color: white; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; -webkit-font-smoothing: antialiased; }
  .site-header {
    position: sticky; top: 0; z-index: 1000; background: rgba(2,6,23,0.95); border-bottom: 1px solid #1e293b; backdrop-filter: blur(10px);
  }
  .header-inner { max-width: 1200px; margin: 0 auto; padding: 0.6rem 1rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; }
  .header-left { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
  .logo a { font-size: 1.3rem; font-weight: 700; color: white; text-decoration: none; white-space: nowrap; }
  .main-nav { display: flex; gap: 1rem; flex-wrap: wrap; }
  .main-nav a { color: #e5e7eb; text-decoration: none; font-size: 0.9rem; white-space: nowrap; }
  .main-nav a:hover, .main-nav a.active { color: #60a5fa; }
  .header-right { display: flex; align-items: center; gap: 0.8rem; min-height: 44px; flex-wrap: wrap; }
  .login-btn { padding: 0.45rem 1.1rem; border-radius: 999px; border: 1.5px solid #60a5fa; background: transparent; color: #60a5fa; font-size: 0.95rem; cursor: pointer; }
  #container { position: relative; width: 100%; height: calc(100vh - 140px); }
  #canvas { display: block; width: 100%; height: 100%; touch-action: none; outline: none; }
  .panel {
    position: absolute; top: 90px; right: 20px; width: 380px; max-height: calc(100vh - 220px); background: rgba(2, 6, 23, 0.95); border: 1px solid #1e293b; border-radius: 12px; padding: 1.5rem; overflow-y: auto; z-index: 20; backdrop-filter: blur(10px); transition: transform 0.3s ease; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  }
  .panel.hidden { transform: translateX(420px); }
  #panelToggle {
    position: absolute; left: -60px; top: 50%; transform: translateY(-50%); width: 60px; height: 110px; background: rgba(2, 6, 23, 0.98); border: 1px solid #1e293b; border-right: none; border-radius: 20px 0 0 20px; color: #60a5fa; font-size: 2.4rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 21; backdrop-filter: blur(12px);
  }
  #panelToggle:hover { background: rgba(30, 41, 59, 0.98); color: white; transform: translateY(-50%) translateX(-4px); }
  @media (max-width: 900px) {
    .panel { top: auto; right: 0; left: 0; bottom: 0; width: 100%; height: 85vh; max-height: none; border-radius: 20px 20px 0 0; transform: translateY(calc(100% - 60px)); transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1); padding-top: 20px; padding-bottom: 120px; z-index: 1100; border-bottom: none; box-shadow: 0 -5px 25px rgba(0,0,0,0.5); }
    .panel.visible { transform: translateY(0); }
    #panelToggle { display: none; }
  }
  #mobilePanelToggle {
    position: fixed; bottom: 20px; right: 20px; width: 140px; height: 44px; background: rgba(2, 6, 23, 0.9); border: 1px solid #60a5fa; border-radius: 22px; color: #60a5fa; font-size: 0.85rem; font-weight: 700; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1200; backdrop-filter: blur(12px); box-shadow: 0 4px 20px rgba(0,0,0,0.6); transition: background 0.2s, transform 0.1s; text-transform: uppercase; letter-spacing: 0.5px;
  }
  #mobilePanelToggle:active { transform: scale(0.96); }
  #mobilePanelToggle::before { content: ''; position: absolute; top: -6px; left: 50%; transform: translateX(-50%); width: 40px; height: 4px; background: #94a3b8; border-radius: 2px; opacity: 0.5; }
  @media (min-width: 901px) { #mobilePanelToggle { display: none; } }
  @media (max-width: 900px) { #mobilePanelToggle { display: flex; } }
  #floatingControls {
    position: fixed; bottom: 20px; left: 20px; display: flex; gap: 10px; z-index: 1150; pointer-events: none;
  }
  .floater {
    pointer-events: auto; width: 44px; height: 44px; border-radius: 50%; border: 1px solid #475569; background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(8px); color: #94a3b8; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.4); transition: all 0.2s; font-size: 1.2rem;
  }
  .floater:hover { background: rgba(51, 65, 85, 1); color: white; transform: translateY(-2px); }
  .floater.active { color: #60a5fa; border-color: #60a5fa; background: rgba(2, 6, 23, 1); }
  .panel h2 { color: #60a5fa; margin: 1.5rem 0 1rem; font-size: 1.1rem; border-bottom: 1px solid #1e293b; padding-bottom: 0.5rem; }
  label { display: block; font-size: 0.9rem; color: #e5e7eb; margin-bottom: 0.4rem; }
  input, select, button { width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #1f2937; background: #020617; color: #e5e7eb; font: inherit; }
  input[type="range"] { accent-color: #60a5fa; }
  input[type="color"] { height: 44px; }
  button { background: #60a5fa; border: none; color: white; cursor: pointer; margin-top: 0.8rem; font-weight: 600; transition: background 0.2s; }
  button:hover { background: #3b82f6; }
  #layersList { list-style: none; padding: 0; margin: 0 0 1rem; }
  .layer-item {
    display: flex; align-items: center; gap: 8px; padding: 10px; background: #0f172a; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent;
  }
  .layer-item.active { background: #1e293b; border-color: #60a5fa; }
  .layer-item.group > .layer-name::before { content: "üìÅ "; }
  .layer-visibility, .layer-delete { font-size: 1.3rem; cursor: pointer; }
  .layer-name { flex: 1; font-size: 0.95rem; }
  #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #60a5fa; font-size: 1.5rem; font-weight: bold; pointer-events: none; z-index: 0; }
  .tool-notification {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0.8); background: linear-gradient(135deg,rgba(96,165,250,0.95),rgba(59,130,246,0.95)); color: white; padding: 1.5rem 3rem; border-radius: 20px; font-size: 1.8rem; font-weight: 700; z-index: 10000; opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  }
  .tool-notification.show { opacity: 1; transform: translate(-50%,-50%) scale(1); }

  /* FOOTER - Matches your Terms page exactly */
  .site-footer {
    background: rgba(2,6,23,0.95);
    border-top: 1px solid #1e293b;
    padding: 3rem 1rem 2rem;
    margin-top: auto;
  }
  .footer-inner {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1.5rem;
    font-size: 0.9rem;
  }
  .footer-nav {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }
  .footer-nav a {
    color: #cbd5e1;
    text-decoration: none;
    transition: color 0.2s;
  }
  .footer-nav a:hover {
    color: #60a5fa;
  }
  .site-footer p {
    margin: 0;
    color: #94a3b8;
  }
  @media (max-width: 768px) {
    .footer-inner {
      flex-direction: column;
      text-align: center;
      gap: 1rem;
    }
    .footer-nav {
      justify-content: center;
    }
  }
  </style>
</head>
<body>
<header class="site-header">
  <div class="header-inner">
    <div class="header-left">
      <div class="logo"><a href="#">BowesProduct</a></div>
      <nav class="main-nav">
        <a href="#">Home</a>
        <a href="#">Models</a>
        <a href="#">Retexture</a>
        <a href="#">Editor</a>
        <a href="#" class="active">3D</a>
      </nav>
    </div>
    <div class="header-right">
      <button id="authBtn" class="login-btn">Login</button>
    </div>
  </div>
</header>

<div id="container">
  <div id="loader">Add objects or upload a model to start</div>
  <canvas id="canvas"></canvas>

  <div id="floatingControls">
    <div class="floater active" id="floaterSelect">üëÜ</div>
    <div class="floater" id="floaterMove">‚ú•</div>
    <div class="floater" id="floaterRotate">‚Üª</div>
    <div class="floater" id="floaterScale">‚§¢</div>
  </div>

  <div class="tool-notification" id="toolNotification"></div>

  <div class="panel visible" id="panel">
    <button id="panelToggle">‚Üê</button>

    <div style="padding:0.8rem;background:rgba(30,41,59,0.4);border-radius:8px;margin-bottom:1rem;font-size:0.85rem;line-height:1.4;border:1px solid #334155;">
      <strong style="color:#60a5fa">Blender-Style Controls:</strong><br><br>
      ‚Ä¢ Left drag: Orbit view<br>
      ‚Ä¢ Right drag: Pan view<br>
      ‚Ä¢ Scroll wheel: Zoom<br>
      ‚Ä¢ Click object: Select (hold Ctrl/Cmd for multi-select)<br>
      ‚Ä¢ G: Move ‚Ä¢ R: Rotate ‚Ä¢ S: Scale<br>
      ‚Ä¢ Click & drag red/green/blue arrows/rings to transform<br>
      ‚Ä¢ Delete: Delete object ‚Ä¢ Ctrl+D: Duplicate ‚Ä¢ Ctrl+Z/Y: Undo/Redo
    </div>

    <h2>Add Primitives</h2>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
      <button onclick="addPrimitive('Box')">Box</button>
      <button onclick="addPrimitive('Sphere')">Sphere</button>
      <button onclick="addPrimitive('Cylinder')">Cylinder</button>
      <button onclick="addPrimitive('Torus')">Torus</button>
      <button onclick="addPrimitive('Cone')">Cone</button>
      <button onclick="addPrimitive('Plane')">Plane</button>
      <button onclick="addPrimitive('Icosahedron')">Icosahedron</button>
      <button onclick="addPrimitive('Dodecahedron')">Dodecahedron</button>
      <button onclick="addPrimitive('Octahedron')">Octahedron</button>
      <button onclick="addPrimitive('Tetrahedron')">Tetrahedron</button>
      <button onclick="addPrimitive('Ring')">Ring</button>
      <button onclick="addPrimitive('Tube')">Tube</button>
    </div>

    <h2>Group</h2>
    <button onclick="createGroup()">Create Group from Selected</button>
    <button onclick="ungroup()">Ungroup Selected</button>

    <h2>Import</h2>
    <input type="file" id="uploadModel" accept=".glb,.gltf,.obj,.fbx" style="width:100%;padding:0.5rem;background:#020617;border:1px solid #1f2937;border-radius:8px;">

    <h2>Selected Object</h2>
    <div id="selectedObjectInfo"><p style="color:#94a3b8;">No object selected</p></div>

    <div id="transformControls" style="display:none;">
      <div style="margin:1rem 0;"><strong>Position</strong></div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
        <input type="number" id="posX" step="0.1">
        <input type="number" id="posY" step="0.1">
        <input type="number" id="posZ" step="0.1">
      </div>
      <div style="margin:1rem 0;"><strong>Rotation (¬∞)</strong></div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
        <input type="number" id="rotX" step="5">
        <input type="number" id="rotY" step="5">
        <input type="number" id="rotZ" step="5">
      </div>
      <div style="margin:1rem 0;"><strong>Scale</strong></div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
        <input type="number" id="scaleX" step="0.1" min="0.01">
        <input type="number" id="scaleY" step="0.1" min="0.01">
        <input type="number" id="scaleZ" step="0.1" min="0.01">
      </div>
      <button onclick="duplicateSelected()">Duplicate</button>
      <button onclick="deleteSelected()" style="background:#ef4444;">Delete</button>
    </div>

    <h2>Material</h2>
    <input type="color" id="materialColor" value="#60a5fa">
    <label>Metallic <span id="metallicVal">0.00</span></label>
    <input type="range" id="metallicSlider" min="0" max="1" step="0.01" value="0">
    <label>Roughness <span id="roughnessVal">0.50</span></label>
    <input type="range" id="roughnessSlider" min="0" max="1" step="0.01" value="0.5">

    <h2>Environment</h2>
    <select id="envPreset">
      <option value="neutral">Neutral</option>
      <option value="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r182/examples/textures/equirect/royal_esplanade_1k.hdr">Royal Esplanade</option>
      <option value="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r182/examples/textures/equirect/spruit_sunrise_1k.hdr">Sunrise</option>
      <option value="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r182/examples/textures/equirect/moonless_golf_1k.hdr">Night</option>
    </select>

    <h2>Objects</h2>
    <ol id="layersList"></ol>

    <h2>Export</h2>
    <button onclick="exportModel()">Export as GLB</button>
    <div id="exportStatus" style="margin-top:0.5rem;color:#94a3b8;"></div>
  </div>
</div>

<div id="mobilePanelToggle"><span>‚ñ≤ Controls</span></div>

<footer class="site-footer">
  <div class="footer-inner">
    <nav class="footer-nav">
      <a href="about.html">About</a>
      <a href="privacy.html">Privacy</a>
      <a href="terms.html">Terms</a>
      <a href="license.html">License</a>
      <a href="refund.html">Refund</a>
      <a href="rewards.html">Rewards</a>
    </nav>
    <p>¬© 2026 BowesProduct</p>
  </div>
</footer>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';

// Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY", // ‚Üê Replace with your real values
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef123456"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// Three.js Setup
const canvas = document.getElementById('canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.shadowMap.enabled = true;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x020617);
scene.add(new THREE.GridHelper(20, 20, 0x1e293b, 0x0f172a));
scene.add(new THREE.AmbientLight(0xffffff, 0.4));
const dirLight = new THREE.DirectionalLight(0xffffff, 1);
dirLight.position.set(5, 10, 7);
scene.add(dirLight);

const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(5, 4, 5);

// Blender-style controls
const controls = new OrbitControls(camera, canvas);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.screenSpacePanning = true;
controls.mouseButtons = { LEFT: THREE.MOUSE.ROTATE, MIDDLE: THREE.MOUSE.DOLLY, RIGHT: THREE.MOUSE.PAN };

// Single TransformControls (only one!)
const transformControl = new TransformControls(camera, canvas);
transformControl.addEventListener('dragging-changed', e => controls.enabled = !e.value);
transformControl.addEventListener('change', updateTransformInputs);
scene.add(transformControl);

// Environment
const pmrem = new THREE.PMREMGenerator(renderer);
pmrem.compileEquirectangularShader();

function loadEnvironment(url) {
  if (url === 'neutral') { scene.environment = null; return; }
  new RGBELoader().load(url, tex => {
    scene.environment = pmrem.fromEquirectangular(tex).texture;
    tex.dispose();
  });
}
document.getElementById('envPreset').onchange = e => loadEnvironment(e.target.value);
loadEnvironment('neutral');

// Objects
const rootObjects = [];
let selectedObjects = [];
let objectCounter = 0;

// Undo/Redo
const undoStack = [];
const redoStack = [];
const MAX_UNDO = 50;
const undoBtn = document.getElementById('undoBtn');
const redoBtn = document.getElementById('redoBtn');

function saveState() {
  const state = rootObjects.map(obj => serializeObject(obj));
  undoStack.push(state);
  if (undoStack.length > MAX_UNDO) undoStack.shift();
  redoStack.length = 0;
  undoBtn.disabled = false;
  redoBtn.disabled = true;
  addXP(1);
}

function serializeObject(obj) {
  if (obj.userData.isGroup) {
    return {
      type: 'group',
      name: obj.userData.name,
      visible: obj.visible,
      position: obj.position.toArray(),
      rotation: obj.rotation.toArray(),
      scale: obj.scale.toArray(),
      children: obj.children.map(serializeObject)
    };
  } else if (obj.isMesh) {
    return {
      type: 'mesh',
      name: obj.userData.name,
      geometry: obj.userData.geometryName,
      visible: obj.visible,
      position: obj.position.toArray(),
      rotation: obj.rotation.toArray(),
      scale: obj.scale.toArray(),
      color: obj.material.color.getHex(),
      metallic: obj.material.metalness,
      roughness: obj.material.roughness
    };
  }
  return null;
}

function deserializeObject(data, parent = null) {
  let obj;
  if (data.type === 'group') {
    obj = new THREE.Group();
    obj.userData.isGroup = true;
    data.children.forEach(childData => {
      const child = deserializeObject(childData, obj);
      if (child) obj.add(child);
    });
  } else if (data.type === 'mesh') {
    const geometry = createGeometryForName(data.geometry);
    if (!geometry) return null;
    const material = new THREE.MeshStandardMaterial({
      color: data.color,
      metalness: data.metallic,
      roughness: data.roughness
    });
    obj = new THREE.Mesh(geometry, material);
    obj.userData.geometryName = data.geometry;
    obj.castShadow = obj.receiveShadow = true;
  }

  if (obj) {
    obj.userData.name = data.name;
    obj.userData.id = objectCounter++;
    obj.visible = data.visible;
    obj.position.fromArray(data.position);
    obj.rotation.fromArray(data.rotation);
    obj.scale.fromArray(data.scale);
    if (parent) parent.add(obj);
  }
  return obj;
}

function restoreState(state) {
  rootObjects.forEach(o => scene.remove(o));
  rootObjects.length = 0;
  state.forEach(data => {
    const obj = deserializeObject(data);
    if (obj) {
      scene.add(obj);
      rootObjects.push(obj);
    }
  });
  selectedObjects = [];
  transformControl.detach();
  updateSelectedObjectUI();
  updateLayersList();
}

function undo() {
  if (undoStack.length === 0) return;
  redoStack.push(rootObjects.map(obj => serializeObject(obj)).filter(s => s !== null));
  const state = undoStack.pop();
  restoreState(state);
  undoBtn.disabled = undoStack.length === 0;
  redoBtn.disabled = false;
}

function redo() {
  if (redoStack.length === 0) return;
  undoStack.push(rootObjects.map(obj => serializeObject(obj)).filter(s => s !== null));
  const state = redoStack.pop();
  restoreState(state);
  redoBtn.disabled = redoStack.length === 0;
  undoBtn.disabled = false;
}

undoBtn.onclick = undo;
redoBtn.onclick = redo;

function createGeometryForName(name) {
  switch(name) {
    case 'Box': return new THREE.BoxGeometry(1, 1, 1);
    case 'Sphere': return new THREE.SphereGeometry(0.5, 32, 32);
    case 'Cylinder': return new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
    case 'Torus': return new THREE.TorusGeometry(0.5, 0.2, 16, 48);
    case 'Cone': return new THREE.ConeGeometry(0.5, 1, 32);
    case 'Plane': return new THREE.PlaneGeometry(1, 1);
    case 'Icosahedron': return new THREE.IcosahedronGeometry(0.6);
    case 'Dodecahedron': return new THREE.DodecahedronGeometry(0.6);
    case 'Octahedron': return new THREE.OctahedronGeometry(0.7);
    case 'Tetrahedron': return new THREE.TetrahedronGeometry(0.7);
    case 'Ring': return new THREE.RingGeometry(0.3, 0.6, 32);
    case 'Tube': return new THREE.TubeGeometry(new THREE.CatmullRomCurve3([new THREE.Vector3(-1,0,0), new THREE.Vector3(-0.5,1,0), new THREE.Vector3(0.5,-1,0), new THREE.Vector3(1,0,0)]), 64, 0.1, 8, false);
    default: return new THREE.BoxGeometry(1, 1, 1);
  }
}

function addPrimitive(name) {
  saveState();
  const geometry = createGeometryForName(name);
  const material = new THREE.MeshStandardMaterial({ color: 0x60a5fa, metalness: 0, roughness: 0.5 });
  const mesh = new THREE.Mesh(geometry, material);
  mesh.position.y = 0.5;
  mesh.castShadow = mesh.receiveShadow = true;
  mesh.userData.name = name;
  mesh.userData.geometryName = name;
  mesh.userData.id = objectCounter++;
  scene.add(mesh);
  rootObjects.push(mesh);
  selectObject(mesh, false);
  updateLayersList();
  document.getElementById('loader').style.display = 'none';
  addXP(5);
}

// Primitive buttons
document.getElementById('addBox').onclick = () => addPrimitive('Box');
document.getElementById('addSphere').onclick = () => addPrimitive('Sphere');
document.getElementById('addCylinder').onclick = () => addPrimitive('Cylinder');
document.getElementById('addTorus').onclick = () => addPrimitive('Torus');
document.getElementById('addCone').onclick = () => addPrimitive('Cone');
document.getElementById('addPlane').onclick = () => addPrimitive('Plane');
document.getElementById('addIcosahedron').onclick = () => addPrimitive('Icosahedron');
document.getElementById('addDodecahedron').onclick = () => addPrimitive('Dodecahedron');
document.getElementById('addOctahedron').onclick = () => addPrimitive('Octahedron');
document.getElementById('addTetrahedron').onclick = () => addPrimitive('Tetrahedron');
document.getElementById('addRing').onclick = () => addPrimitive('Ring');
document.getElementById('addTube').onclick = () => addPrimitive('Tube');

// Selection with green glow
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

function selectObject(object, multi = false) {
  selectedObjects.forEach(o => {
    if (o.userData.originalMaterial) {
      o.material = o.userData.originalMaterial;
      delete o.userData.originalMaterial;
    }
  });

  if (!multi) selectedObjects = [];

  if (object) {
    if (!selectedObjects.includes(object)) selectedObjects.push(object);
    if (object.isMesh && object.material) {
      object.userData.originalMaterial = object.material.clone();
      const glowMat = object.material.clone();
      glowMat.emissive = new THREE.Color(0x22c55e);
      glowMat.emissiveIntensity = 0.5;
      object.material = glowMat;
    }
  }

  if (selectedObjects.length === 1) {
    transformControl.attach(selectedObjects[0]);
  } else {
    transformControl.detach();
  }

  updateSelectedObjectUI();
  updateFloaterActiveState();
  updateLayersList();
}

canvas.addEventListener('pointerdown', e => {
  if (transformControl.dragging) return;
  mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(scene.children, true);
  if (intersects.length > 0) {
    let obj = intersects[0].object;
    while (obj.parent && obj.parent !== scene) obj = obj.parent;
    selectObject(obj, e.ctrlKey || e.metaKey);
  } else if (!e.ctrlKey && !e.metaKey) {
    selectedObjects = [];
    transformControl.detach();
    updateSelectedObjectUI();
    updateLayersList();
  }
});

function updateSelectedObjectUI() {
  const infoDiv = document.getElementById('selectedObjectInfo');
  const transformDiv = document.getElementById('transformControls');
  if (selectedObjects.length === 0) {
    infoDiv.innerHTML = '<p style="color:#94a3b8;font-size:0.85rem;">No object selected</p>';
    transformDiv.style.display = 'none';
    return;
  }
  let html = `<div class="object-info"><h3>${selectedObjects.length} object${selectedObjects.length > 1 ? 's' : ''} selected</h3>`;
  if (selectedObjects.length === 1) {
    const obj = selectedObjects[0];
    html += `<p>Type: ${obj.userData.name || 'Mesh'}</p><p>ID: ${obj.userData.id}</p>`;
    if (obj.material) {
      document.getElementById('materialColor').value = '#' + obj.material.color.getHexString();
      document.getElementById('metallicSlider').value = obj.material.metalness || 0;
      document.getElementById('metallicVal').textContent = (obj.material.metalness || 0).toFixed(2);
      document.getElementById('roughnessSlider').value = obj.material.roughness || 0.5;
      document.getElementById('roughnessVal').textContent = (obj.material.roughness || 0.5).toFixed(2);
    }
  } else {
    html += `<p>Multi-selection active</p>`;
  }
  html += `</div>`;
  infoDiv.innerHTML = html;
  transformDiv.style.display = 'block';
  updateTransformInputs();
}

function updateTransformInputs() {
  if (selectedObjects.length === 0) return;
  const obj = selectedObjects[0];
  document.getElementById('posX').value = obj.position.x.toFixed(2);
  document.getElementById('posY').value = obj.position.y.toFixed(2);
  document.getElementById('posZ').value = obj.position.z.toFixed(2);
  document.getElementById('rotX').value = THREE.MathUtils.radToDeg(obj.rotation.x).toFixed(1);
  document.getElementById('rotY').value = THREE.MathUtils.radToDeg(obj.rotation.y).toFixed(1);
  document.getElementById('rotZ').value = THREE.MathUtils.radToDeg(obj.rotation.z).toFixed(1);
  document.getElementById('scaleX').value = obj.scale.x.toFixed(2);
  document.getElementById('scaleY').value = obj.scale.y.toFixed(2);
  document.getElementById('scaleZ').value = obj.scale.z.toFixed(2);
}

function applyTransformToAll() {
  const pos = new THREE.Vector3(
    parseFloat(document.getElementById('posX').value) || 0,
    parseFloat(document.getElementById('posY').value) || 0,
    parseFloat(document.getElementById('posZ').value) || 0
  );
  const rot = new THREE.Euler(
    THREE.MathUtils.degToRad(parseFloat(document.getElementById('rotX').value) || 0),
    THREE.MathUtils.degToRad(parseFloat(document.getElementById('rotY').value) || 0),
    THREE.MathUtils.degToRad(parseFloat(document.getElementById('rotZ').value) || 0)
  );
  const scale = new THREE.Vector3(
    parseFloat(document.getElementById('scaleX').value) || 1,
    parseFloat(document.getElementById('scaleY').value) || 1,
    parseFloat(document.getElementById('scaleZ').value) || 1
  );
  selectedObjects.forEach(obj => {
    obj.position.copy(pos);
    obj.rotation.copy(rot);
    obj.scale.copy(scale);
  });
}

['posX','posY','posZ','rotX','rotY','rotZ','scaleX','scaleY','scaleZ'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => {
    saveState();
    applyTransformToAll();
  });
});

document.getElementById('materialColor').addEventListener('input', e => {
  if (selectedObjects.length === 1 && selectedObjects[0].isMesh) {
    selectedObjects[0].material.color.set(e.target.value);
    addXP(1);
  }
});

document.getElementById('metallicSlider').addEventListener('input', e => {
  const v = parseFloat(e.target.value);
  document.getElementById('metallicVal').textContent = v.toFixed(2);
  if (selectedObjects.length === 1 && selectedObjects[0].isMesh) {
    selectedObjects[0].material.metalness = v;
    addXP(1);
  }
});

document.getElementById('roughnessSlider').addEventListener('input', e => {
  const v = parseFloat(e.target.value);
  document.getElementById('roughnessVal').textContent = v.toFixed(2);
  if (selectedObjects.length === 1 && selectedObjects[0].isMesh) {
    selectedObjects[0].material.roughness = v;
    addXP(1);
  }
});

function duplicateSelected() {
  if (selectedObjects.length === 0) return;
  saveState();
  const clones = [];
  selectedObjects.forEach(obj => {
    const clone = obj.clone();
    if (obj.isMesh && obj.material) clone.material = obj.material.clone();
    clone.position.x += 1;
    clone.userData.id = objectCounter++;
    clone.userData.name = obj.userData.name + ' (copy)';
    scene.add(clone);
    rootObjects.push(clone);
    clones.push(clone);
  });
  selectedObjects = clones;
  transformControl.attach(selectedObjects[0]);
  updateLayersList();
  updateSelectedObjectUI();
  addXP(3);
}

function deleteSelected() {
  if (selectedObjects.length === 0) return;
  saveState();
  const objectsToDelete = [...selectedObjects];
  objectsToDelete.forEach(obj => {
    let parent = obj.parent;
    if (parent && parent.userData.isGroup) {
      parent.remove(obj);
      if (parent.children.length === 0) {
        scene.remove(parent);
        const idx = rootObjects.indexOf(parent);
        if (idx > -1) rootObjects.splice(idx, 1);
      }
    } else {
      scene.remove(obj);
      const idx = rootObjects.indexOf(obj);
      if (idx > -1) rootObjects.splice(idx, 1);
    }
  });
  selectedObjects = [];
  transformControl.detach();
  updateLayersList();
  updateSelectedObjectUI();
  addXP(2);
}

document.getElementById('duplicateBtn').onclick = duplicateSelected;
document.getElementById('deleteBtn').onclick = deleteSelected;

document.getElementById('createGroup').onclick = () => {
  if (selectedObjects.length < 2) return;
  saveState();
  const group = new THREE.Group();
  group.userData.isGroup = true;
  group.userData.name = `Group ${rootObjects.filter(o => o.userData.isGroup).length + 1}`;
  group.userData.id = objectCounter++;

  const center = new THREE.Vector3();
  selectedObjects.forEach(obj => center.add(obj.position));
  center.divideScalar(selectedObjects.length);

  selectedObjects.forEach(obj => {
    const worldPos = new THREE.Vector3();
    obj.getWorldPosition(worldPos);
    obj.parent.remove(obj);
    group.add(obj);
    obj.position.copy(worldPos).sub(center);
  });

  group.position.copy(center);
  scene.add(group);
  rootObjects.push(group);

  selectedObjects.forEach(obj => {
    const idx = rootObjects.indexOf(obj);
    if (idx > -1) rootObjects.splice(idx, 1);
  });

  selectedObjects = [group];
  transformControl.attach(group);
  updateLayersList();
  updateSelectedObjectUI();
  addXP(5);
};

document.getElementById('ungroup').onclick = () => {
  const groupsToUngroup = selectedObjects.filter(o => o.userData.isGroup);
  if (groupsToUngroup.length === 0) return;
  saveState();

  groupsToUngroup.forEach(group => {
    const children = [...group.children];
    children.forEach(child => {
      const worldPos = new THREE.Vector3();
      child.getWorldPosition(worldPos);
      group.remove(child);
      scene.add(child);
      child.position.copy(worldPos);
      rootObjects.push(child);
    });
    scene.remove(group);
    const idx = rootObjects.indexOf(group);
    if (idx > -1) rootObjects.splice(idx, 1);
  });
  selectedObjects = [];
  transformControl.detach();
  updateLayersList();
  updateSelectedObjectUI();
  addXP(3);
};

function updateLayersList() {
  const list = document.getElementById('layersList');
  list.innerHTML = '';
  rootObjects.slice().reverse().forEach(obj => {
    if (obj) addLayerItem(obj, list);
  });
}

function addLayerItem(obj, parentList) {
  const li = document.createElement('li');
  li.className = 'layer-item' + (selectedObjects.includes(obj) ? ' active' : '') + (obj.userData.isGroup ? ' group' : '');
  li.innerHTML = `
    <span class="layer-toggle">${obj.userData.isGroup ? '‚ñº' : ''}</span>
    <span class="layer-visibility">${obj.visible ? 'üëÅ' : 'üö´'}</span>
    <span class="layer-name">${obj.userData.name || 'Object'}</span>
    <span class="layer-delete">√ó</span>
  `;
  parentList.appendChild(li);

  li.querySelector('.layer-visibility').onclick = e => {
    e.stopPropagation();
    obj.visible = !obj.visible;
    li.querySelector('.layer-visibility').textContent = obj.visible ? 'üëÅ' : 'üö´';
    obj.traverse(child => child.visible = obj.visible);
    saveState();
  };

  li.querySelector('.layer-delete').onclick = e => {
    e.stopPropagation();
    saveState();
    if (obj.parent && obj.parent.userData.isGroup) {
      obj.parent.remove(obj);
    } else {
      scene.remove(obj);
      const idx = rootObjects.indexOf(obj);
      if (idx > -1) rootObjects.splice(idx, 1);
    }
    selectedObjects = selectedObjects.filter(o => o !== obj);
    transformControl.detach();
    updateLayersList();
    updateSelectedObjectUI();
    addXP(2);
  };

  li.onclick = e => {
    if (e.target.classList.contains('layer-delete') || e.target.classList.contains('layer-visibility') || e.target.classList.contains('layer-toggle')) return;
    selectObject(obj, e.ctrlKey || e.metaKey);
  };

  if (obj.userData.isGroup) {
    const childList = document.createElement('ol');
    childList.style.marginLeft = '20px';
    childList.style.display = 'block';
    obj.children.forEach(child => addLayerItem(child, childList));
    li.appendChild(childList);
    li.querySelector('.layer-toggle').onclick = e => {
      e.stopPropagation();
      childList.style.display = childList.style.display === 'none' ? 'block' : 'none';
      li.querySelector('.layer-toggle').textContent = childList.style.display === 'none' ? '‚ñ∂' : '‚ñº';
    };
  }
}

// Model Import
const gltfLoader = new GLTFLoader();

document.getElementById('uploadModel').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  loadModel(url);
});

function loadModel(url) {
  document.getElementById('loader').style.display = 'block';
  document.getElementById('loader').textContent = 'Loading model...';

  gltfLoader.load(url, gltf => {
    const model = gltf.scene;
    const box = new THREE.Box3().setFromObject(model);
    const center = box.getCenter(new THREE.Vector3());
    model.position.sub(center);

    model.traverse(child => {
      if (child.isMesh) {
        child.castShadow = child.receiveShadow = true;
        child.userData.name = child.name || 'Imported Model';
        child.userData.id = objectCounter++;
      }
    });

    model.userData.name = 'Imported Model';
    model.userData.id = objectCounter++;

    scene.add(model);
    rootObjects.push(model);
    selectObject(model, false);
    updateLayersList();

    document.getElementById('loader').style.display = 'none';
    saveState();
    addXP(10);
  }, progress => {
    const percent = (progress.loaded / progress.total * 100).toFixed(0);
    document.getElementById('loader').textContent = `Loading... ${percent}%`;
  }, error => {
    console.error('Error loading model:', error);
    document.getElementById('loader').textContent = 'Error loading model';
    setTimeout(() => document.getElementById('loader').style.display = 'none', 2000);
  });
}

// Export
const exportStatus = document.getElementById('exportStatus');
document.getElementById('exportBtn').onclick = () => {
  if (rootObjects.length === 0) {
    exportStatus.textContent = 'No objects to export';
    exportStatus.style.color = '#ef4444';
    return;
  }
  exportStatus.textContent = 'Exporting...';
  exportStatus.style.color = '#60a5fa';

  const exporter = new GLTFExporter();
  const exportScene = new THREE.Scene();
  rootObjects.forEach(obj => exportScene.add(obj.clone()));

  exporter.parse(exportScene, result => {
    const blob = new Blob([result], { type: 'application/octet-stream' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'scene.glb';
    link.click();
    exportStatus.textContent = 'Exported!';
    exportStatus.style.color = '#4ade80';
    addXP(5);
  }, { binary: true });
};

// Floating controls
const floaterSelect = document.getElementById('floaterSelect');
const floaterMove = document.getElementById('floaterMove');
const floaterRotate = document.getElementById('floaterRotate');
const floaterScale = document.getElementById('floaterScale');

function updateFloaterActiveState() {
  floaterSelect.classList.remove('active');
  floaterMove.classList.remove('active');
  floaterRotate.classList.remove('active');
  floaterScale.classList.remove('active');

  const mode = transformControl.getMode();
  if (mode === 'translate') floaterMove.classList.add('active');
  else if (mode === 'rotate') floaterRotate.classList.add('active');
  else if (mode === 'scale') floaterScale.classList.add('active');
  else floaterSelect.classList.add('active');
}

floaterSelect.onclick = () => { transformControl.detach(); updateFloaterActiveState(); };
floaterMove.onclick = () => { if (selectedObjects.length === 1) { transformControl.attach(selectedObjects[0]); transformControl.setMode('translate'); updateFloaterActiveState(); } };
floaterRotate.onclick = () => { if (selectedObjects.length === 1) { transformControl.attach(selectedObjects[0]); transformControl.setMode('rotate'); updateFloaterActiveState(); } };
floaterScale.onclick = () => { if (selectedObjects.length === 1) { transformControl.attach(selectedObjects[0]); transformControl.setMode('scale'); updateFloaterActiveState(); } };

// Panel toggle
const panel = document.getElementById('panel');
const panelToggle = document.getElementById('panelToggle');
const mobilePanelToggle = document.getElementById('mobilePanelToggle');
let panelVisible = true;

function togglePanel() {
  panelVisible = !panelVisible;
  panel.classList.toggle('hidden', !panelVisible);
  panel.classList.toggle('visible', panelVisible);
  panelToggle.textContent = panelVisible ? '‚Üê' : '‚Üí';
  const span = mobilePanelToggle.querySelector('span');
  if (span) span.textContent = panelVisible ? '‚ñº Hide Controls' : '‚ñ≤ Controls';
}
panelToggle.onclick = mobilePanelToggle.onclick = togglePanel;

// Resize
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

// Animation loop
function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();

// Firebase Auth + XP
const authBtn = document.getElementById('authBtn');
const profilePic = document.getElementById('profilePic');
const levelInfo = document.getElementById('levelInfo');
const levelText = document.getElementById('levelText');
const xpBar = document.getElementById('xpBar');

async function addXP(amount) {
  const user = auth.currentUser;
  if (!user) return;

  const userRef = doc(db, "users", user.uid);
  const snap = await getDoc(userRef);
  const currentXP = snap.exists() ? snap.data().xp || 0 : 0;
  const newXP = currentXP + amount;

  await setDoc(userRef, { xp: newXP }, { merge: true });
  updateXPBar(newXP);
}

function updateXPBar(xp) {
  const xpPerLevel = 100;
  const level = Math.floor(xp / xpPerLevel) + 1;
  const xpInLevel = xp % xpPerLevel;
  const percentage = (xpInLevel / xpPerLevel) * 100;

  levelText.textContent = `Level ${level} - ${xpInLevel}/${xpPerLevel} XP`;
  xpBar.style.width = percentage + '%';
}

authBtn.onclick = () => auth.currentUser ? signOut(auth) : signInWithPopup(auth, provider);

onAuthStateChanged(auth, async user => {
  if (!user) {
    authBtn.textContent = 'Login';
    profilePic.style.display = 'none';
    levelInfo.style.display = 'none';
    return;
  }

  authBtn.textContent = 'Logout';
  profilePic.src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName)}&background=60a5fa&color=fff`;
  profilePic.style.display = 'block';
  levelInfo.style.display = 'block';

  const userRef = doc(db, "users", user.uid);
  const snap = await getDoc(userRef);

  if (!snap.exists()) {
    await setDoc(userRef, { xp: 10 });
  }

  const xp = snap.data()?.xp || 10;
  updateXPBar(xp);
});

// Initialize
document.getElementById('loader').style.display = 'none';
saveState();
addPrimitive('Box');
updateFloaterActiveState();
</script>
</body>
</html>





