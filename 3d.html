<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BowesProduct 3D Editor</title>
  <style>
  *, *::before, *::after { box-sizing: border-box; }
  html, body { margin: 0; height: 100%; background: #020617; color: white; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; -webkit-font-smoothing: antialiased; }
  
  .site-header {
    position: sticky; top: 0; z-index: 1000; background: rgba(2,6,23,0.95); border-bottom: 1px solid #1e293b; backdrop-filter: blur(10px);
  }
  .header-inner { max-width: 1400px; margin: 0 auto; padding: 0.6rem 1rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; }
  .header-left { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
  .logo a { font-size: 1.3rem; font-weight: 700; color: white; text-decoration: none; white-space: nowrap; }
  .main-nav { display: flex; gap: 1rem; flex-wrap: wrap; }
  .main-nav a { color: #e5e7eb; text-decoration: none; font-size: 0.9rem; white-space: nowrap; }
  .main-nav a:hover, .main-nav a.active { color: #60a5fa; }
  .header-right { display: flex; align-items: center; gap: 0.8rem; min-height: 44px; flex-wrap: wrap; }
  #profilePic { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #60a5fa; object-fit: cover; display: none; }
  .login-btn { padding: 0.45rem 1.1rem; border-radius: 999px; border: 1.5px solid #60a5fa; background: transparent; color: #60a5fa; font-size: 0.95rem; cursor: pointer; }
  #levelInfo { display: none; font-size: 0.8rem; color: #cbd5e1; }
  #levelText { white-space: nowrap; font-size: 0.75rem; }
  #xpOuter { width: 100px; height: 5px; background: #1e293b; border-radius: 3px; margin-top: 4px; }
  #xpBar { height: 100%; width: 0%; background: #60a5fa; border-radius: 3px; transition: width 0.35s ease; }

  .app-menu-bar {
    background: rgba(15,23,42,0.98);
    border-bottom: 1px solid #1e293b;
    padding: 0;
    padding-left: 150px;
    display: flex;
    gap: 0;
    font-size: 0.85rem;
    position: sticky;
    top: 70px;
    z-index: 999;
    backdrop-filter: blur(10px);
    flex-wrap: wrap;
    height: 36px;
    align-items: center;
  }
  .menu-bar { display: flex; height: 100%; }
  .menu-bar > div {
    position: relative; cursor: pointer; padding: 0.5rem 1rem; height: 100%; display: flex; align-items: center; user-select: none;
  }
  .menu-bar > div:hover { color: #60a5fa; background: rgba(96, 165, 250, 0.1); }
  .dropdown {
    position: absolute; top: 100%; left: 0; background: #0f172a; border: 1px solid #1e293b; min-width: 260px; display: none; flex-direction: column; box-shadow: 0 8px 25px rgba(0,0,0,0.6); border-radius: 6px; overflow: hidden; z-index: 10000; margin-top: 2px;
  }
  .dropdown div { padding: 0.6rem 1.2rem; text-align: left; white-space: nowrap; transition: background 0.15s; font-size: 0.85rem; cursor: pointer; }
  .dropdown div:hover { background: #1e293b; }
  .dropdown .shortcut { float: right; color: #64748b; font-size: 0.75rem; margin-left: 2rem; }
  .dropdown hr { border: none; border-top: 1px solid #1e293b; margin: 0.4rem 0; }
  .menu-bar > div:hover .dropdown { display: flex; }

  #container { position: relative; width: 100%; height: 100%; padding-top: 106px; display: flex; }

  #canvas-container {
    flex: 1; position: relative; background: #1a1a2e; overflow: hidden; display: flex; flex-direction: column;
  }

  .ruler { position: absolute; background: #1e293b; color: #64748b; font-size: 10px; z-index: 10; }
  .ruler-h { top: 0; left: 60px; right: 0; height: 20px; border-bottom: 1px solid #334155; }
  .ruler-v { top: 20px; left: 0; width: 60px; bottom: 0; border-right: 1px solid #334155; }
  .ruler-corner { position: absolute; top: 0; left: 0; width: 60px; height: 20px; background: #1e293b; border-right: 1px solid #334155; border-bottom: 1px solid #334155; z-index: 11; }

  #canvas { display: block; width: 100%; height: 100%; touch-action: none; outline: none; margin-top: 20px; margin-left: 60px; background: #1a1a2e; }

  #floatingToolbar {
    position: fixed; left: 20px; top: 116px; background: rgba(30, 41, 59, 0.95); padding: 10px; border-radius: 12px; border: 1px solid #1e293b; backdrop-filter: blur(8px); z-index: 1150; display: flex; flex-direction: column; gap: 8px; max-height: calc(100vh - 180px); overflow-y: auto;
  }
  .tool-group { display: flex; flex-direction: column; gap: 2px; padding: 4px 0; border-bottom: 1px solid #1e293b; }
  .tool-group:last-child { border-bottom: none; }
  .tool-btn {
    width: 42px; height: 42px; border-radius: 6px; border: 1px solid transparent; background: transparent; color: #94a3b8; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; font-size: 1.3rem;
  }
  .tool-btn:hover { background: rgba(51, 65, 85, 1); color: white; }
  .tool-btn.active { color: #22c55e; background: rgba(34, 197, 94, 0.1); border-color: #22c55e; }

  .panel-dock {
    position: fixed; right: 20px; top: 116px; width: 320px; max-height: calc(100vh - 140px); background: rgba(2, 6, 23, 0.95); border: 1px solid #1e293b; border-radius: 12px; overflow: hidden; z-index: 20; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.4); display: flex; flex-direction: column;
  }

  #dockToggle {
    position: absolute; left: -50px; top: 50%; transform: translateY(-50%); width: 50px; height: 100px; background: rgba(2, 6, 23, 0.98); border: 1px solid #1e293b; border-right: none; border-radius: 12px 0 0 12px; color: #60a5fa; font-size: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 21; backdrop-filter: blur(12px);
  }
  #dockToggle:hover { background: rgba(30, 41, 59, 0.98); color: white; }

  .panel-tabs { display: flex; background: #0f172a; border-bottom: 1px solid #1e293b; overflow-x: auto; }
  .panel-tab {
    padding: 0.6rem 1rem; background: transparent; border: none; color: #94a3b8; cursor: pointer; font-size: 0.8rem; white-space: nowrap;
  }
  .panel-tab:hover { color: #e5e7eb; }
  .panel-tab.active { color: #60a5fa; background: rgba(96, 165, 250, 0.1); border-bottom: 2px solid #60a5fa; }
  .panel-content { padding: 1rem; overflow-y: auto; flex: 1; }
  .panel-section { display: none; }
  .panel-section.active { display: block; }
  .panel-section h3 {
    color: #60a5fa; margin: 1rem 0 0.8rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #1e293b; padding-bottom: 0.4rem;
  }
  .control-group { margin-bottom: 1rem; }
  .control-group label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.4rem; }
  .control-row { display: flex; gap: 0.5rem; align-items: center; }

  input[type="text"], input[type="number"], select {
    width: 100%; padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb; font-size: 0.85rem;
  }
  input[type="range"] { width: 100%; accent-color: #60a5fa; }
  input[type="color"] { width: 100%; height: 36px; padding: 2px; border: 1px solid #334155; border-radius: 4px; background: #0f172a; cursor: pointer; }

  .btn {
    padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #e5e7eb; cursor: pointer; font-size: 0.85rem;
  }
  .btn:hover { background: #334155; }
  .btn-primary { background: #60a5fa; border-color: #60a5fa; color: white; }
  .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
  .btn-group { display: flex; gap: 0.25rem; }

  .tool-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: linear-gradient(135deg, rgba(96, 165, 250, 0.95), rgba(59, 130, 246, 0.95));
    color: white;
    padding: 1.5rem 2.5rem;
    border-radius: 16px;
    font-size: 1.8rem;
    font-weight: 700;
    z-index: 10000;
    pointer-events: none;
    opacity: 0;
    box-shadow: 0 20px 60px rgba(96, 165, 250, 0.4);
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .tool-notification.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }

  .color-picker-popup {
    position: fixed;
    left: 70px;
    top: 116px;
    width: 280px;
    background: rgba(15, 23, 42, 0.98);
    border: 1px solid #1e293b;
    border-radius: 12px;
    padding: 1rem;
    z-index: 1200;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    display: none;
  }
  .color-picker-popup.active { display: block; }
  .color-picker-popup h4 {
    margin: 0 0 1rem 0;
    color: #60a5fa;
    font-size: 0.9rem;
    text-transform: uppercase;
    border-bottom: 1px solid #1e293b;
    padding-bottom: 0.5rem;
  }

  #loader {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #60a5fa; font-size: 1.2rem; font-weight: 600; pointer-events: none; z-index: 5;
  }

  .context-menu {
    position: fixed; background: #0f172a; border: 1px solid #1e293b; min-width: 180px; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); z-index: 2000; display: none;
  }
  .context-menu div { padding: 0.6rem 1rem; cursor: pointer; font-size: 0.85rem; }
  .context-menu div:hover { background: #1e293b; }
  .context-menu hr { border: none; border-top: 1px solid #1e293b; margin: 0.3rem 0; }

  .status-bar {
    position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.95); border-top: 1px solid #1e293b; padding: 0.4rem 1rem; font-size: 0.75rem; color: #64748b; display: flex; justify-content: space-between; z-index: 1000;
  }
  .status-bar .left { display: flex; gap: 2rem; }
  .status-bar .right { display: flex; gap: 1rem; }

  .outliner-item {
    padding: 0.5rem;
    background: #0f172a;
    border-radius: 6px;
    margin-bottom: 0.3rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
  }
  .outliner-item:hover { background: #1e293b; }
  .outliner-item.selected { background: rgba(96, 165, 250, 0.2); border: 1px solid #60a5fa; }

  .modifier-item {
    padding: 0.6rem;
    background: #0f172a;
    border-radius: 6px;
    margin-bottom: 0.4rem;
    border-left: 3px solid #60a5fa;
  }
  .modifier-item h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.85rem;
    color: #60a5fa;
    display: flex;
    justify-content: space-between;
  }
  .modifier-item .remove {
    cursor: pointer;
    color: #ef4444;
    font-size: 1rem;
  }

  @media (max-width: 900px) {
    #floatingToolbar { left: 10px; top: 111px; padding: 6px; max-height: calc(100vh - 160px); }
    .tool-btn { width: 38px; height: 38px; font-size: 1.1rem; }
    .panel-dock { top: auto; bottom: 0; right: 0; left: 0; width: 100%; height: 40vh; border-radius: 12px 12px 0 0; }
    #dockToggle { display: none; }
    .ruler-h { left: 50px; }
    .ruler-v { display: none; }
    #canvas { margin-left: 50px; }
    .app-menu-bar { padding-left: 60px; }
  }
  </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
<header class="site-header">
  <div class="header-inner">
    <div class="header-left">
      <div class="logo"><a href="#">BowesProduct 3D</a></div>
      <nav class="main-nav">
        <a href="#" class="active">3D Editor</a>
      </nav>
    </div>
    <div class="header-right">
      <img id="profilePic" alt="Profile">
      <div id="levelInfo">
        <div id="levelText"></div>
        <div id="xpOuter"><div id="xpBar"></div></div>
      </div>
      <button id="authBtn" class="login-btn">Login</button>
    </div>
  </div>
</header>

<div class="app-menu-bar">
  <div class="menu-bar">
    <div>File
      <div class="dropdown">
        <div onclick="newScene()">New <span class="shortcut">Ctrl+N</span></div>
        <div onclick="saveScene()">Save <span class="shortcut">Ctrl+S</span></div>
        <hr>
        <div onclick="importModel()">Import Model</div>
        <div onclick="exportModel()">Export Model</div>
      </div>
    </div>
    <div>Edit
      <div class="dropdown">
        <div onclick="undo()">Undo <span class="shortcut">Ctrl+Z</span></div>
        <div onclick="redo()">Redo <span class="shortcut">Ctrl+Y</span></div>
        <hr>
        <div onclick="duplicateSelected()">Duplicate <span class="shortcut">Shift+D</span></div>
        <div onclick="deleteSelected()">Delete <span class="shortcut">X</span></div>
        <div onclick="selectAll()">Select All <span class="shortcut">A</span></div>
      </div>
    </div>
    <div>Object
      <div class="dropdown">
        <div onclick="setTransformMode('translate')">Move <span class="shortcut">G</span></div>
        <div onclick="setTransformMode('rotate')">Rotate <span class="shortcut">R</span></div>
        <div onclick="setTransformMode('scale')">Scale <span class="shortcut">S</span></div>
        <hr>
        <div onclick="addPrimitive('cube')">Add Cube</div>
        <div onclick="addPrimitive('sphere')">Add Sphere</div>
        <div onclick="addPrimitive('cylinder')">Add Cylinder</div>
        <div onclick="addPrimitive('plane')">Add Plane</div>
      </div>
    </div>
    <div>View
      <div class="dropdown">
        <div onclick="frameSelected()">Frame Selected <span class="shortcut">.</span></div>
        <div onclick="setShadingMode('wireframe')">Wireframe</div>
        <div onclick="setShadingMode('solid')">Solid</div>
      </div>
    </div>
  </div>
</div>

<div id="container">
  <input type="file" id="importFile" accept=".gltf,.glb,.obj,.stl" style="display:none" onchange="handleImport(event)">
  
  <div class="tool-notification" id="toolNotification"></div>
  
  <div class="color-picker-popup" id="colorPicker">
    <h4>Material Color</h4>
    <div class="control-group">
      <label>Color</label>
      <input type="color" id="materialColor" value="#60a5fa" onchange="updateMaterialColor()">
    </div>
    <div class="control-group">
      <label>Metallic: <span id="metallicVal">0</span></label>
      <input type="range" id="metallic" min="0" max="1" step="0.01" value="0" oninput="updateMaterial()">
    </div>
    <div class="control-group">
      <label>Roughness: <span id="roughnessVal">0.5</span></label>
      <input type="range" id="roughness" min="0" max="1" step="0.01" value="0.5" oninput="updateMaterial()">
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="applyMaterial()">Apply to Selection</button>
  </div>
  
  <div id="canvas-container">
    <div id="loader">Initializing 3D Engine...</div>
    
    <div class="ruler-corner" id="rulerCorner"></div>
    <div class="ruler ruler-h" id="rulerH"></div>
    <div class="ruler ruler-v" id="rulerV"></div>
    
    <canvas id="canvas"></canvas>
  </div>
  
  <div id="floatingToolbar">
    <div class="tool-group">
      <div class="tool-btn active" id="selectTool" title="Select" onclick="setTool('select')">‚¨ö</div>
      <div class="tool-btn" id="moveTool" title="Move" onclick="setTransformMode('translate')">‚ú•</div>
      <div class="tool-btn" id="rotateTool" title="Rotate" onclick="setTransformMode('rotate')">‚Üª</div>
      <div class="tool-btn" id="scaleTool" title="Scale" onclick="setTransformMode('scale')">‚ä°</div>
    </div>
    <div class="tool-group">
      <div class="tool-btn" id="colorTool" title="Color" onclick="showColorPicker()">‚óê</div>
    </div>
  </div>
  
  <div class="panel-dock" id="panelDock">
    <button id="dockToggle">‚óÄ</button>
    
    <div class="panel-tabs">
      <button class="panel-tab active" data-panel="properties">Properties</button>
      <button class="panel-tab" data-panel="outliner">Outliner</button>
      <button class="panel-tab" data-panel="materials">Materials</button>
      <button class="panel-tab" data-panel="world">World</button>
    </div>
    
    <div class="panel-content">
      <div id="panel-properties" class="panel-section active">
        <h3>Transform</h3>
        <div class="control-row">
          <div class="control-group" style="flex:1">
            <label>Position X</label>
            <input type="number" id="posX" step="0.1" onchange="updateTransform()">
          </div>
          <div class="control-group" style="flex:1">
            <label>Y</label>
            <input type="number" id="posY" step="0.1" onchange="updateTransform()">
          </div>
          <div class="control-group" style="flex:1">
            <label>Z</label>
            <input type="number" id="posZ" step="0.1" onchange="updateTransform()">
          </div>
        </div>
        <div class="control-row">
          <div class="control-group" style="flex:1">
            <label>Rotation X</label>
            <input type="number" id="rotX" step="1" onchange="updateTransform()">
          </div>
          <div class="control-group" style="flex:1">
            <label>Y</label>
            <input type="number" id="rotY" step="1" onchange="updateTransform()">
          </div>
          <div class="control-group" style="flex:1">
            <label>Z</label>
            <input type="number" id="rotZ" step="1" onchange="updateTransform()">
          </div>
        </div>
        <div class="control-row">
          <div class="control-group" style="flex:1">
            <label>Scale X</label>
            <input type="number" id="scaleX" step="0.1" onchange="updateTransform()">
          </div>
          <div class="control-group" style="flex:1">
            <label>Y</label>
            <input type="number" id="scaleY" step="0.1" onchange="updateTransform()">
          </div>
          <div class="control-group" style="flex:1">
            <label>Z</label>
            <input type="number" id="scaleZ" step="0.1" onchange="updateTransform()">
          </div>
        </div>
      </div>
      
      <div id="panel-outliner" class="panel-section">
        <div class="control-row" style="margin-bottom: 1rem;">
          <button class="btn btn-sm" onclick="selectAll()">Select All</button>
          <button class="btn btn-sm" onclick="deleteSelected()">Delete</button>
        </div>
        <div id="outlinerList"></div>
      </div>
      
      <div id="panel-materials" class="panel-section">
        <div class="control-row" style="margin-bottom: 1rem;">
          <button class="btn btn-sm btn-primary" onclick="createMaterial()">+ New Material</button>
          <button class="btn btn-sm" onclick="showColorPicker()">Edit</button>
        </div>
        <div id="materialList"></div>
      </div>
      
      <div id="panel-world" class="panel-section">
        <h3>World</h3>
        <div class="control-group">
          <label>Background Color</label>
          <input type="color" id="worldColor" value="#1a1a2e" onchange="updateWorld()">
        </div>
        <div class="control-group">
          <label>Ambient Light: <span id="ambientVal">0.5</span></label>
          <input type="range" id="ambientIntensity" min="0" max="2" step="0.1" value="0.5" oninput="updateWorld()">
        </div>
      </div>
    </div>
  </div>
</div>

<div class="status-bar">
  <div class="left">
    <span id="statusMode">Mode: Object</span>
    <span id="statusSelection">Selected: 0 objects</span>
    <span id="statusTool">Tool: Select</span>
  </div>
  <div class="right">
    <span id="statusFPS">FPS: 60</span>
    <span id="statusCursor">Cursor: 0.0, 0.0, 0.0</span>
  </div>
</div>

<script>
// Three.js - loading from CDN
</script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/examples/js/controls/TransformControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/examples/js/loaders/OBJLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/examples/js/loaders/STLLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/examples/js/exporters/GLTFExporter.js"></script>

<script>
// Global variables
let scene, camera, renderer, controls, transformControls;
let selectedObjects = [];
let currentTool = 'select';
let raycaster, mouse;
let gridHelper, axesHelper;
let ambientLight, directionalLight;
let undoStack = [];
let redoStack = [];
let objectCounter = 0;
let materials = [];
let lastTime = performance.now();
let frameCount = 0;
let fps = 60;

// Initialization
function init() {
  console.log('Initializing 3D Editor...');
  
  try {
    const canvas = document.getElementById('canvas');
    const container = document.getElementById('canvas-container');
    
    if (!canvas) {
      console.error('Canvas element not found!');
      return;
    }

    // Scene
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1a2e);

    // Camera
    camera = new THREE.PerspectiveCamera(
      75,
      container.clientWidth / container.clientHeight,
      0.1,
      1000
    );
    camera.position.set(5, 5, 5);
    camera.lookAt(0, 0, 0);

    // Renderer
    renderer = new THREE.WebGLRenderer({
      canvas: canvas,
      antialias: true,
      preserveDrawingBuffer: true
    });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    // Orbit Controls
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.screenSpacePanning = true;
    controls.minDistance = 0.1;
    controls.maxDistance = 500;

    // Transform Controls
    transformControls = new THREE.TransformControls(camera, renderer.domElement);
    transformControls.addEventListener('dragging-changed', (event) => {
      controls.enabled = !event.value;
    });
    transformControls.addEventListener('change', () => {
      updateProperties();
    });
    scene.add(transformControls);

    // Raycaster
    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();

    // Grid Helper
    gridHelper = new THREE.GridHelper(20, 20, 0x60a5fa, 0x334155);
    scene.add(gridHelper);

    // Axes Helper
    axesHelper = new THREE.AxesHelper(5);
    scene.add(axesHelper);

    // Lighting
    ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);

    directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(5, 10, 7);
    directionalLight.castShadow = true;
    directionalLight.shadow.mapSize.width = 2048;
    directionalLight.shadow.mapSize.height = 2048;
    scene.add(directionalLight);

    // Event Listeners
    window.addEventListener('resize', onWindowResize);
    canvas.addEventListener('mousedown', onMouseDown);
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseup', onMouseUp);
    canvas.addEventListener('wheel', onMouseWheel, { passive: false });
    canvas.addEventListener('contextmenu', onContextMenu);
    document.addEventListener('keydown', onKeyDown);
    document.addEventListener('keyup', onKeyUp);

    // Touch support
    canvas.addEventListener('touchstart', onTouchStart, { passive: false });
    canvas.addEventListener('touchmove', onTouchMove, { passive: false });
    canvas.addEventListener('touchend', onTouchEnd);

    // Initialize panels
    initPanelTabs();
    updateOutliner();

    // Start animation loop
    animate();

    // Add default cube
    addPrimitive('cube');

    // Hide loader
    setTimeout(() => {
      const loader = document.getElementById('loader');
      if (loader) {
        loader.style.display = 'none';
      }
      console.log('3D Editor initialized successfully!');
    }, 500);

    saveState();
    
  } catch (error) {
    console.error('Initialization error:', error);
    const loader = document.getElementById('loader');
    if (loader) {
      loader.textContent = 'Error: ' + error.message;
      loader.style.color = '#ef4444';
    }
  }
}

// Animation Loop
function animate() {
  requestAnimationFrame(animate);
  
  try {
    controls.update();
    renderer.render(scene, camera);

    // FPS counter
    frameCount++;
    const currentTime = performance.now();
    if (currentTime - lastTime >= 1000) {
      fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
      const statusFPS = document.getElementById('statusFPS');
      if (statusFPS) {
        statusFPS.textContent = `FPS: ${fps}`;
      }
      frameCount = 0;
      lastTime = currentTime;
    }

    // Update cursor position
    updateCursorDisplay();
  } catch (error) {
    console.error('Animation error:', error);
  }
}

// Window Resize
function onWindowResize() {
  const canvas = document.getElementById('canvas');
  const container = document.getElementById('canvas-container');
  
  if (container && camera && renderer) {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  }
}

// Mouse Events
function onMouseDown(event) {
  if (event.button === 2) return;

  const canvas = document.getElementById('canvas');
  const rect = canvas.getBoundingClientRect();

  mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);

  if (currentTool === 'select' || currentTool === 'move' || currentTool === 'rotate' || currentTool === 'scale') {
    const intersects = raycaster.intersectObjects(scene.children, true);
    
    if (intersects.length > 0) {
      let obj = intersects[0].object;
      
      while (obj.parent && obj.parent.type !== 'Scene') {
        obj = obj.parent;
      }
      
      if (!event.shiftKey) {
        deselectAll();
      }
      
      selectObject(obj);
      
      if (selectedObjects.length > 0) {
        transformControls.attach(selectedObjects[0]);
      }
    } else {
      deselectAll();
      transformControls.detach();
    }
  }
}

function onMouseMove(event) {
  const canvas = document.getElementById('canvas');
  const rect = canvas.getBoundingClientRect();

  mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

  updateCursorDisplay();
}

function onMouseUp(event) {
  saveState();
}

function onMouseWheel(event) {
  event.preventDefault();
}

function onContextMenu(event) {
  event.preventDefault();
  showContextMenu(event.clientX, event.clientY);
}

// Touch Events
function onTouchStart(event) {
  if (event.touches.length === 1) {
    const touch = event.touches[0];
    const mouseEvent = new MouseEvent('mousedown', {
      clientX: touch.clientX,
      clientY: touch.clientY,
      button: 0
    });
    onMouseDown(mouseEvent);
  }
}

function onTouchMove(event) {
  event.preventDefault();
  if (event.touches.length === 1) {
    const touch = event.touches[0];
    const mouseEvent = new MouseEvent('mousemove', {
      clientX: touch.clientX,
      clientY: touch.clientY
    });
    onMouseMove(mouseEvent);
  }
}

function onTouchEnd(event) {
  const mouseEvent = new MouseEvent('mouseup', {});
  onMouseUp(mouseEvent);
}

// Keyboard Events
function onKeyDown(event) {
  if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;

  if (event.key === 'g' || event.key === 'G') {
    setTransformMode('translate');
  } else if (event.key === 'r' || event.key === 'R') {
    setTransformMode('rotate');
  } else if (event.key === 's' || event.key === 'S') {
    setTransformMode('scale');
  } else if (event.key === 'x' || event.key === 'X') {
    deleteSelected();
  } else if (event.key === 'a' || event.key === 'A') {
    selectAll();
  } else if (event.shiftKey && (event.key === 'D' || event.key === 'd')) {
    event.preventDefault();
    duplicateSelected();
  } else if (event.ctrlKey || event.metaKey) {
    if (event.key === 'z' || event.key === 'Z') {
      event.preventDefault();
      undo();
    } else if (event.key === 'y' || event.key === 'Y') {
      event.preventDefault();
      redo();
    } else if (event.key === 's' || event.key === 'S') {
      event.preventDefault();
      saveScene();
    }
  } else if (event.key === '.') {
    frameSelected();
  }
}

function onKeyUp(event) {}

// Tool & Mode Management
function setTool(tool) {
  currentTool = tool;
  
  document.querySelectorAll('.tool-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  const toolBtn = document.getElementById(tool + 'Tool');
  if (toolBtn) {
    toolBtn.classList.add('active');
  }
  
  const statusTool = document.getElementById('statusTool');
  if (statusTool) {
    statusTool.textContent = `Tool: ${tool.charAt(0).toUpperCase() + tool.slice(1)}`;
  }
  
  showNotification(tool.charAt(0).toUpperCase() + tool.slice(1) + ' Tool');
}

function setTransformMode(mode) {
  if (!transformControls) return;
  
  transformControls.setMode(mode);
  
  document.querySelectorAll('.tool-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  let toolName = '';
  if (mode === 'translate') toolName = 'move';
  else if (mode === 'rotate') toolName = 'rotate';
  else if (mode === 'scale') toolName = 'scale';
  
  const toolBtn = document.getElementById(toolName + 'Tool');
  if (toolBtn) {
    toolBtn.classList.add('active');
  }
  
  currentTool = toolName;
  const statusTool = document.getElementById('statusTool');
  if (statusTool) {
    statusTool.textContent = `Tool: ${toolName.charAt(0).toUpperCase() + toolName.slice(1)}`;
  }
  
  showNotification(toolName.charAt(0).toUpperCase() + toolName.slice(1));
}

// Object Selection
function selectObject(obj) {
  if (!obj || obj.type === 'GridHelper' || obj.type === 'AxesHelper' || obj.type === 'TransformControls') {
    return;
  }
  
  if (!selectedObjects.includes(obj)) {
    selectedObjects.push(obj);
    
    if (obj.material) {
      if (!obj.userData.originalMaterial) {
        obj.userData.originalMaterial = obj.material.clone();
      }
      obj.material = obj.material.clone();
      obj.material.emissive = new THREE.Color(0x22c55e);
      obj.material.emissiveIntensity = 0.2;
    }
    
    updateProperties();
    updateOutliner();
  }
}

function deselectAll() {
  selectedObjects.forEach(obj => {
    if (obj.userData.originalMaterial) {
      obj.material = obj.userData.originalMaterial;
      delete obj.userData.originalMaterial;
    }
  });
  
  selectedObjects = [];
  if (transformControls) {
    transformControls.detach();
  }
  updateProperties();
  updateOutliner();
}

function selectAll() {
  scene.children.forEach(obj => {
    if (obj.isMesh && obj.type !== 'GridHelper' && obj.type !== 'AxesHelper') {
      selectObject(obj);
    }
  });
}

// Primitive Creation
function addPrimitive(type) {
  let geometry, material, mesh;

  material = new THREE.MeshStandardMaterial({
    color: 0x60a5fa,
    metalness: 0,
    roughness: 0.5
  });

  switch(type) {
    case 'cube':
      geometry = new THREE.BoxGeometry(1, 1, 1);
      break;
    case 'sphere':
      geometry = new THREE.SphereGeometry(0.5, 32, 32);
      break;
    case 'cylinder':
      geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
      break;
    case 'plane':
      geometry = new THREE.PlaneGeometry(1, 1);
      break;
    default:
      geometry = new THREE.BoxGeometry(1, 1, 1);
  }

  mesh = new THREE.Mesh(geometry, material);
  mesh.castShadow = true;
  mesh.receiveShadow = true;
  mesh.name = `${type}_${++objectCounter}`;
  
  scene.add(mesh);
  selectObject(mesh);
  
  if (transformControls) {
    transformControls.attach(mesh);
  }

  updateOutliner();
  saveState();
  
  showNotification(`Added ${type}`);
}

// Object Operations
function duplicateSelected() {
  const newObjects = [];

  selectedObjects.forEach(obj => {
    const clone = obj.clone();
    clone.position.x += 1;
    clone.name = obj.name + '_copy';
    clone.material = obj.material.clone();
    scene.add(clone);
    newObjects.push(clone);
  });

  deselectAll();
  newObjects.forEach(obj => selectObject(obj));

  saveState();
  showNotification('Duplicated');
}

function deleteSelected() {
  selectedObjects.forEach(obj => {
    scene.remove(obj);
    if (obj.geometry) obj.geometry.dispose();
    if (obj.material) obj.material.dispose();
  });

  selectedObjects = [];
  if (transformControls) {
    transformControls.detach();
  }
  updateOutliner();
  saveState();
  showNotification('Deleted');
}

// Materials
function createMaterial() {
  const material = {
    name: `Material_${materials.length + 1}`,
    color: 0x60a5fa,
    metalness: 0,
    roughness: 0.5
  };

  materials.push(material);
  updateMaterialList();
  showNotification('Created Material');
}

function showColorPicker() {
  if (selectedObjects.length === 0) {
    showNotification('Select an object first');
    return;
  }

  const obj = selectedObjects[0];
  if (obj.material) {
    const color = '#' + obj.material.color.getHexString();
    document.getElementById('materialColor').value = color;
    document.getElementById('metallic').value = obj.material.metalness;
    document.getElementById('roughness').value = obj.material.roughness;
    document.getElementById('metallicVal').textContent = obj.material.metalness;
    document.getElementById('roughnessVal').textContent = obj.material.roughness;
  }

  document.getElementById('colorPicker').classList.toggle('active');
}

function updateMaterialColor() {
  const color = document.getElementById('materialColor').value;
  document.getElementById('materialColor').style.backgroundColor = color;
}

function updateMaterial() {
  const metallic = parseFloat(document.getElementById('metallic').value);
  const roughness = parseFloat(document.getElementById('roughness').value);

  document.getElementById('metallicVal').textContent = metallic;
  document.getElementById('roughnessVal').textContent = roughness;
}

function applyMaterial() {
  if (selectedObjects.length === 0) return;

  const color = document.getElementById('materialColor').value;
  const metallic = parseFloat(document.getElementById('metallic').value);
  const roughness = parseFloat(document.getElementById('roughness').value);

  const material = new THREE.MeshStandardMaterial({
    color: color,
    metalness: metallic,
    roughness: roughness
  });

  selectedObjects.forEach(obj => {
    obj.material = material;
  });

  document.getElementById('colorPicker').classList.remove('active');
  saveState();
  showNotification('Material Applied');
}

function updateMaterialList() {
  const list = document.getElementById('materialList');
  if (!list) return;
  
  list.innerHTML = '';

  materials.forEach((mat, index) => {
    const item = document.createElement('div');
    item.className = 'outliner-item';
    item.innerHTML = `
      <span class="icon">‚óê</span>
      <span class="name">${mat.name}</span>
    `;
    list.appendChild(item);
  });
}

// Import/Export
function importModel() {
  document.getElementById('importFile').click();
}

function handleImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    const contents = e.target.result;
    
    if (file.name.endsWith('.gltf') || file.name.endsWith('.glb')) {
      const loader = new THREE.GLTFLoader();
      loader.parse(contents, '', (gltf) => {
        const model = gltf.scene;
        model.name = file.name;
        scene.add(model);
        updateOutliner();
        saveState();
        showNotification('Imported GLTF');
      });
    } else if (file.name.endsWith('.obj')) {
      const loader = new THREE.OBJLoader();
      const model = loader.parse(contents);
      model.name = file.name;
      scene.add(model);
      updateOutliner();
      saveState();
      showNotification('Imported OBJ');
    } else if (file.name.endsWith('.stl')) {
      const loader = new THREE.STLLoader();
      const geometry = loader.parse(contents);
      const material = new THREE.MeshStandardMaterial({ color: 0x60a5fa });
      const mesh = new THREE.Mesh(geometry, material);
      mesh.name = file.name;
      scene.add(mesh);
      updateOutliner();
      saveState();
      showNotification('Imported STL');
    }
  };

  if (file.name.endsWith('.gltf') || file.name.endsWith('.glb') || file.name.endsWith('.obj')) {
    reader.readAsText(file);
  } else {
    reader.readAsArrayBuffer(file);
  }

  event.target.value = '';
}

function exportModel() {
  const format = prompt('Export format (gltf):', 'gltf');

  if (selectedObjects.length === 0) {
    showNotification('Select objects to export');
    return;
  }

  if (format === 'gltf') {
    const exporter = new THREE.GLTFExporter();
    exporter.parse(selectedObjects, (result) => {
      const output = JSON.stringify(result, null, 2);
      const blob = new Blob([output], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'model.gltf';
      a.click();
      URL.revokeObjectURL(url);
      showNotification('Exported GLTF');
    });
  } else {
    showNotification('Export format not implemented');
  }
}

// View Controls
function setShadingMode(mode) {
  scene.traverse((obj) => {
    if (obj.isMesh && obj.material) {
      if (mode === 'wireframe') {
        obj.material.wireframe = true;
      } else {
        obj.material.wireframe = false;
      }
    }
  });

  showNotification(`${mode.charAt(0).toUpperCase() + mode.slice(1)} Shading`);
}

function frameSelected() {
  if (selectedObjects.length === 0) return;
  const box = new THREE.Box3();
  selectedObjects.forEach(obj => {
    box.expandByObject(obj);
  });
  const center = box.getCenter(new THREE.Vector3());
  const size = box.getSize(new THREE.Vector3());
  const maxDim = Math.max(size.x, size.y, size.z);
  if (controls) {
    controls.target.copy(center);
  }
  camera.position.set(
    center.x + maxDim,
    center.y + maxDim,
    center.z + maxDim
  );
  camera.lookAt(center);
  showNotification('Framed Selection');
}

function updateWorld() {
  const color = document.getElementById('worldColor').value;
  const intensity = parseFloat(document.getElementById('ambientIntensity').value);

  if (scene) {
    scene.background = new THREE.Color(color);
  }
  if (ambientLight) {
    ambientLight.intensity = intensity;
  }
  
  const ambientVal = document.getElementById('ambientVal');
  if (ambientVal) {
    ambientVal.textContent = intensity;
  }
}

// Undo/Redo
function saveState() {
  const state = {
    objectCount: scene.children.length,
    timestamp: Date.now()
  };

  undoStack.push(JSON.stringify(state));
  if (undoStack.length > 50) undoStack.shift();
  redoStack = [];
}

function undo() {
  if (undoStack.length <= 1) {
    showNotification('Nothing to undo');
    return;
  }

  redoStack.push(undoStack.pop());
  showNotification('Undo');
}

function redo() {
  if (redoStack.length === 0) {
    showNotification('Nothing to redo');
    return;
  }

  undoStack.push(redoStack.pop());
  showNotification('Redo');
}

function saveScene() {
  showNotification('Scene saved (demo mode)');
}

function newScene() {
  if (confirm('Create new scene? All unsaved changes will be lost.')) {
    const toRemove = [];
    scene.children.forEach(obj => {
      if (obj.isMesh) {
        toRemove.push(obj);
      }
    });
    toRemove.forEach(obj => {
      scene.remove(obj);
      if (obj.geometry) obj.geometry.dispose();
      if (obj.material) obj.material.dispose();
    });
    
    selectedObjects = [];
    if (transformControls) {
      transformControls.detach();
    }
    updateOutliner();
    saveState();
    
    showNotification('New Scene');
  }
}

// UI Updates
function updateProperties() {
  if (selectedObjects.length === 0) {
    document.getElementById('posX').value = '';
    document.getElementById('posY').value = '';
    document.getElementById('posZ').value = '';
    document.getElementById('rotX').value = '';
    document.getElementById('rotY').value = '';
    document.getElementById('rotZ').value = '';
    document.getElementById('scaleX').value = '';
    document.getElementById('scaleY').value = '';
    document.getElementById('scaleZ').value = '';
    return;
  }

  const obj = selectedObjects[0];
  document.getElementById('posX').value = obj.position.x.toFixed(2);
  document.getElementById('posY').value = obj.position.y.toFixed(2);
  document.getElementById('posZ').value = obj.position.z.toFixed(2);
  document.getElementById('rotX').value = THREE.MathUtils.radToDeg(obj.rotation.x).toFixed(1);
  document.getElementById('rotY').value = THREE.MathUtils.radToDeg(obj.rotation.y).toFixed(1);
  document.getElementById('rotZ').value = THREE.MathUtils.radToDeg(obj.rotation.z).toFixed(1);
  document.getElementById('scaleX').value = obj.scale.x.toFixed(2);
  document.getElementById('scaleY').value = obj.scale.y.toFixed(2);
  document.getElementById('scaleZ').value = obj.scale.z.toFixed(2);
}

function updateTransform() {
  if (selectedObjects.length === 0) return;

  const obj = selectedObjects[0];
  obj.position.x = parseFloat(document.getElementById('posX').value) || 0;
  obj.position.y = parseFloat(document.getElementById('posY').value) || 0;
  obj.position.z = parseFloat(document.getElementById('posZ').value) || 0;
  obj.rotation.x = THREE.MathUtils.degToRad(parseFloat(document.getElementById('rotX').value) || 0);
  obj.rotation.y = THREE.MathUtils.degToRad(parseFloat(document.getElementById('rotY').value) || 0);
  obj.rotation.z = THREE.MathUtils.degToRad(parseFloat(document.getElementById('rotZ').value) || 0);
  obj.scale.x = parseFloat(document.getElementById('scaleX').value) || 1;
  obj.scale.y = parseFloat(document.getElementById('scaleY').value) || 1;
  obj.scale.z = parseFloat(document.getElementById('scaleZ').value) || 1;

  saveState();
}

function updateOutliner() {
  const list = document.getElementById('outlinerList');
  if (!list) return;
  
  list.innerHTML = '';

  scene.children.forEach(obj => {
    if (obj.isMesh) {
      const item = document.createElement('div');
      item.className = 'outliner-item' + (selectedObjects.includes(obj) ? ' selected' : '');
      item.innerHTML = `
        <span class="icon">üì¶</span>
        <span class="name">${obj.name}</span>
      `;
      item.onclick = () => {
        deselectAll();
        selectObject(obj);
        if (transformControls) {
          transformControls.attach(obj);
        }
      };
      list.appendChild(item);
    }
  });

  const statusSelection = document.getElementById('statusSelection');
  if (statusSelection) {
    statusSelection.textContent = `Selected: ${selectedObjects.length} objects`;
  }
}

function updateCursorDisplay() {
  if (!raycaster || !mouse || !camera || !scene) return;
  
  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(scene.children, true);

  if (intersects.length > 0) {
    const point = intersects[0].point;
    const statusCursor = document.getElementById('statusCursor');
    if (statusCursor) {
      statusCursor.textContent = `Cursor: ${point.x.toFixed(1)}, ${point.y.toFixed(1)}, ${point.z.toFixed(1)}`;
    }
  }
}

// Notifications
function showNotification(text) {
  const notification = document.getElementById('toolNotification');
  if (!notification) return;
  
  notification.textContent = text;
  notification.classList.remove('show');

  requestAnimationFrame(() => {
    notification.classList.add('show');
  });

  setTimeout(() => {
    notification.classList.remove('show');
  }, 1500);
}

// Context Menu
function showContextMenu(x, y) {
  const menu = document.createElement('div');
  menu.className = 'context-menu';
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  menu.innerHTML = `
    <div onclick="duplicateSelected()">Duplicate</div>
    <div onclick="deleteSelected()">Delete</div>
    <hr>
    <div onclick="setShadingMode('wireframe')">Wireframe</div>
    <div onclick="setShadingMode('solid')">Solid</div>
  `;

  document.body.appendChild(menu);

  const closeMenu = () => {
    menu.remove();
    document.removeEventListener('click', closeMenu);
  };

  setTimeout(() => {
    document.addEventListener('click', closeMenu);
  }, 0);
}

// Panel Tabs
function initPanelTabs() {
  document.querySelectorAll('.panel-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel-section').forEach(s => s.classList.remove('active'));
      
      this.classList.add('active');
      const panelId = 'panel-' + this.dataset.panel;
      const panelSection = document.getElementById(panelId);
      if (panelSection) {
        panelSection.classList.add('active');
      }
    });
  });

  const dock = document.getElementById('panelDock');
  const dockToggle = document.getElementById('dockToggle');
  let dockVisible = true;

  function toggleDock() {
    dockVisible = !dockVisible;
    dock.style.display = dockVisible ? 'flex' : 'none';
    dockToggle.textContent = dockVisible ? '‚óÄ' : '‚ñ∂';
  }

  dockToggle.onclick = toggleDock;
}

// Expose functions globally
window.setTool = setTool;
window.setTransformMode = setTransformMode;
window.addPrimitive = addPrimitive;
window.duplicateSelected = duplicateSelected;
window.deleteSelected = deleteSelected;
window.createMaterial = createMaterial;
window.showColorPicker = showColorPicker;
window.updateMaterialColor = updateMaterialColor;
window.updateMaterial = updateMaterial;
window.applyMaterial = applyMaterial;
window.importModel = importModel;
window.handleImport = handleImport;
window.exportModel = exportModel;
window.setShadingMode = setShadingMode;
window.frameSelected = frameSelected;
window.updateWorld = updateWorld;
window.undo = undo;
window.redo = redo;
window.saveScene = saveScene;
window.newScene = newScene;
window.updateTransform = updateTransform;
window.selectAll = selectAll;

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>
