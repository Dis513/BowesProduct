<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Retexture Pro ‚Äì BowesProduct</title>
  <script async src="https://unpkg.com/es-module-shims@1.8.2/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
    }
  }
  </script>
  <style>
  *, *::before, *::after { box-sizing: border-box; }
  html, body { margin: 0; height: 100%; background: #020617; color: white; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; -webkit-font-smoothing: antialiased; }

  .site-header {
  position: sticky; top: 0; z-index: 1000; background: rgba(2,6,23,0.95); border-bottom: 1px solid #1e293b; backdrop-filter: blur(10px);
  }
  .header-inner { max-width: 1200px; margin: 0 auto; padding: 0.6rem 1rem; display: flex; align-items: center; justify-content: space-between; }
  .header-left { display: flex; align-items: center; gap: 1.6rem; }
  .logo a { font-size: 1.3rem; font-weight: 700; color: white; text-decoration: none; white-space: nowrap; }
  .main-nav { display: flex; gap: 1.4rem; }
  .main-nav a { color: #e5e7eb; text-decoration: none; font-size: 0.95rem; }
  .main-nav a:hover, .main-nav a.active { color: #60a5fa; }
  .header-right { display: flex; align-items: center; gap: 0.8rem; min-height: 44px; }
  #profilePic { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #60a5fa; object-fit: cover; display: none; }
  .login-btn { padding: 0.45rem 1.1rem; border-radius: 999px; border: 1.5px solid #60a5fa; background: transparent; color: #60a5fa; font-size: 0.95rem; cursor: pointer; }
  #levelInfo { display: none; width: 140px; font-size: 0.8rem; color: #cbd5e1; }
  #levelText { white-space: nowrap; }
  #xpOuter { width: 100%; height: 5px; background: #1e293b; border-radius: 3px; margin-top: 4px; }
  #xpBar { height: 100%; width: 0%; background: #60a5fa; border-radius: 3px; transition: width 0.35s ease; }

  @media (max-width: 768px) {
  .header-inner { flex-direction: column; align-items: stretch; gap: 8px; }
  .header-left { justify-content: space-between; }
  .header-right { justify-content: space-between; width: 100%; }
  #levelInfo { width: 100%; }
  }

  #container { position: relative; width: 100%; height: 100%; padding-top: 70px; padding-bottom: 80px; }
  #canvas { display: block; width: 100%; height: 100%; touch-action: none; outline: none; }

  .panel {
  position: absolute;
  top: 90px;
  right: 20px;
  width: 380px;
  max-height: calc(100vh - 220px);
  background: rgba(2, 6, 23, 0.95);
  border: 1px solid #1e293b;
  border-radius: 12px;
  padding: 1.5rem;
  overflow-y: auto;
  z-index: 20;
  backdrop-filter: blur(10px);
  transition: transform 0.3s ease;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  }
  .panel.hidden { transform: translateX(420px); }

  #panelToggle {
  position: absolute;
  left: -60px;
  top: 50%;
  transform: translateY(-50%);
  width: 60px;
  height: 110px;
  background: rgba(2, 6, 23, 0.98);
  border: 1px solid #1e293b;
  border-right: none;
  border-radius: 20px 0 0 20px;
  color: #60a5fa;
  font-size: 2.4rem;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 21;
  backdrop-filter: blur(12px);
  box-shadow: 0 6px 30px rgba(0,0,0,0.5);
  transition: all 0.3s ease;
  }
  #panelToggle:hover { background: rgba(30, 41, 59, 0.98); color: white; transform: translateY(-50%) translateX(-4px); }

  @media (max-width: 900px) {
  .panel {
  position: absolute;
  top: auto;
  right: 0;
  left: 0;
  bottom: 0;
  width: 100%;
  height: 85vh;
  max-height: none;
  border-radius: 20px 20px 0 0;
  transform: translateY(calc(100% - 60px));
  transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
  padding-top: 20px;
  padding-bottom: 120px;
  z-index: 1100;
  overflow-y: auto;
  background: rgba(2, 6, 23, 0.95);
  border: 1px solid #1e293b;
  border-bottom: none;
  box-shadow: 0 -5px 25px rgba(0,0,0,0.5);
  }
  .panel.visible {
  transform: translateY(0);
  }

  #panelToggle { display: none; }
  }

  #mobilePanelToggle {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 160px;
  height: 44px;
  background: rgba(2, 6, 23, 0.9);
  border: 1px solid #60a5fa;
  border-radius: 22px;
  color: #60a5fa;
  font-size: 0.9rem;
  font-weight: 700;
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 1200;
  backdrop-filter: blur(12px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.6);
  transition: background 0.2s, transform 0.1s;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  }
  #mobilePanelToggle:active { transform: translateX(-50%) scale(0.96); }
  #mobilePanelToggle::before {
  content: '';
  position: absolute;
  top: -6px;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 4px;
  background: #94a3b8;
  border-radius: 2px;
  opacity: 0.5;
  }

  #floatingControls {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 16px;
  z-index: 1200;
  pointer-events: none;
  }
  #floatingControls > div {
  pointer-events: auto;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  border: 2px solid #60a5fa;
  background: rgba(2, 6, 23, 0.9);
  backdrop-filter: blur(12px);
  color: #60a5fa;
  font-size: 1.8rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(0,0,0,0.6);
  transition: all 0.2s;
  }
  #floatingControls > div:hover { transform: translateY(-4px); }
  #floatingControls > div.active {
  background: rgba(34, 197, 94, 0.3);
  color: white;
  border-color: #22c55e;
  }
  #floaterColorWrapper {
  position: relative;
  }
  #floaterColor {
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
  }
  #floaterColorDisplay {
  position: absolute;
  inset: 4px;
  border-radius: 50%;
  background: #ff4444;
  pointer-events: none;
  border: 2px solid #60a5fa;
  }

  .panel h2 { color: #60a5fa; margin: 1.5rem 0 1rem; font-size: 1.1rem; border-bottom: 1px solid #1e293b; padding-bottom: 0.5rem; }
  .control-group { margin-bottom: 1.2rem; }
  label { display: block; font-size: 0.9rem; color: #e5e7eb; margin-bottom: 0.4rem; }
  input, select, button { width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #1f2937; background: #020617; color: #e5e7eb; font: inherit; }
  input[type="range"] { padding: 0.3rem 0; accent-color: #60a5fa; }
  input[type="color"] { height: 44px; padding: 0.2rem; }
  button { background: #60a5fa; border: none; color: white; cursor: pointer; margin-top: 0.8rem; font-weight: 600; position: relative; z-index: 30; transition: background 0.2s; }
  button:hover { background: #3b82f6; }

  #layersList { list-style: none; padding: 0; margin: 0 0 1rem; }
  .layer-item {
  display: flex; align-items: center; gap: 8px; padding: 10px; background: #0f172a; border-radius: 8px; margin-bottom: 8px; cursor: grab; border: 1px solid transparent;
  }
  .layer-item.active { background: #1e293b; border-color: #60a5fa; }
  .layer-visibility { font-size: 1.3rem; cursor: pointer; }
  .layer-color { width: 36px; height: 36px; border: none; border-radius: 6px; cursor: pointer; padding: 0; }
  .layer-delete { color: #ef4444; cursor: pointer; font-size: 1.2rem; }

  #brushCursor, #eyedropperCursor { position: fixed; pointer-events: none; transform: translate(-50%, -50%); z-index: 9999; display: none; }
  #brushCursor { border: 2px solid rgba(255,255,255,0.8); border-radius: 50%; background: rgba(255,68,68,0.2); transition: all 0.1s; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
  #eyedropperCursor { width: 44px; height: 44px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%2360a5fa" stroke-width="3"><path d="M21 11l-8-8-2 2 8 8 2-2zM4 20l7-7"/></svg>') center/32px no-repeat; }

  #paintToggle.active { background: #f87171; }
  #eyedropperToggle.active { background: #7c3aed; border: 1px solid white; }
  #maskToggle.active { background: #ec4899; border: 1px solid white; }

  #loader {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  color: #60a5fa; font-size: 1.5rem; font-weight: bold; pointer-events: none; z-index: 0;
  text-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  </style>
</head>
<body>
<header class="site-header">
  <div class="header-inner">
  <div class="header-left">
  <div class="logo"><a href="index.html">BowesProduct</a></div>
  <nav class="main-nav">
  <a href="index.html">Home</a>
  <a href="models.html">Models</a>
  <a href="retexture.html" class="active">Retexture</a>
  </nav>
  </div>
  <div class="header-right">
  <button id="authBtn" class="login-btn">Login</button>
  </div>
  </div>
</header>

<div id="container">
  <div id="loader">Drop a GLB/GLTF model here or use Upload</div>
  <canvas id="canvas"></canvas>
  <div id="brushCursor"></div>
  <div id="eyedropperCursor"></div>

  <div id="floatingControls">
    <div id="floaterPaint">üñå</div>
    <div id="floaterEye">üé®</div>
    <div id="floaterColorWrapper">
      <input type="color" id="floaterColor" value="#ff4444">
      <div id="floaterColorDisplay"></div>
    </div>
  </div>

  <div class="panel visible" id="panel">
    <button id="panelToggle">‚Üê</button>

    <div style="padding:0.8rem;background:rgba(30,41,59,0.4);border-radius:8px;margin-bottom:1rem;font-size:0.85rem;line-height:1.4;border:1px solid #334155;">
    <strong style="color:#60a5fa">Controls:</strong><br>
    ‚Ä¢ Drag to rotate ‚Ä¢ Scroll to zoom<br>
    ‚Ä¢ <b>Paint Mode:</b> Paint directly on mesh<br>
    ‚Ä¢ <b>Mask Mode:</b> Paint to hide parts<br>
    ‚Ä¢ PC: Hold Alt to Sample ‚Ä¢ Mobile: Use Eyedropper<br>
    ‚Ä¢ Ctrl+Z/Y Undo/Redo
    </div>

    <h2>Model</h2>
    <div class="control-group">
    <label for="uploadModel">Upload GLB/GLTF</label>
    <input type="file" id="uploadModel" accept=".glb,.gltf">
    </div>

    <h2>Painting Tools</h2>
    <div class="control-group">
    <label for="paintColor">Brush Color</label>
    <input type="color" id="paintColor" value="#ff4444">
    </div>
    <div class="control-group">
    <label for="brushSize">Brush Size <span id="brushSizeVal">0.10</span></label>
    <input type="range" id="brushSize" min="0.01" max="1.0" step="0.01" value="0.1">
    </div>
    <button id="paintToggle">Activate Paint Mode</button>
    <button id="eyedropperToggle">Eyedropper Tool</button>
    <button id="maskToggle">Mask Mode (Paint Invisibility)</button>

    <h2>Export</h2>
    <button id="exportBtn">Export Modified GLB</button>
    <div id="exportStatus"></div>
  </div>
</div>

<div id="mobilePanelToggle"><span>‚ñ≤ Controls</span></div>

<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
  import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
  import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

  const canvas = document.getElementById('canvas');
  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, preserveDrawingBuffer: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.toneMapping = THREE.NoToneMapping;
  renderer.outputColorSpace = THREE.SRGBColorSpace;

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x020617);
  scene.add(new THREE.AmbientLight(0xffffff, 2.5));
  const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
  dirLight.position.set(5, 10, 7);
  scene.add(dirLight);

  const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
  camera.position.set(3, 2, 5);

  const controls = new OrbitControls(camera, canvas);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.touches = { ONE: THREE.TOUCH.ROTATE, TWO: THREE.TOUCH.DOLLY_PAN };

  const pmremGenerator = new THREE.PMREMGenerator(renderer);
  pmremGenerator.compileEquirectangularShader();
  let currentEnvMap = null;

  function loadEnvironment(url) {
    if (url === 'neutral') {
      scene.environment = null;
      if (currentEnvMap) currentEnvMap.dispose();
      return;
    }
    new RGBELoader().load(url, (tex) => {
      const envMap = pmremGenerator.fromEquirectangular(tex).texture;
      scene.environment = envMap;
      tex.dispose();
      if (currentEnvMap) currentEnvMap.dispose();
      currentEnvMap = envMap;
    });
  }
  loadEnvironment('neutral');

  let currentModel = null;
  let modelSize = 1;
  let paintedGeometries = [];
  let paintColor = new THREE.Color('#ff4444');
  let brushSize = 0.1;
  let brushShape = 'soft-circle';
  let paintModeActive = false;
  let eyedropperActive = false;
  let maskMode = false;

  const layers = [];
  let currentLayerIndex = 0;
  let layerData = {};
  let globalMaskData = {};

  const undoStack = [];
  const redoStack = [];
  const MAX_UNDO = 30;

  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');

  function saveState() {
    if (paintedGeometries.length === 0) return;
    const state = {
      layers: layers.map(l => ({ color: l.color.clone(), opacity: l.opacity, blendMode: l.blendMode, visible: l.visible, name: l.name })),
      layerData: JSON.parse(JSON.stringify(layerData)),
      globalMaskData: JSON.parse(JSON.stringify(globalMaskData))
    };
    undoStack.push(state);
    if (undoStack.length > MAX_UNDO) undoStack.shift();
    redoStack.length = 0;
    undoBtn.disabled = false;
    redoBtn.disabled = true;
  }

  function undo() {
    if (undoStack.length === 0) return;
    redoStack.push({
      layers: layers.map(l => ({ color: l.color.clone(), opacity: l.opacity, blendMode: l.blendMode, visible: l.visible, name: l.name })),
      layerData: JSON.parse(JSON.stringify(layerData)),
      globalMaskData: JSON.parse(JSON.stringify(globalMaskData))
    });
    const state = undoStack.pop();
    restoreState(state);
    undoBtn.disabled = undoStack.length === 0;
    redoBtn.disabled = false;
  }

  function redo() {
    if (redoStack.length === 0) return;
    undoStack.push({
      layers: layers.map(l => ({ color: l.color.clone(), opacity: l.opacity, blendMode: l.blendMode, visible: l.visible, name: l.name })),
      layerData: JSON.parse(JSON.stringify(layerData)),
      globalMaskData: JSON.parse(JSON.stringify(globalMaskData))
    });
    const state = redoStack.pop();
    restoreState(state);
    redoBtn.disabled = redoStack.length === 0;
    undoBtn.disabled = false;
  }

  function restoreState(state) {
    layers.length = 0;
    state.layers.forEach(ld => layers.push({ color: ld.color, opacity: ld.opacity, blendMode: ld.blendMode, visible: ld.visible, name: ld.name }));
    layerData = JSON.parse(JSON.stringify(state.layerData));

    const newMaskData = {};
    if (state.globalMaskData) {
      Object.keys(state.globalMaskData).forEach(key => {
        const old = state.globalMaskData[key];
        const arr = new Float32Array(old.length);
        arr.set(old);
        newMaskData[key] = arr;
      });
    }
    globalMaskData = newMaskData;

    updateLayersUI();
    updateAllGeometries();
  }

  undoBtn.onclick = undo;
  redoBtn.onclick = redo;
  window.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
    if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
  });

  const brushCursor = document.getElementById('brushCursor');
  const eyedropperCursor = document.getElementById('eyedropperCursor');
  const exportStatus = document.getElementById('exportStatus');
  const maskToggle = document.getElementById('maskToggle');
  const clearMaskBtn = document.getElementById('clearMask');
  const loader = document.getElementById('loader');

  const panel = document.getElementById('panel');
  const panelToggle = document.getElementById('panelToggle');
  const mobilePanelToggle = document.getElementById('mobilePanelToggle');
  let panelVisible = true;

  function togglePanel() {
    if (window.innerWidth > 900) return;

    panelVisible = !panelVisible;
    panel.classList.toggle('hidden', !panelVisible);
    panel.classList.toggle('visible', panelVisible);
    const span = mobilePanelToggle.querySelector('span');
    if(span) span.textContent = panelVisible ? '‚ñº Hide Controls' : '‚ñ≤ Controls';
    updateFloatingControls();
  }

  panelToggle.onclick = togglePanel;
  mobilePanelToggle.onclick = (e) => {
    e.stopPropagation();
    togglePanel();
  };

  function updatePanelMode() {
    if (window.innerWidth <= 900) {
      mobilePanelToggle.style.display = 'flex';
      panelToggle.style.display = 'none';
    } else {
      mobilePanelToggle.style.display = 'none';
      panelToggle.style.display = 'flex';
      panel.classList.remove('hidden');
      panel.classList.add('visible');
    }
    updateFloatingControls();
  }
  updatePanelMode();
  window.addEventListener('resize', updatePanelMode);

  canvas.addEventListener('touchstart', (e) => {
    if (window.innerWidth <= 900 && panelVisible && !paintModeActive && !maskMode && e.touches.length === 1) {
      const touch = e.touches[0];
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      if (target === canvas || target.id === 'container') {
        e.preventDefault();
        togglePanel();
      }
    }
  });

  const floatingControls = document.getElementById('floatingControls');
  const floaterPaint = document.getElementById('floaterPaint');
  const floaterEye = document.getElementById('floaterEye');
  const floaterColor = document.getElementById('floaterColor');
  const floaterColorDisplay = document.getElementById('floaterColorDisplay');

  floaterPaint.onclick = () => {
    document.getElementById('paintToggle').click();
  };

  floaterEye.onclick = () => {
    document.getElementById('eyedropperToggle').click();
  };

  floaterColor.oninput = (e) => {
    const newColor = e.target.value;
    paintColor.set(newColor);
    document.getElementById('paintColor').value = newColor;
    layers[currentLayerIndex].color.copy(paintColor);
    floaterColorDisplay.style.background = newColor;
    updateLayersUI();
  };

  function updateFloatingControls() {
    const isMobile = window.innerWidth <= 900;
    floatingControls.style.display = isMobile ? (panelVisible ? 'none' : 'flex') : 'flex';

    floaterPaint.classList.toggle('active', paintModeActive);
    floaterEye.classList.toggle('active', eyedropperActive);
    floaterColorDisplay.style.background = paintColor.clone().getStyle();
  }

  document.getElementById('paintToggle').addEventListener('click', () => {
    paintModeActive = !paintModeActive;
    const btn = document.getElementById('paintToggle');
    btn.textContent = paintModeActive ? 'Deactivate Paint Mode' : 'Activate Paint Mode';
    btn.classList.toggle('active', paintModeActive);
    controls.enabled = !paintModeActive && !maskMode;
    if (maskMode && paintModeActive) {
      maskMode = false;
      maskToggle.classList.remove('active');
      maskToggle.textContent = 'Mask Mode (Paint Invisibility)';
    }
    eyedropperActive = false;
    document.getElementById('eyedropperToggle').classList.remove('active');
    document.getElementById('eyedropperToggle').textContent = 'Eyedropper Tool';
    if (!paintModeActive) hideCursors();
    updateFloatingControls();
  });

  document.getElementById('eyedropperToggle').addEventListener('click', () => {
    eyedropperActive = !eyedropperActive;
    const btn = document.getElementById('eyedropperToggle');
    btn.textContent = eyedropperActive ? 'Cancel Eyedropper' : 'Eyedropper Tool';
    btn.classList.toggle('active', eyedropperActive);
    controls.enabled = !eyedropperActive;
    if (eyedropperActive) {
      paintModeActive = false;
      maskMode = false;
      document.getElementById('paintToggle').classList.remove('active');
      document.getElementById('paintToggle').textContent = 'Activate Paint Mode';
      document.getElementById('maskToggle').classList.remove('active');
      document.getElementById('maskToggle').textContent = 'Mask Mode (Paint Invisibility)';
      hideCursors();
    }
    updateFloatingControls();
  });

  // Upload
  document.getElementById('uploadModel').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    loadModel(url);
  });

  window.addEventListener('dragover', e => e.preventDefault());
  window.addEventListener('drop', e => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file && (file.name.toLowerCase().endsWith('.glb') || file.name.toLowerCase().endsWith('.gltf'))) {
      loadModel(URL.createObjectURL(file));
    }
  });

  function loadModel(url) {
    loader.style.display = 'block';
    loader.textContent = "Loading...";
    new GLTFLoader().load(url, (gltf) => {
      if (currentModel) scene.remove(currentModel);
      currentModel = gltf.scene;
      scene.add(currentModel);
      const box = new THREE.Box3().setFromObject(currentModel);
      modelSize = box.getSize(new THREE.Vector3()).length() || 1;
      const center = box.getCenter(new THREE.Vector3());
      camera.position.copy(center).add(new THREE.Vector3(modelSize, modelSize * 0.7, modelSize));
      controls.target.copy(center);
      controls.update();

      paintedGeometries = [];
      layerData = {};
      globalMaskData = {};
      undoStack.length = 0;
      redoStack.length = 0;
      undoBtn.disabled = true;
      redoBtn.disabled = true;

      currentModel.traverse((child) => {
        if (child.isMesh) {
          if (!(child.material instanceof THREE.MeshStandardMaterial)) {
            child.material = new THREE.MeshStandardMaterial({ map: child.material?.map });
          }
          child.material.vertexColors = true;
          if (!child.geometry.attributes.color) {
            const colors = new Float32Array(child.geometry.attributes.position.count * 3).fill(1);
            child.geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
          }
          paintedGeometries.push({ geometry: child.geometry, mesh: child });
        }
      });
      updateAllGeometries();
      saveState();
      loader.style.display = 'none';
    }, undefined, (err) => {
      loader.textContent = "Error loading model";
      console.error(err);
    });
  }

  function updateAllGeometries() {
    paintedGeometries.forEach((pg) => {
      const col = pg.geometry.attributes.color;
      for (let i = 0; i < col.count; i++) {
        col.setXYZ(i, 1, 1, 1);
      }
      col.needsUpdate = true;
    });
  }

  function updateBrushCursor(x, y) {
    if (!paintModeActive && !maskMode) return;
    brushCursor.style.display = 'block';
    brushCursor.style.left = x + 'px';
    brushCursor.style.top = y + 'px';
    const radiusPx = 50;
    const diameter = Math.max(radiusPx * 2, 10);
    brushCursor.style.width = diameter + 'px';
    brushCursor.style.height = diameter + 'px';
  }

  function hideCursors() {
    brushCursor.style.display = 'none';
    eyedropperCursor.style.display = 'none';
  }

  canvas.addEventListener('pointermove', (e) => {
    if (paintModeActive || maskMode) updateBrushCursor(e.clientX, e.clientY);
  });

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  updateFloatingControls();
</script>
</body>
</html>
