<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retexture – BowesProduct</title>

  <!-- model-viewer -->
  <script type="module"
    src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js">
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      margin: 0;
      background: #020617;
      color: white;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      overflow-x: hidden;
    }

    /* HEADER */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: rgba(2,6,23,0.95);
      border-bottom: 1px solid #1e293b;
    }
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.6rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 1.6rem;
    }
    .logo a {
      font-size: 1.3rem;
      font-weight: 700;
      color: white;
      text-decoration: none;
      white-space: nowrap;
    }
    .main-nav {
      display: flex;
      gap: 1.4rem;
    }
    .main-nav a {
      color: #e5e7eb;
      text-decoration: none;
      font-size: 0.95rem;
    }
    .main-nav a:hover { color:#60a5fa; }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      min-height: 44px;
    }
    #profilePic {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid #60a5fa;
      object-fit: cover;
      display: none;
    }
    .login-btn {
      padding: 0.45rem 1.1rem;
      border-radius: 999px;
      border: 1.5px solid #60a5fa;
      background: transparent;
      color: #60a5fa;
      font-size: 0.95rem;
      cursor: pointer;
    }
    #levelInfo {
      display: none;
      width: 140px;
      font-size: 0.8rem;
      color: #cbd5e1;
    }
    #levelText { white-space: nowrap; }
    #xpOuter {
      width: 100%;
      height: 5px;
      background: #1e293b;
      border-radius: 3px;
      margin-top: 4px;
    }
    #xpBar {
      height: 100%;
      width: 0%;
      background: #60a5fa;
      border-radius: 3px;
      transition: width 0.35s ease;
    }

    /* CONTENT */
    .content {
      max-width: 1000px;
      margin: 3rem auto 4rem;
      padding: 0 1.5rem;
    }
    h1, h2 { color:#60a5fa; }
    p, li {
      color:#cbd5e1;
      line-height:1.8;
    }

    .viewer-row {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 2rem;
      align-items: flex-start;
      margin-top: 2rem;
    }
    model-viewer {
      width: 100%;
      height: 450px;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      border-radius: 12px;
      border: 1px solid #1e293b;
    }

    .panel {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1e293b;
      padding: 1.25rem 1.5rem;
    }
    .panel h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }
    .control-group {
      margin-bottom: 1rem;
    }
    .control-group label {
      display: block;
      font-size: 0.9rem;
      color: #e5e7eb;
      margin-bottom: 0.3rem;
    }
    select, input[type="file"] {
      width: 100%;
      font: inherit;
      padding: 0.4rem 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
    }
    .hint {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 0.35rem;
    }

    /* FOOTER */
    .site-footer {
      background: rgba(2,6,23,0.95);
      border-top: 1px solid #1e293b;
      padding: 3rem 1rem;
    }
    .footer-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1.5rem;
    }
    .footer-nav {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .footer-nav a {
      color: #cbd5e1;
      text-decoration: none;
    }
    .footer-nav a:hover { color: #60a5fa; }
    .site-footer p {
      margin: 0;
      color: #94a3b8;
    }

    @media (max-width: 900px) {
      .viewer-row {
        grid-template-columns: 1fr;
      }
      model-viewer {
        height: 380px;
      }
    }
    @media (max-width: 768px) {
      .header-inner {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      .header-left {
        justify-content: space-between;
      }
      .header-right {
        justify-content: space-between;
        width: 100%;
      }
      #levelInfo {
        width: 100%;
      }
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="site-header">
  <div class="header-inner">
    <div class="header-left">
      <div class="logo"><a href="index.html">BowesProduct</a></div>
      <nav class="main-nav">
        <a href="index.html">Home</a>
        <a href="models.html">Models</a>
        <a href="retexture.html">Retexture</a>
      </nav>
    </div>

    <div class="header-right">
      <img id="profilePic" alt="Profile">
      <div id="levelInfo">
        <div id="levelText"></div>
        <div id="xpOuter"><div id="xpBar"></div></div>
      </div>
      <button id="authBtn" class="login-btn">Login</button>
    </div>
  </div>
</header>

<!-- CONTENT -->
<div class="content">
  <h1>Retexture Your Model</h1>
  <p>
    Upload a GLB model and then swap its base color texture using the controls.  
    FBX must be converted to GLB before upload, since the viewer only understands glTF/GLB directly in the browser. [web:31][web:39]
  </p>

  <div class="viewer-row">
    <!-- MODEL VIEWER -->
    <model-viewer id="retextureViewer"
      src="models/example.glb"
      alt="Retexturable 3D model"
      ar
      camera-controls
      exposure="1.0"
      environment-image="neutral"
      shadow-intensity="0.8">
    </model-viewer>

    <!-- CONTROL PANEL -->
    <div class="panel">
      <h2>Model & Texture</h2>

      <div class="control-group">
        <label for="uploadModel">Upload GLB model</label>
        <input type="file" id="uploadModel" accept=".glb,model/gltf-binary">
        <div class="hint">
          Export GLB from your DCC (or convert FBX to GLB) before uploading. [web:31]
        </div>
      </div>

      <div class="control-group">
        <label for="presetTexture">Preset textures</label>
        <select id="presetTexture">
          <option value="">Default material</option>
          <!-- Update these with your own texture files -->
          <option value="textures/wood_basecolor.jpg">Warm wood</option>
          <option value="textures/metal_basecolor.jpg">Brushed metal</option>
          <option value="textures/plastic_basecolor.jpg">Matte plastic</option>
        </select>
        <div class="hint">Applies a preset image on the material’s base color.</div>
      </div>

      <div class="control-group">
        <label for="uploadTexture">Upload custom texture</label>
        <input type="file" id="uploadTexture" accept="image/*">
        <div class="hint">PNG/JPG mapped onto the model’s existing UVs.</div>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="footer-inner">
    <nav class="footer-nav">
      <a href="about.html">About</a>
      <a href="privacy.html">Privacy</a>
      <a href="terms.html">Terms</a>
      <a href="license.html">License</a>
      <a href="refund.html">Refund</a>
      <a href="rewards.html">Rewards</a>
    </nav>
    <p>© 2025 BowesProduct</p>
  </div>
</footer>

<!-- FIREBASE + RETEXTURE LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  /* ========== FIREBASE INIT ========== */
  const firebaseConfig = {
    apiKey: "AIzaSyB4JMVBMcWcN2wKsaVYmnggHH5ue1mUfaA",
    authDomain: "bowesproduct.firebaseapp.com",
    projectId: "bowesproduct"
    // You can add appId, etc., from your console if desired, but these are enough for basic web auth/Firestore. [web:31]
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  const authBtn = document.getElementById("authBtn");
  const profilePic = document.getElementById("profilePic");
  const levelInfo = document.getElementById("levelInfo");
  const levelText = document.getElementById("levelText");
  const xpBar = document.getElementById("xpBar");

  if (authBtn) {
    authBtn.onclick = () =>
      auth.currentUser ? signOut(auth) : signInWithPopup(auth, provider);
  }

  onAuthStateChanged(auth, async (user) => {
    if (!authBtn || !profilePic || !levelInfo || !levelText || !xpBar) return;

    if (!user) {
      authBtn.textContent = "Login";
      profilePic.style.display = "none";
      levelInfo.style.display = "none";
      return;
    }

    authBtn.textContent = "Logout";
    profilePic.src = user.photoURL || "";
    profilePic.style.display = "block";

    const ref = doc(db, "users", user.uid);
    let snap = await getDoc(ref);

    if (!snap.exists()) {
      await setDoc(ref, { xp: 10 });
      snap = await getDoc(ref);
    }

    const xp = snap.data().xp || 0;
    const levels = [0, 200, 500, 1000, 2000];
    let level = levels.filter(v => xp >= v).length - 1;
    let next = levels[level + 1] ?? levels[level];
    let progress = next === levels[level]
      ? 100
      : ((xp - levels[level]) / (next - levels[level])) * 100;

    levelText.textContent = `Level ${level} • ${xp} XP`;
    xpBar.style.width = progress + "%";
    levelInfo.style.display = "block";
  });

  /* ========== RETEXTURE + GLB UPLOAD LOGIC ========== */
  const modelViewer = document.getElementById('retextureViewer');
  const presetSelect = document.getElementById('presetTexture');
  const uploadTextureInput = document.getElementById('uploadTexture');
  const uploadModelInput = document.getElementById('uploadModel');

  // Handle GLB upload: assign blob URL to model-viewer src [web:31]
  uploadModelInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.glb')) {
      alert('Please upload a .glb file. Convert FBX to GLB before upload.');
      uploadModelInput.value = '';
      return;
    }

    const objectUrl = URL.createObjectURL(file);
    modelViewer.src = objectUrl;
  });

  // When the model is loaded, wire up material retexturing [web:31]
  modelViewer.addEventListener('load', () => {
    const material = modelViewer.model?.materials?.[0];
    if (!material) return;

    const applyTextureUrl = async (url) => {
      if (!url) {
        // Reset to original material (no override)
        material.pbrMetallicRoughness.baseColorTexture.setTexture(null);
        return;
      }
      const texture = await modelViewer.createTexture(url);
      material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
    };

    // Preset dropdown
    presetSelect.addEventListener('change', (e) => {
      const url = e.target.value;
      applyTextureUrl(url);
      uploadTextureInput.value = "";
    });

    // Custom image upload
    uploadTextureInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (ev) => {
        const dataUrl = ev.target.result;
        await applyTextureUrl(dataUrl);
        presetSelect.value = "";
      };
      reader.readAsDataURL(file);
    });
  });
</script>

</body>
</html>
