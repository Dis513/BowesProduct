<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retexture Pro – BowesProduct</title>

<script async src="https://unpkg.com/es-module-shims@1.8.2/dist/es-module-shims.js"></script>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
  }
}
</script>

<style>
*,*::before,*::after{box-sizing:border-box}
html,body{margin:0;height:100%;background:#020617;color:white;font-family:system-ui;overflow:hidden}

/* HEADER */
.site-header{
  position:fixed;top:0;left:0;right:0;z-index:1000;
  background:rgba(2,6,23,.95);
  border-bottom:1px solid #1e293b;
  backdrop-filter:blur(10px)
}
.header-inner{
  max-width:1200px;margin:0 auto;
  padding:.6rem 1rem;
  display:flex;align-items:center;justify-content:space-between
}
.logo a{color:white;text-decoration:none;font-weight:700;font-size:1.3rem}
.main-nav{display:flex;gap:1.4rem}
.main-nav a{color:#e5e7eb;text-decoration:none}
.main-nav a:hover{color:#60a5fa}
.header-right{display:flex;align-items:center;gap:.8rem}
#profilePic{width:32px;height:32px;border-radius:50%;border:2px solid #60a5fa;display:none}
.login-btn{
  padding:.45rem 1.1rem;
  border-radius:999px;
  border:1.5px solid #60a5fa;
  background:transparent;
  color:#60a5fa;
  cursor:pointer
}
#levelInfo{display:none;width:140px;font-size:.8rem}
#xpOuter{height:5px;background:#1e293b;border-radius:3px;margin-top:4px}
#xpBar{height:100%;width:0;background:#60a5fa;border-radius:3px}

/* MAIN */
#container{position:relative;width:100%;height:100%;padding-top:70px}
#canvas{width:100%;height:100%;display:block;touch-action:none}

/* PANEL */
.panel{
  position:absolute;top:90px;right:20px;width:320px;
  max-height:calc(100vh - 120px);
  overflow-y:auto;
  background:rgba(2,6,23,.95);
  border:1px solid #1e293b;
  border-radius:12px;
  padding:1.5rem;z-index:10
}
label{display:block;font-size:.9rem;margin:.5rem 0 .25rem}
input,select,button{
  width:100%;padding:.45rem;
  background:#020617;color:white;
  border:1px solid #1e293b;border-radius:6px
}
button{background:#60a5fa;border:none;font-weight:600;margin-top:.4rem}
#paintToggle.active{background:#f87171}

/* BRUSH CURSOR */
#brushCursor{
  position:absolute;
  pointer-events:none;
  transform:translate(-50%,-50%);
  display:none;
  z-index:20;
  background-size:contain;
  background-repeat:no-repeat;
  background-position:center;
}

/* FOOTER */
.site-footer{
  position:fixed;bottom:0;left:0;right:0;
  background:rgba(2,6,23,.95);
  border-top:1px solid #1e293b;
  padding:1rem;z-index:1000
}
.footer-inner{
  max-width:1200px;margin:0 auto;
  display:flex;justify-content:space-between;flex-wrap:wrap;
  font-size:.85rem
}
.footer-nav{display:flex;gap:1.4rem}
.footer-nav a{color:#cbd5e1;text-decoration:none}
.footer-nav a:hover{color:#60a5fa}
</style>
</head>

<body>

<!-- HEADER -->
<header class="site-header">
  <div class="header-inner">
    <div class="header-left">
      <div class="logo"><a href="index.html">BowesProduct</a></div>
      <nav class="main-nav">
        <a href="index.html">Home</a>
        <a href="models.html">Models</a>
        <a href="retexture.html">Retexture</a>
      </nav>
    </div>
    <div class="header-right">
      <img id="profilePic">
      <div id="levelInfo">
        <div id="levelText"></div>
        <div id="xpOuter"><div id="xpBar"></div></div>
      </div>
      <button id="authBtn" class="login-btn">Login</button>
    </div>
  </div>
</header>

<!-- MAIN -->
<div id="container">
  <canvas id="canvas"></canvas>
  <div id="brushCursor"></div>

  <div class="panel">
    <h3>Model</h3>
    <input type="file" id="uploadModel" accept=".glb,.gltf">

    <h3>Texture</h3>
    <select id="presetTexture">
      <option value="">Original</option>
      <option value="textures/wood_basecolor.jpg">Wood</option>
      <option value="textures/metal_basecolor.jpg">Metal</option>
    </select>
    <input type="file" id="uploadTexture" accept="image/*">

    <h3>Material</h3>
    <input type="range" id="metallic" min="0" max="1" step="0.01" value="0">
    <input type="range" id="roughness" min="0" max="1" step="0.01" value="0.5">

    <h3>Vertex Painting</h3>
    <input type="color" id="paintColor" value="#ff4444">
    <input type="range" id="brushSize" min="0.05" max="5" step="0.05" value="0.5">

    <select id="brushShape">
      <option value="soft-circle">Soft Circle</option>
      <option value="hard-circle">Hard Circle</option>
      <option value="square-hard">Square</option>
      <option value="diamond-hard">Diamond</option>
      <option value="custom">Custom PNG</option>
    </select>

    <input type="file" id="uploadBrush" accept="image/png" style="display:none">

    <button id="paintToggle">Activate Paint Mode</button>
    <button id="clearPaint">Clear Paint</button>

    <h3>Export</h3>
    <button id="exportBtn">Export GLB</button>
  </div>
</div>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="footer-inner">
    <nav class="footer-nav">
      <a href="about.html">About</a>
      <a href="privacy.html">Privacy</a>
      <a href="terms.html">Terms</a>
    </nav>
    <p>© 2025 BowesProduct</p>
  </div>
</footer>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyB4JMVBMcWcN2wKsaVYmnggHH5ue1mUfaA",
  authDomain:"bowesproduct.firebaseapp.com",
  projectId:"bowesproduct"
});
const auth=getAuth(app);
const db=getFirestore(app);
const provider=new GoogleAuthProvider();

const authBtn=document.getElementById("authBtn");
authBtn.onclick=()=>auth.currentUser?signOut(auth):signInWithPopup(auth,provider);

onAuthStateChanged(auth,async user=>{
  if(!user) return;
  const ref=doc(db,"users",user.uid);
  let snap=await getDoc(ref);
  if(!snap.exists()) await setDoc(ref,{xp:10});
});
</script>

<!-- THREE + BRUSH FIX -->
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

/* === CORE === */
const canvas=document.getElementById('canvas');
const renderer=new THREE.WebGLRenderer({canvas,antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.outputColorSpace=THREE.SRGBColorSpace;

const scene=new THREE.Scene();
scene.background=new THREE.Color(0x020617);

const camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,.1,100);
camera.position.set(3,2,5);

const controls=new OrbitControls(camera,canvas);
controls.enableDamping=true;

scene.add(new THREE.AmbientLight(0xffffff,.6));
const dl=new THREE.DirectionalLight(0xffffff,1.4);
dl.position.set(5,10,7);
scene.add(dl);

/* === BRUSH FIX === */
let paintMode=false;
let paintColor=new THREE.Color('#ff4444');
let brushSize=.5;
let brushShape='soft-circle';
let customBrushCanvas=null;

const brushCursor=document.getElementById('brushCursor');
let mx=0,my=0;

function refreshCursor(){
  if(!paintMode) return;
  const px=brushSize*80;
  brushCursor.style.width=px+'px';
  brushCursor.style.height=px+'px';
  brushCursor.style.border='';
  brushCursor.style.backgroundImage='';
  brushCursor.style.backgroundColor='';
  if(brushShape==='custom' && customBrushCanvas){
    brushCursor.style.backgroundImage=`url(${customBrushCanvas.toDataURL()})`;
  }else{
    brushCursor.style.backgroundColor=paintColor.getStyle()+'33';
    brushCursor.style.border='2px solid '+paintColor.getStyle();
    brushCursor.style.borderRadius=brushShape.includes('circle')?'50%':'0';
  }
}

canvas.addEventListener('pointermove',e=>{
  mx=e.clientX;my=e.clientY;
  brushCursor.style.left=mx+'px';
  brushCursor.style.top=my+'px';
});

document.getElementById('paintToggle').onclick=()=>{
  paintMode=!paintMode;
  controls.enabled=!paintMode;
  brushCursor.style.display=paintMode?'block':'none';
  refreshCursor();
};

document.getElementById('paintColor').oninput=e=>{
  paintColor.set(e.target.value);
  refreshCursor();
};

document.getElementById('brushSize').oninput=e=>{
  brushSize=parseFloat(e.target.value);
  refreshCursor();
};

document.getElementById('brushShape').onchange=e=>{
  brushShape=e.target.value;
  document.getElementById('uploadBrush').style.display=brushShape==='custom'?'block':'none';
  refreshCursor();
};

document.getElementById('uploadBrush').onchange=e=>{
  const img=new Image();
  img.onload=()=>{
    customBrushCanvas=document.createElement('canvas');
    customBrushCanvas.width=64;
    customBrushCanvas.height=64;
    customBrushCanvas.getContext('2d').drawImage(img,0,0,64,64);
    refreshCursor();
  };
  img.src=URL.createObjectURL(e.target.files[0]);
};

function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene,camera);
}
animate();
</script>

</body>
</html>
