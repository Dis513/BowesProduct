<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON NIGHTMARE - Rhythm Game</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Background Effects -->
    <div class="void-background"></div>
    <div class="fog-layer"></div>
    
    <!-- Parallax Background Layers -->
    <div class="parallax-layer layer-1" id="parallaxLayer1">
        <div class="star-field"></div>
    </div>
    <div class="parallax-layer layer-2" id="parallaxLayer2">
        <div class="distant-mountains"></div>
    </div>
    <div class="parallax-layer layer-3" id="parallaxLayer3">
        <div class="mid-landscape"></div>
    </div>
    <div class="parallax-layer layer-4" id="parallaxLayer4">
        <div class="foreground-elements"></div>
    </div>
    
    <!-- Beat-reactive glow effect -->
    <div class="beat-glow" id="beatGlow"></div>
    
    <!-- Particles -->
    <div class="particles" id="particles"></div>
    
    <!-- Decorative Elements -->
    <div class="crooked-tree left"></div>
    <div class="crooked-tree right"></div>

    <!-- Main Menu -->
    <div class="menu-container" id="mainMenu">
        <h1 class="game-title">NEON NIGHTMARE</h1>
        <p class="game-subtitle">A Rhythm Experience</p>
        
        <div class="menu-options">
            <div class="file-upload-container">
                <input type="file" id="audioFileInput" accept="audio/*" style="display: none;">
                <button class="menu-button" id="uploadButton">
                    üéµ Upload Audio File
                </button>
                <p class="upload-info" id="uploadInfo">Supports MP3, WAV, OGG, M4A</p>
            </div>
            <button class="menu-button" id="selectLevel">
                üéÆ Select Level
            </button>
            <button class="menu-button" id="viewLeaderboards">
                üèÜ High Scores
            </button>
            <button class="menu-button" id="openSettings">
                ‚öôÔ∏è Settings
            </button>
        </div>
    </div>

    <!-- Level Select Modal -->
    <div class="pause-menu" id="levelSelectMenu">
        <h2 class="pause-title">üéØ SELECT LEVEL</h2>
        <div class="level-grid" id="levelGrid"></div>
        <div class="menu-options">
            <button class="menu-button" id="backToMainMenu">
                ‚Üê Back to Menu
            </button>
        </div>
    </div>

    <!-- Cutscene Player -->
    <div class="cutscene-container" id="cutsceneContainer">
        <video id="cutsceneVideo" class="cutscene-video"></video>
        <button class="skip-button" id="skipCutscene">SKIP ‚è≠Ô∏è</button>
    </div>

    <!-- Firebase UI -->
    <div class="firebase-ui-container" id="firebaseUI">
        <button class="auth-button" id="authBtn">Login</button>
        <img class="profile-pic" id="profilePic" src="" alt="Profile">
        <div class="level-info" id="levelInfo">
            <span class="level-text" id="levelText">Level 0 ‚Ä¢ 10 XP</span>
            <div class="xp-bar-container">
                <div class="xp-bar-fill" id="xpBar"></div>
            </div>
        </div>
    </div>
    
    <!-- Game Container -->
    <div class="game-container hidden" id="gameContainer">
        <!-- Level Indicator -->
        <div class="level-indicator" id="levelIndicator">
            <span class="level-label">LEVEL</span>
            <span class="level-number" id="levelNumber">1</span>
        </div>

        <!-- Character -->
        <div class="character" id="character">
            <div class="character-sprite" id="characterSprite">
                <div class="character-body"></div>
                <div class="character-eyes">
                    <div class="eye left"></div>
                    <div class="eye right"></div>
                </div>
                <div class="character-aura" id="characterAura"></div>
            </div>
            <div class="character-shadow"></div>
        </div>

        <!-- Top HUD -->
        <div class="hud-top">
            <div class="score-display">
                SCORE: <span id="scoreValue">0</span>
            </div>
            <div class="health-bar-container">
                <div class="health-label">HEALTH</div>
                <div class="health-bar">
                    <div class="health-bar-fill" id="healthBarFill"></div>
                </div>
                <div class="health-value" id="healthValue">100</div>
            </div>
            <div class="multiplier-container">
                <div class="multiplier-pulse" id="multiplierPulse">
                    <div class="multiplier-label">MULTIPLIER</div>
                    <div class="multiplier-display">
                        <span id="multiplierValue">1</span>x
                    </div>
                </div>
            </div>
        </div>

        <!-- Song Info -->
        <div class="song-info">
            <h2 class="song-title" id="songTitle">No Track Loaded</h2>
            <p class="song-artist" id="songArtist">Select a level to begin</p>
        </div>

        <!-- Note Highway -->
        <div class="note-highway" id="noteHighway">
            <div class="fret-lanes">
                <div class="fret-lane" data-fret="green"></div>
                <div class="fret-lane" data-fret="red"></div>
                <div class="fret-lane" data-fret="yellow"></div>
                <div class="fret-lane" data-fret="blue"></div>
                <div class="fret-lane" data-fret="orange"></div>
            </div>
            <div class="target-line" id="targetLine"></div>
        </div>

        <!-- Fret Buttons -->
        <div class="fret-buttons">
            <div class="fret-button green" data-fret="green">
                <span>A</span>
                <span class="fret-button-key">Green</span>
            </div>
            <div class="fret-button red" data-fret="red">
                <span>S</span>
                <span class="fret-button-key">Red</span>
            </div>
            <div class="fret-button yellow" data-fret="yellow">
                <span>D</span>
                <span class="fret-button-key">Yellow</span>
            </div>
            <div class="fret-button blue" data-fret="blue">
                <span>F</span>
                <span class="fret-button-key">Blue</span>
            </div>
            <div class="fret-button orange" data-fret="orange">
                <span>G</span>
                <span class="fret-button-key">Orange</span>
            </div>
        </div>

        <!-- Bottom HUD -->
        <div class="hud-bottom">
            <div class="combo-display" id="comboDisplay">
                <span id="comboValue">0</span> COMBO
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <!-- Pause Menu -->
    <div class="pause-menu" id="pauseMenu">
        <h2 class="pause-title">‚è∏Ô∏è PAUSED</h2>
        <div class="menu-options">
            <button class="menu-button" id="resumeGame">
                ‚ñ∂Ô∏è Resume
            </button>
            <button class="menu-button" id="restartSong">
                üîÑ Restart
            </button>
            <button class="menu-button" id="changeDifficulty">
                üìä Change Difficulty
            </button>
            <button class="menu-button" id="returnToMenu">
                üè† Main Menu
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="pause-menu" id="settingsMenu">
        <h2 class="pause-title">‚öôÔ∏è SETTINGS</h2>
        <div class="menu-options">
            <button class="menu-button" id="setDifficultyEasy">
                üü¢ Easy
            </button>
            <button class="menu-button" id="setDifficultyMedium">
                üü° Medium
            </button>
            <button class="menu-button" id="setDifficultyHard">
                üî¥ Hard
            </button>
            <button class="menu-button" id="setDifficultyExpert">
                üîµ Expert
            </button>
            <button class="menu-button" id="setDifficultyMaster">
                üü£ Master
            </button>
            <button class="menu-button" id="closeSettings">
                ‚Üê Back
            </button>
        </div>
    </div>

    <!-- Song Complete Modal -->
    <div class="pause-menu" id="songCompleteMenu">
        <h2 class="pause-title">üéµ LEVEL COMPLETE!</h2>
        <div class="menu-options">
            <div class="final-score">
                <p class="score-label">Final Score</p>
                <p class="score-value" id="finalScoreValue">0</p>
            </div>
            <div class="final-stats">
                <p>Perfect: <span id="perfectCount">0</span></p>
                <p>Great: <span id="greatCount">0</span></p>
                <p>Good: <span id="goodCount">0</span></p>
                <p>Miss: <span id="missCount">0</span></p>
                <p>Max Combo: <span id="maxComboValue">0</span></p>
            </div>
            <button class="menu-button" id="playAgain">
                üîÑ Play Again
            </button>
            <button class="menu-button" id="nextLevel">
                ‚ñ∂Ô∏è Next Level
            </button>
            <button class="menu-button" id="uploadNewSong">
                üìÅ Upload New Song
            </button>
            <button class="menu-button" id="selectLevelFromComplete">
                üìã Select Level
            </button>
            <button class="menu-button" id="mainMenuFromComplete">
                üè† Main Menu
            </button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="pause-menu" id="gameOverMenu">
        <h2 class="pause-title game-over-title">üíÄ TRACK FAILED</h2>
        <div class="menu-options">
            <div class="final-score">
                <p class="score-label">Final Score</p>
                <p class="score-value" id="gameOverScoreValue">0</p>
            </div>
            <button class="menu-button" id="restartFromGameOver">
                üîÑ Restart
            </button>
            <button class="menu-button" id="uploadFromGameOver">
                üìÅ Upload a File
            </button>
            <button class="menu-button" id="mainMenuFromGameOver">
                üè† Main Menu
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="game.js"></script>
    
    <!-- ================= FIREBASE ================= -->
    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB4JMVBMcWcN2wKsaVYmnggHH5ue1mUfaA",
  authDomain: "bowesproduct.firebaseapp.com",
  projectId: "bowesproduct"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const authBtn = document.getElementById("authBtn");
const profilePic = document.getElementById("profilePic");
const levelInfo = document.getElementById("levelInfo");
const levelText = document.getElementById("levelText");
const xpBar = document.getElementById("xpBar");

authBtn.onclick = () =>
  auth.currentUser ? signOut(auth) : signInWithPopup(auth, provider);

onAuthStateChanged(auth, async (user) => {
 if (!user) {
  authBtn.textContent = "Login";
  profilePic.style.display = "none";
  levelInfo.style.display = "none";
  return;
 }

 authBtn.textContent = "Logout";
 profilePic.src = user.photoURL || "";
 profilePic.style.display = "block";

 const ref = doc(db, "users", user.uid);
 let snap = await getDoc(ref);

 if (!snap.exists()) {
  await setDoc(ref, { xp: 10 });  // ‚Üê New users start with 10 XP
  snap = await getDoc(ref);
 }

 const xp = snap.data().xp || 0;
 const levels = [0, 200, 500, 1000, 2000];
 let level = levels.filter(v => xp >= v).length - 1;
 let next = levels[level + 1] ?? levels[level];
 let progress = next === levels[level] ? 100 :
  ((xp - levels[level]) / (next - levels[level])) * 100;

 levelText.textContent = `Level ${level} ‚Ä¢ ${xp} XP`;
 xpBar.style.width = progress + "%";
 levelInfo.style.display = "block";
});

// Make Firebase functions available globally
window.firebaseFunctions = {
  auth,
  db,
  addDoc,
  collection,
  doc,
  getDoc,
  setDoc,
  query,
  orderBy,
  limit,
  getDocs
};
</script>
</body>
</html>