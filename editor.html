
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vector Editor Pro \u2013 BowesProduct</title>
  <style>
  *, *::before, *::after { box-sizing: border-box; }
  html, body { margin: 0; height: 100%; background: #020617; color: white; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; -webkit-font-smoothing: antialiased; }

  /* ================= HEADER ================= */
  .site-header {
    position: sticky; top: 0; z-index: 1000; background: rgba(2,6,23,0.95); border-bottom: 1px solid #1e293b; backdrop-filter: blur(10px);
  }
  .header-inner { max-width: 1200px; margin: 0 auto; padding: 0.6rem 1rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; }
  .header-left { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
  .logo a { font-size: 1.3rem; font-weight: 700; color: white; text-decoration: none; white-space: nowrap; }
  .main-nav { display: flex; gap: 1rem; flex-wrap: wrap; }
  .main-nav a { color: #e5e7eb; text-decoration: none; font-size: 0.9rem; white-space: nowrap; }
  .main-nav a:hover, .main-nav a.active { color: #60a5fa; }
  .header-right { display: flex; align-items: center; gap: 0.8rem; min-height: 44px; flex-wrap: wrap; }
  #profilePic { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #60a5fa; object-fit: cover; display: none; }
  .login-btn { padding: 0.45rem 1.1rem; border-radius: 999px; border: 1.5px solid #60a5fa; background: transparent; color: #60a5fa; font-size: 0.95rem; cursor: pointer; }
  #levelInfo { display: none; font-size: 0.8rem; color: #cbd5e1; }
  #levelText { white-space: nowrap; font-size: 0.75rem; }
  #xpOuter { width: 100px; height: 5px; background: #1e293b; border-radius: 3px; margin-top: 4px; }
  #xpBar { height: 100%; width: 0%; background: #60a5fa; border-radius: 3px; transition: width 0.35s ease; }

  @media (max-width: 900px) {
    .header-inner { padding: 0.5rem; }
    .header-left { width: 100%; justify-content: space-between; }
    .main-nav { gap: 0.8rem; order: 3; width: 100%; }
    .main-nav a { font-size: 0.85rem; }
    .header-right { width: 100%; justify-content: space-between; }
    #levelInfo { flex: 1; }
    #xpOuter { width: 100%; }
  }

  /* ================= APPLICATION MENU BAR ================= */
  .app-menu-bar {
    background: rgba(15,23,42,0.98);
    border-bottom: 1px solid #1e293b;
    padding: 0;
    padding-left: 150px;
    display: flex;
    gap: 0;
    font-size: 0.85rem;
    position: sticky;
    top: 56px;
    z-index: 999;
    backdrop-filter: blur(10px);
    flex-wrap: wrap;
    height: 36px;
    align-items: center;
  }
  .menu-bar { display: flex; height: 100%; }
  .menu-bar > div {
    position: relative; cursor: pointer; padding: 0.5rem 1rem; height: 100%; display: flex; align-items: center; user-select: none;
  }
  .menu-bar > div:hover { color: #60a5fa; background: rgba(96, 165, 250, 0.1); }
  .dropdown {
    position: absolute; top: 100%; left: 0; background: #0f172a; border: 1px solid #1e293b; min-width: 260px; display: none; flex-direction: column; box-shadow: 0 8px 25px rgba(0,0,0,0.6); border-radius: 6px; overflow: hidden; z-index: 10000; margin-top: 2px;
  }
  .dropdown div { padding: 0.6rem 1.2rem; text-align: left; white-space: nowrap; transition: background 0.15s; font-size: 0.85rem; cursor: pointer; }
  .dropdown div:hover { background: #1e293b; }
  .dropdown div:active { background: #334155; }
  .dropdown .shortcut { float: right; color: #64748b; font-size: 0.75rem; margin-left: 2rem; }
  .dropdown hr { border: none; border-top: 1px solid #1e293b; margin: 0.4rem 0; }
  .dropdown .submenu { position: absolute; left: 100%; top: 0; min-width: 220px; display: none; }
  .dropdown div:hover .submenu { display: flex; }
  .menu-bar > div:hover .dropdown, .dropdown:hover { display: flex; }

  @media (max-width: 900px) {
    .app-menu-bar { gap: 1rem; padding-left: 60px; z-index: 999; }
    .menu-bar > div { padding: 0.3rem 0.5rem; font-size: 0.8rem; }
  }

  /* ================= MAIN LAYOUT ================= */
  #container { position: relative; width: 100%; height: 100%; padding-top: 92px; padding-bottom: 30px; display: flex; }
  
  /* ================= CANVAS AREA ================= */
  #canvas-container {
    flex: 1; position: relative; background: #0a0a0a; overflow: hidden; display: flex; flex-direction: column;
  }
  
  /* Rulers */
  .ruler { position: absolute; background: #1e293b; color: #64748b; font-size: 10px; z-index: 10; }
  .ruler-h { top: 0; left: 60px; right: 0; height: 20px; border-bottom: 1px solid #334155; }
  .ruler-v { top: 20px; left: 0; width: 60px; bottom: 0; border-right: 1px solid #334155; }
  .ruler-corner { position: absolute; top: 0; left: 0; width: 60px; height: 20px; background: #1e293b; border-right: 1px solid #334155; border-bottom: 1px solid #334155; z-index: 11; }
  
  #canvas { display: block; width: 100%; height: 100%; touch-action: none; outline: none; margin-top: 20px; margin-left: 60px; background: #0a0a0a; }
  
  /* Artboard */
  .artboard {
    position: absolute; background: white; box-shadow: 0 0 0 1px #334155, 0 4px 20px rgba(0,0,0,0.5);
  }
  .artboard-label {
    position: absolute; bottom: -25px; left: 0; color: #64748b; font-size: 11px; white-space: nowrap;
  }

  /* ================= LEFT TOOLBAR ================= */
  #floatingToolbar {
    position: fixed; left: 20px; top: 108px; background: rgba(30, 41, 59, 0.95); padding: 10px; border-radius: 12px; border: 1px solid #1e293b; backdrop-filter: blur(8px); z-index: 1150; display: flex; flex-direction: column; gap: 8px; max-height: calc(100vh - 180px); overflow-y: auto;
  }
  .tool-group { display: flex; flex-direction: column; gap: 2px; padding: 4px 0; border-bottom: 1px solid #1e293b; }
  .tool-group:last-child { border-bottom: none; }
  .tool-btn {
    width: 42px; height: 42px; border-radius: 6px; border: 1px solid transparent; background: transparent; color: #94a3b8; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; font-size: 1.3rem; position: relative;
  }
  .tool-btn:hover { background: rgba(51, 65, 85, 1); color: white; }
  .tool-btn.active { color: #60a5fa; background: rgba(96, 165, 250, 0.1); border-color: #60a5fa; }

  /* ================= RIGHT PANEL DOCK ================= */
  .panel-dock {
    position: fixed; right: 20px; top: 108px; width: 320px; max-height: calc(100vh - 140px); background: rgba(2, 6, 23, 0.95); border: 1px solid #1e293b; border-radius: 12px; overflow: hidden; z-index: 20; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.4); display: flex; flex-direction: column;
  }
  
  #dockToggle { 
    position: absolute; left: -50px; top: 50%; transform: translateY(-50%); width: 50px; height: 100px; background: rgba(2, 6, 23, 0.98); border: 1px solid #1e293b; border-right: none; border-radius: 12px 0 0 12px; color: #60a5fa; font-size: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 21; backdrop-filter: blur(12px); box-shadow: 0 6px 30px rgba(0,0,0,0.5); transition: all 0.3s ease;
  }
  #dockToggle:hover { background: rgba(30, 41, 59, 0.98); color: white; transform: translateY(-50%) translateX(-4px); }

  .panel-tabs { display: flex; background: #0f172a; border-bottom: 1px solid #1e293b; overflow-x: auto; position: relative; }
  .panel-tab {
    padding: 0.6rem 1rem; background: transparent; border: none; color: #94a3b8; cursor: pointer; font-size: 0.8rem; white-space: nowrap; transition: all 0.2s; flex-shrink: 0;
  }
  .panel-tab:hover { color: #e5e7eb; }
  .panel-tab.active { color: #60a5fa; background: rgba(96, 165, 250, 0.1); border-bottom: 2px solid #60a5fa; }
  .panel-close-btn {
    position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #94a3b8; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.2s; z-index: 100;
  }
  .panel-close-btn:hover { background: #334155; color: #e5e7eb; }

  .panel-content { padding: 1rem; overflow-y: auto; flex: 1; }
  .panel-section { display: none; }
  .panel-section.active { display: block; }

  .panel-section h3 { 
    color: #60a5fa; margin: 1rem 0 0.8rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #1e293b; padding-bottom: 0.4rem; font-weight: 600;
  }
  .panel-section h3:first-child { margin-top: 0; }

  .control-group { margin-bottom: 1rem; }
  .control-group label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.4rem; }
  .control-row { display: flex; gap: 0.5rem; align-items: center; }
  
  input[type="text"], input[type="number"], select {
    width: 100%; padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb; font-size: 0.85rem;
  }
  input[type="text"]:focus, input[type="number"]:focus, select:focus { outline: none; border-color: #60a5fa; }
  
  input[type="range"] { width: 100%; accent-color: #60a5fa; }
  input[type="color"] { width: 100%; height: 36px; padding: 2px; border: 1px solid #334155; border-radius: 4px; background: #0f172a; cursor: pointer; }
  
  .btn {
    padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #e5e7eb; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;
  }
  .btn:hover { background: #334155; border-color: #475569; }
  .btn-primary { background: #60a5fa; border-color: #60a5fa; color: white; }
  .btn-primary:hover { background: #3b82f6; border-color: #3b82f6; }
  .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
  .btn-group { display: flex; gap: 0.25rem; }
  .btn-group .btn { flex: 1; }

  /* Layers Panel */
  .layer-item { 
    display: flex; align-items: center; gap: 8px; padding: 0.5rem; background: #0f172a; border-radius: 6px; margin-bottom: 0.4rem; cursor: pointer; transition: all 0.15s;
  }
  .layer-item:hover { background: #1e293b; }
  .layer-item.active { background: #1e293b; border: 1px solid #60a5fa; }
  .layer-item .layer-icon { width: 20px; text-align: center; font-size: 0.9rem; }
  .layer-item .layer-name { flex: 1; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .layer-item .layer-actions { display: flex; gap: 4px; }
  .layer-item .layer-actions button { padding: 2px 6px; font-size: 0.75rem; }

  /* Appearance Panel */
  .appearance-item { 
    padding: 0.6rem; background: #0f172a; border-radius: 6px; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.5rem;
  }
  .appearance-item .type { font-size: 0.75rem; color: #64748b; width: 40px; }
  .appearance-item .color-preview { width: 24px; height: 24px; border-radius: 4px; border: 1px solid #334155; }
  .appearance-item .value { flex: 1; font-size: 0.8rem; }

  /* Swatches */
  .swatch-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }
  .swatch { 
    width: 100%; aspect-ratio: 1; border-radius: 4px; cursor: pointer; border: 1px solid #334155; transition: all 0.15s;
  }
  .swatch:hover { transform: scale(1.1); }
  .swatch.selected { border: 2px solid #60a5fa; }

  /* Alignment */
  .align-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
  .align-btn { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border: 1px solid #334155; background: #0f172a; border-radius: 4px; cursor: pointer; transition: all 0.15s; }
  .align-btn:hover { background: #1e293b; }

  /* Status Bar */
  .status-bar {
    position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.95); border-top: 1px solid #1e293b; padding: 0.4rem 1rem; font-size: 0.75rem; color: #64748b; display: flex; justify-content: space-between; z-index: 1000; backdrop-filter: blur(10px);
  }
  .status-bar .left { display: flex; gap: 2rem; }
  .status-bar .right { display: flex; gap: 1rem; }

  /* Mobile */
  @media (max-width: 900px) {
    #floatingToolbar { 
      left: 10px; top: 103px; padding: 6px; max-height: calc(100vh - 160px);
    }
    .tool-btn { width: 38px; height: 38px; font-size: 1.1rem; }
    .panel-dock { 
      top: auto; 
      bottom: 0; 
      right: 0; 
      left: 0; 
      width: 100%; 
      height: 40vh;
      max-height: 40vh;
      border-radius: 12px 12px 0 0; 
      transform: none; 
      z-index: 2000;
      overflow-y: auto;
    }
    .panel-dock.hidden { transform: translateY(100%); }
    .panel-dock.visible { transform: translateY(0); }
    #dockToggle { 
      display: flex; 
      top: -50px; 
      left: 50%; 
      transform: translateX(-50%); 
      width: 100px; 
      height: 50px; 
      border-radius: 12px 12px 0 0; 
    }
    .ruler-h { left: 50px; }
    .ruler-v { display: none; }
    #canvas { margin-left: 50px; }
    .dropdown { z-index: 1900; }
  }

  /* Tool/Panel Name Notification */
  .tool-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: linear-gradient(135deg, rgba(96, 165, 250, 0.95), rgba(59, 130, 246, 0.95));
    color: white;
    padding: 1.5rem 2.5rem;
    border-radius: 16px;
    font-size: 1.8rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    z-index: 10000;
    pointer-events: none;
    opacity: 0;
    box-shadow: 0 20px 60px rgba(96, 165, 250, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .tool-notification.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
  .tool-notification.hide {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.9);
  }

  #loader { 
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #60a5fa; font-size: 1.2rem; font-weight: 600; pointer-events: none; z-index: 5;
  }

  /* Context Menu */
  .context-menu {
    position: fixed; background: #0f172a; border: 1px solid #1e293b; min-width: 180px; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); z-index: 2000; display: none;
  }
  .context-menu div { padding: 0.6rem 1rem; cursor: pointer; font-size: 0.85rem; }
  .context-menu div:hover { background: #1e293b; }
  .context-menu hr { border: none; border-top: 1px solid #1e293b; margin: 0.3rem 0; }

  /* Modal */
  .modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 20000;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 12px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  .modal h2 {
    color: #60a5fa;
    margin: 0 0 1.5rem;
    font-size: 1.3rem;
  }
  .modal-close {
    position: absolute; top: 1rem; right: 1rem;
    background: none; border: none;
    color: #94a3b8;
    font-size: 1.5rem;
    cursor: pointer;
  }
  .modal-close:hover { color: white; }
  .modal-actions {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
  }
  </style>
  <!-- Paper.js for vector editing - using unminified version for better debugging -->
  <script src="https://cdn.jsdelivr.net/npm/paper@0.12.17/dist/paper-full.js"></script>
</head>
<body>

<!-- Modal for New Document -->
<div class="modal-overlay" id="newDocumentModal">
  <div class="modal">
    <h2>Create New Document</h2>
    <div class="control-group">
      <label for="docWidth">Width (px)</label>
      <input type="number" id="docWidth" value="1920" min="1">
    </div>
    <div class="control-group">
      <label for="docHeight">Height (px)</label>
      <input type="number" id="docHeight" value="1080" min="1">
    </div>
    <div class="control-group">
      <label>Preset Sizes</label>
      <select id="docPreset">
        <option value="custom">Custom</option>
        <option value="1920x1080">1920 x 1080 (Full HD)</option>
        <option value="3840x2160">3840 x 2160 (4K)</option>
        <option value="1280x720">1280 x 720 (HD)</option>
        <option value="1080x1920">1080 x 1920 (Portrait)</option>
        <option value="1080x1080">1080 x 1080 (Square)</option>
        <option value="800x600">800 x 600</option>
        <option value="1024x768">1024 x 768</option>
        <option value="2560x1440">2560 x 1440 (2K)</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeNewDocumentModal()">Cancel</button>
      <button class="btn btn-primary" onclick="createNewDocument()">Create</button>
    </div>
  </div>
</div>

<header class="site-header">
  <div class="header-inner">
    <div class="header-left">
      <div class="logo"><a href="index.html">BowesProduct</a></div>
      <nav class="main-nav">
        <a href="index.html">Home</a>
        <a href="models.html">Models</a>
        <a href="retexture.html">Retexture</a>
        <a href="editor.html" class="active">Editor</a>
      </nav>
    </div>
    <div class="header-right">
      <img id="profilePic" alt="Profile">
      <div id="levelInfo">
        <div id="levelText"></div>
        <div id="xpOuter"><div id="xpBar"></div></div>
      </div>
      <button id="authBtn" class="login-btn">Login</button>
    </div>
  </div>
</header>

<!-- Application Menu Bar -->
<div class="app-menu-bar">
  <div class="menu-bar">
    <div>File
      <div class="dropdown">
        <div data-action="newDocument">New <span class="shortcut">Ctrl+Shift+N</span></div>
        <div data-action="openFile">Open... <span class="shortcut">Ctrl+Shift+O</span></div>
        <div data-action="saveDocument">Save <span class="shortcut">Ctrl+Shift+S</span></div>
        <div data-action="saveDocumentAs">Save As... <span class="shortcut">Ctrl+Shift+A</span></div>
        <hr>
        <div data-action="placeImage">Place... <span class="shortcut">Ctrl+Shift+I</span></div>
        <hr>
        <div data-action="exportSVG">Export As SVG <span class="shortcut">Ctrl+Alt+S</span></div>
        <div data-action="exportPNG">Export As PNG <span class="shortcut">Ctrl+Alt+P</span></div>
        <div data-action="exportPDF">Export As PDF <span class="shortcut">Ctrl+Alt+E</span></div>
      </div>
    </div>
    <div>Edit
      <div class="dropdown">
        <div data-action="undo">Undo <span class="shortcut">Ctrl+Z</span></div>
        <div data-action="redo">Redo <span class="shortcut">Ctrl+Y</span></div>
        <hr>
        <div data-action="cut">Cut <span class="shortcut">Ctrl+X</span></div>
        <div data-action="copy">Copy <span class="shortcut">Ctrl+C</span></div>
        <div data-action="paste">Paste <span class="shortcut">Ctrl+V</span></div>
        <div data-action="duplicate">Duplicate <span class="shortcut">Ctrl+D</span></div>
        <div data-action="deleteSelection">Delete <span class="shortcut">Del</span></div>
        <hr>
        <div data-action="selectAll">Select All <span class="shortcut">Ctrl+A</span></div>
        <div data-action="deselectAll">Deselect <span class="shortcut">Ctrl+Shift+A</span></div>
      </div>
    </div>
    <div>Object
      <div class="dropdown">
        <div data-action="groupSelection">Group <span class="shortcut">Ctrl+G</span></div>
        <div data-action="ungroupSelection">Ungroup <span class="shortcut">Ctrl+Shift+G</span></div>
        <hr>
        <div data-action="lockSelection">Lock <span class="shortcut">Ctrl+2</span></div>
        <div data-action="unlockAll">Unlock All <span class="shortcut">Ctrl+Alt+2</span></div>
        <hr>
        <div>Arrange &darr;
          <div class="submenu">
            <div data-action="bringToFront">Bring to Front <span class="shortcut">Ctrl+Shift+]</span></div>
            <div data-action="sendToBack">Send to Back <span class="shortcut">Ctrl+Shift+[</span></div>
            <hr>
            <div data-action="bringForward">Bring Forward <span class="shortcut">Ctrl+]</span></div>
            <div data-action="sendBackward">Send Backward <span class="shortcut">Ctrl+[</span></div>
          </div>
        </div>
        <div>Transform &darr;
          <div class="submenu">
            <div data-action="rotateSelectionCW">Rotate 90\u00b0 CW</div>
            <div data-action="rotateSelectionCCW">Rotate 90\u00b0 CCW</div>
            <hr>
            <div data-action="flipSelectionHorizontal">Flip Horizontal</div>
            <div data-action="flipSelectionVertical">Flip Vertical</div>
            <hr>
            <div data-action="showTransformDialog">Transform...</div>
          </div>
        </div>
        <hr>
        <div>Pathfinder &darr;
          <div class="submenu">
            <div data-action="pathfinderUnite">Unite</div>
            <div data-action="pathfinderMinus">Minus Front</div>
            <div data-action="pathfinderIntersect">Intersect</div>
            <div data-action="pathfinderExclude">Exclude</div>
            <hr>
            <div data-action="pathfinderDivide">Divide</div>
            <div data-action="pathfinderTrim">Trim</div>
            <div data-action="pathfinderMerge">Merge</div>
            <hr>
            <div data-action="pathfinderCrop">Crop</div>
            <div data-action="pathfinderOutline">Outline</div>
          </div>
        </div>
      </div>
    </div>
    <div>Type
      <div class="dropdown">
        <div data-action="createOutlines">Create Outlines <span class="shortcut">Ctrl+Shift+O</span></div>
        <div data-action="findFont">Find Font...</div>
      </div>
    </div>
    <div>Select
      <div class="dropdown">
        <div data-action="selectAll">All <span class="shortcut">Ctrl+A</span></div>
        <div data-action="deselectAll">Deselect <span class="shortcut">Ctrl+Shift+A</span></div>
        <hr>
        <div data-action="selectSameFill">Same Fill Color</div>
        <div data-action="selectSameStroke">Same Stroke Color</div>
        <div data-action="selectSameStrokeWidth">Same Stroke Width</div>
      </div>
    </div>
    <div>View
      <div class="dropdown">
        <div data-action="zoomIn">Zoom In <span class="shortcut">Ctrl++</span></div>
        <div data-action="zoomOut">Zoom Out <span class="shortcut">Ctrl+-</span></div>
        <div data-action="zoomToFit">Fit to Screen <span class="shortcut">Ctrl+0</span></div>
        <div data-action="zoomTo100">100% <span class="shortcut">Ctrl+1</span></div>
        <hr>
        <div data-action="toggleGrid">Grid <span class="shortcut">Ctrl+'</span></div>
        <div data-action="toggleRulers">Rulers <span class="shortcut">Ctrl+R</span></div>
        <div data-action="toggleSnap">Snap to Grid <span class="shortcut">Ctrl+Shift+'</span></div>
      </div>
    </div>
    <div>Window
      <div class="dropdown">
        <div data-action="showPanelProperties">Properties</div>
        <div data-action="showPanelLayers">Layers <span class="shortcut">F7</span></div>
        <div data-action="showPanelAppearance">Appearance <span class="shortcut">Shift+F6</span></div>
        <div data-action="showPanelSwatches">Swatches</div>
        <div data-action="showPanelGradient">Gradient</div>
        <div data-action="showPanelStroke">Stroke</div>
        <div data-action="showPanelAlign">Align <span class="shortcut">Shift+F7</span></div>
        <div data-action="showPanelCharacter">Character</div>
        <div data-action="showPanelParagraph">Paragraph</div>
      </div>
    </div>
  </div>
</div>

<div id="container">
  <!-- Hidden file inputs -->
  <input type="file" id="openFile" accept=".svg,.json" style="display:none">
  <input type="file" id="placeImage" accept="image/*" style="display:none">

  <!-- Tool/Panel Name Notification -->
  <div class="tool-notification" id="toolNotification"></div>

  <div id="canvas-container">
    <div id="loader">Vector Editor Pro \u2022 Initializing...</div>
    
    <!-- Rulers -->
    <div class="ruler-corner" id="rulerCorner"></div>
    <div class="ruler ruler-h" id="rulerH"></div>
    <div class="ruler ruler-v" id="rulerV"></div>
    
    <canvas id="canvas" resize></canvas>
    
    <!-- Artboard indicator -->
    <div id="artboardIndicator" class="artboard" style="display:none">
      <div class="artboard-label">Artboard 1</div>
    </div>
  </div>

  <!-- Left Toolbar -->
  <div id="floatingToolbar">
    <div class="tool-group">
      <div class="tool-btn active" id="selectTool" title="Selection Tool (V)" data-tool="select">\u2b1a</div>
      <div class="tool-btn" id="directSelectTool" title="Direct Selection Tool (A)" data-tool="directSelect">\u2196</div>
      <div class="tool-btn" id="magicWandTool" title="Magic Wand Tool (Y)" data-tool="select">\u2726</div>
    </div>
    <div class="tool-group">
      <div class="tool-btn" id="penTool" title="Pen Tool (P)" data-tool="pen">\u2712</div>
      <div class="tool-btn" id="pencilTool" title="Pencil Tool (N)" data-tool="pencil">\u270e</div>
      <div class="tool-btn" id="brushTool" title="Brush Tool (B)" data-tool="brush">\ud83d\udd8c</div>
    </div>
    <div class="tool-group">
      <div class="tool-btn" id="rectangleTool" title="Rectangle Tool (M)" data-tool="rectangle">\u25a1</div>
      <div class="tool-btn" id="ellipseTool" title="Ellipse Tool (L)" data-tool="ellipse">\u25cb</div>
      <div class="tool-btn" id="polygonTool" title="Polygon Tool" data-tool="polygon">\u2b21</div>
      <div class="tool-btn" id="starTool" title="Star Tool" data-tool="star">\u2605</div>
      <div class="tool-btn" id="lineTool" title="Line Tool (/)" data-tool="line">\u2571</div>
    </div>
    <div class="tool-group">
      <div class="tool-btn" id="typeTool" title="Type Tool (T)" data-tool="type">T</div>
      <div class="tool-btn" id="typeOnPathTool" title="Type on Path Tool" data-tool="type">\u219d</div>
      <div class="tool-btn" id="touchTypeTool" title="Touch Type Tool" data-tool="type">\ud835\udce3</div>
    </div>
    <div class="tool-group">
      <div class="tool-btn" id="shapeBuilderTool" title="Shape Builder Tool (Shift+M)" data-tool="select">\u29c6</div>
      <div class="tool-btn" id="perspectiveGridTool" title="Perspective Grid Tool" data-tool="select">\u25a6</div>
      <div class="tool-btn" id="freeTransformTool" title="Free Transform Tool (E)" data-tool="select">\u2921</div>
    </div>
    <div class="tool-group">
      <div class="tool-btn" id="eyedropperTool" title="Eyedropper Tool (I)" data-tool="eyedropper">\ud83d\udca7</div>
      <div class="tool-btn" id="measureTool" title="Measure Tool" data-tool="select">\ud83d\udccf</div>
    </div>
    <div class="tool-group">
      <div class="tool-btn" id="handTool" title="Hand Tool (H)" data-tool="hand">\u270b</div>
      <div class="tool-btn" id="zoomTool" title="Zoom Tool (Z)" data-tool="zoom">\ud83d\udd0d</div>
    </div>
    <div class="tool-group">
      <div class="tool-btn" id="fillColor" title="Fill Color">\u25d0</div>
      <div class="tool-btn" id="strokeColor" title="Stroke Color">\u2b58</div>
      <div class="tool-btn" id="defaultColors" title="Default Colors">\u26ac</div>
    </div>
  </div>

  <!-- Right Panel Dock -->
  <div class="panel-dock visible" id="panelDock">
    <button id="dockToggle">\u25c0</button>
    
    <div class="panel-tabs">
      <button class="panel-tab active" data-panel="properties">Properties</button>
      <button class="panel-tab" data-panel="layers">Layers</button>
      <button class="panel-tab" data-panel="appearance">Appearance</button>
      <button class="panel-tab" data-panel="swatches">Swatches</button>
      <button class="panel-tab" data-panel="gradient">Gradient</button>
      <button class="panel-tab" data-panel="stroke">Stroke</button>
      <button class="panel-tab" data-panel="align">Align</button>
      <button class="panel-tab" data-panel="character">Character</button>
      <button class="panel-tab" data-panel="paragraph">Paragraph</button>
      <button class="panel-close-btn" id="panelCloseBtn" title="Close Panel">\u00d7</button>
    </div>
    
    <div class="panel-content">
      <!-- Properties Panel -->
      <div id="panel-properties" class="panel-section active">
        <h3>Transform</h3>
        <div class="control-row">
          <div class="control-group" style="flex:1">
            <label for="propX">X</label>
            <input type="number" id="propX">
          </div>
          <div class="control-group" style="flex:1">
            <label for="propY">Y</label>
            <input type="number" id="propY">
          </div>
        </div>
        <div class="control-row">
          <div class="control-group" style="flex:1">
            <label for="propW">W</label>
            <input type="number" id="propW">
          </div>
          <div class="control-group" style="flex:1">
            <label for="propH">H</label>
            <input type="number" id="propH">
          </div>
        </div>
        <div class="control-row">
          <div class="control-group" style="flex:1">
            <label for="propRotation">Rotation</label>
            <input type="number" id="propRotation">
          </div>
          <div class="control-group" style="flex:1">
            <label for="propShear">Shear</label>
            <input type="number" id="propShear">
          </div>
        </div>
        <div class="control-group">
          <label for="propOpacity">Opacity <span id="opacityVal">100</span>%</label>
          <input type="range" id="propOpacity" min="0" max="100" value="100">
        </div>
        <div class="control-group">
          <label for="propBlendMode">Blend Mode</label>
          <select id="propBlendMode">
            <option value="normal">Normal</option>
            <option value="multiply">Multiply</option>
            <option value="screen">Screen</option>
            <option value="overlay">Overlay</option>
            <option value="darken">Darken</option>
            <option value="lighten">Lighten</option>
            <option value="color-dodge">Color Dodge</option>
            <option value="color-burn">Color Burn</option>
            <option value="hard-light">Hard Light</option>
            <option value="soft-light">Soft Light</option>
            <option value="difference">Difference</option>
            <option value="exclusion">Exclusion</option>
            <option value="hue">Hue</option>
            <option value="saturation">Saturation</option>
            <option value="color">Color</option>
            <option value="luminosity">Luminosity</option>
          </select>
        </div>
        
        <h3>Geometry</h3>
        <div class="control-row">
          <button class="btn btn-sm" data-action="convertToPoint">Convert to Point</button>
          <button class="btn btn-sm" data-action="convertToCurve">Convert to Curve</button>
        </div>
      </div>

      <!-- Layers Panel -->
      <div id="panel-layers" class="panel-section">
        <div class="control-row" style="margin-bottom: 1rem;">
          <button class="btn btn-sm" data-action="addLayer">+ New Layer</button>
          <button class="btn btn-sm" data-action="deleteLayer">Delete Layer</button>
        </div>
        <div id="layersList">
          <!-- Layers will be populated dynamically -->
        </div>
      </div>

      <!-- Appearance Panel -->
      <div id="panel-appearance" class="panel-section">
        <div class="control-row" style="margin-bottom: 1rem;">
          <button class="btn btn-sm btn-primary" data-action="addFill">+ Add Fill</button>
          <button class="btn btn-sm" data-action="addStroke">+ Add Stroke</button>
        </div>
        <div id="appearanceList">
          <!-- Appearance items will be populated dynamically -->
        </div>
        <h3>Effects</h3>
        <button class="btn btn-sm" style="width:100%">+ Add Effect</button>
      </div>

      <!-- Swatches Panel -->
      <div id="panel-swatches" class="panel-section">
        <div class="control-row" style="margin-bottom: 1rem;">
          <button class="btn btn-sm" data-action="addSwatch">+ New Swatch</button>
          <button class="btn btn-sm" data-action="clearSwatches">Clear</button>
        </div>
        <div class="swatch-grid" id="swatchGrid">
          <!-- Swatches will be populated dynamically -->
        </div>
      </div>

      <!-- Gradient Panel -->
      <div id="panel-gradient" class="panel-section">
        <h3>Gradient Type</h3>
        <div class="btn-group" style="margin-bottom: 1rem;">
          <button class="btn" data-action="gradientLinear">Linear</button>
          <button class="btn" data-action="gradientRadial">Radial</button>
        </div>
        
        <h3>Gradient Stops</h3>
        <div id="gradientStops">
          <div class="control-row">
            <div class="control-group" style="flex:1">
              <label for="gradientStop1">Stop 1</label>
              <input type="color" id="gradientStop1" value="#60a5fa">
            </div>
            <div class="control-group" style="flex:1">
              <label for="gradientPos1">Position</label>
              <input type="range" id="gradientPos1" min="0" max="100" value="0">
            </div>
          </div>
          <div class="control-row">
            <div class="control-group" style="flex:1">
              <label for="gradientStop2">Stop 2</label>
              <input type="color" id="gradientStop2" value="#020617">
            </div>
            <div class="control-group" style="flex:1">
              <label for="gradientPos2">Position</label>
              <input type="range" id="gradientPos2" min="0" max="100" value="100">
            </div>
          </div>
        </div>
        
        <h3>Angle</h3>
        <div class="control-row">
          <input type="range" id="gradientAngle" min="0" max="360" value="0">
          <span id="gradientAngleVal">0\u00b0</span>
        </div>
      </div>

      <!-- Stroke Panel -->
      <div id="panel-stroke" class="panel-section">
        <div class="control-group">
          <label for="strokeWeight">Weight</label>
          <input type="range" id="strokeWeight" min="0" max="100" value="1">
          <span id="strokeWeightVal">1 px</span>
        </div>
        <div class="control-group">
          <label>Cap</label>
          <div class="btn-group">
            <button class="btn" data-action="strokeCapButt">Butt</button>
            <button class="btn" data-action="strokeCapRound">Round</button>
            <button class="btn" data-action="strokeCapSquare">Square</button>
          </div>
        </div>
        <div class="control-group">
          <label>Join</label>
          <div class="btn-group">
            <button class="btn" data-action="strokeJoinMiter">Miter</button>
            <button class="btn" data-action="strokeJoinRound">Round</button>
            <button class="btn" data-action="strokeJoinBevel">Bevel</button>
          </div>
        </div>
        <div class="control-group">
          <label for="strokeDash">Dash Array</label>
          <input type="text" id="strokeDash" placeholder="5,5">
        </div>
        <div class="control-group">
          <label for="strokeColorInput">Color</label>
          <input type="color" id="strokeColorInput" value="#000000">
        </div>
      </div>

      <!-- Align Panel -->
      <div id="panel-align" class="panel-section">
        <h3>Align Objects</h3>
        <div class="align-grid">
          <button class="align-btn" data-action="alignLeft" title="Align Left">\u2b05</button>
          <button class="align-btn" data-action="alignCenterH" title="Align Center">\u2b0c</button>
          <button class="align-btn" data-action="alignRight" title="Align Right">\u27a1</button>
          <button class="align-btn" data-action="alignTop" title="Align Top">\u2b06</button>
          <button class="align-btn" data-action="alignCenterV" title="Align Center">\u2b0d</button>
          <button class="align-btn" data-action="alignBottom" title="Align Bottom">\u2b07</button>
        </div>
        
        <h3>Distribute Objects</h3>
        <div class="align-grid">
          <button class="align-btn" data-action="distributeLeft">\u2af7</button>
          <button class="align-btn" data-action="distributeCenterH">\u2af8</button>
          <button class="align-btn" data-action="distributeRight">\u2af9</button>
          <button class="align-btn" data-action="distributeTop">\u2b0f</button>
          <button class="align-btn" data-action="distributeCenterV">\u2b0e</button>
          <button class="align-btn" data-action="distributeBottom">\u2b10</button>
        </div>
      </div>

      <!-- Character Panel -->
      <div id="panel-character" class="panel-section">
        <div class="control-group">
          <label for="fontFamily">Font Family</label>
          <select id="fontFamily">
            <option value="Arial">Arial</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Georgia">Georgia</option>
            <option value="Verdana">Verdana</option>
            <option value="Courier New">Courier New</option>
            <option value="Impact">Impact</option>
            <option value="Comic Sans MS">Comic Sans MS</option>
          </select>
        </div>
        <div class="control-row">
          <div class="control-group" style="flex:1">
            <label for="fontSize">Font Size</label>
            <input type="number" id="fontSize" value="32">
          </div>
          <div class="control-group" style="flex:1">
            <label for="lineHeight">Leading</label>
            <input type="number" id="lineHeight" value="40">
          </div>
        </div>
        <div class="control-row">
          <div class="control-group" style="flex:1">
            <label for="letterSpacing">Tracking</label>
            <input type="number" id="letterSpacing" value="0">
          </div>
        </div>
        <div class="btn-group" style="margin-bottom: 1rem;">
          <button class="btn" data-action="fontStyleBold">B</button>
          <button class="btn" data-action="fontStyleItalic">I</button>
          <button class="btn" data-action="fontStyleUnderline">U</button>
        </div>
        <div class="btn-group">
          <button class="btn" data-action="textAlignLeft">\u2b05</button>
          <button class="btn" data-action="textAlignCenter">\u2b0c</button>
          <button class="btn" data-action="textAlignRight">\u27a1</button>
          <button class="btn" data-action="textAlignJustify">\u2261</button>
        </div>
      </div>

      <!-- Paragraph Panel -->
      <div id="panel-paragraph" class="panel-section">
        <div class="control-group">
          <label>Alignment</label>
          <div class="btn-group">
            <button class="btn" data-action="textAlignLeft">Left</button>
            <button class="btn" data-action="textAlignCenter">Center</button>
            <button class="btn" data-action="textAlignRight">Right</button>
            <button class="btn" data-action="textAlignJustify">Justify</button>
          </div>
        </div>
        <div class="control-row">
          <div class="control-group" style="flex:1">
            <label for="indentLeft">Left Indent</label>
            <input type="number" id="indentLeft" value="0">
          </div>
          <div class="control-group" style="flex:1">
            <label for="indentRight">Right Indent</label>
            <input type="number" id="indentRight" value="0">
          </div>
        </div>
        <div class="control-group">
          <label for="indentFirst">First Line Indent</label>
          <input type="number" id="indentFirst" value="0">
        </div>
        <div class="control-group">
          <label for="spaceBefore">Space Before</label>
          <input type="number" id="spaceBefore" value="0">
        </div>
        <div class="control-group">
          <label for="spaceAfter">Space After</label>
          <input type="number" id="spaceAfter" value="0">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Status Bar -->
<div class="status-bar">
  <div class="left">
    <span id="statusTool">Selection Tool</span>
    <span id="statusZoom">100%</span>
    <span id="statusPosition">X: 0 Y: 0</span>
  </div>
  <div class="right">
    <span id="statusSelection">No selection</span>
    <span id="statusMemory">Document: Untitled</span>
  </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
  <div data-action="copy">Copy</div>
  <div data-action="paste">Paste</div>
  <div data-action="duplicate">Duplicate</div>
  <hr>
  <div data-action="bringToFront">Bring to Front</div>
  <div data-action="sendToBack">Send to Back</div>
  <hr>
  <div data-action="groupSelection">Group</div>
  <div data-action="ungroupSelection">Ungroup</div>
  <hr>
  <div data-action="deleteSelection">Delete</div>
</div>

<!-- Firebase Auth -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB4JMVBMcWcN2wKsaVYmnggHH5ue1mUfaA",
  authDomain: "bowesproduct.firebaseapp.com",
  projectId: "bowesproduct"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const authBtn = document.getElementById("authBtn");
const profilePic = document.getElementById("profilePic");
const levelInfo = document.getElementById("levelInfo");
const levelText = document.getElementById("levelText");
const xpBar = document.getElementById("xpBar");

authBtn.onclick = () => auth.currentUser ? signOut(auth) : signInWithPopup(auth, provider);

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    authBtn.textContent = "Login";
    profilePic.style.display = "none";
    levelInfo.style.display = "none";
    return;
  }
  authBtn.textContent = "Logout";
  profilePic.src = user.photoURL || "";
  profilePic.style.display = "block";

  const ref = doc(db, "users", user.uid);
  let snap = await getDoc(ref);
  if (!snap.exists()) {
    await setDoc(ref, { xp: 10 });
    snap = await getDoc(ref);
  }
  const xp = snap.data().xp || 0;
  const levels = [0, 200, 500, 1000, 2000];
  let level = levels.filter(v => xp >= v).length - 1;
  let next = levels[level + 1] ?? levels[level];
  let progress = next === levels[level] ? 100 :
    ((xp - levels[level]) / (next - levels[level])) * 100;

  levelText.textContent = `Level ${level} \u2022 ${xp} XP`;
  xpBar.style.width = progress + "%";
  levelInfo.style.display = "block";
});
</script>

<!-- Paper.js Vector Editor -->
<script type="text/paperscript" canvas="canvas">
// IMPORTANT: This script runs in Paper.js scope
console.log('Paper.js script starting...');

// Global state
var tools = {};
var currentTool;
var fillColor = new Color('#ff0000');
var strokeColor = new Color('#000000');
var strokeWidth = 1;
var currentPath;
var isDrawing = false;
var startPoint;
var currentShape;
var clipboard = null;
var undoStack = [];
var redoStack = [];
var showGrid = false;
var showRulers = true;
var snapToGrid = false;
var gridSize = 20;
var layers = [];
var currentLayerIndex = 0;
var zoomLevel = 1;
var documentWidth = 1920;
var documentHeight = 1080;

console.log('Paper.js initialized, view size:', view.size);

// Initialize layers
function initLayers() {
  layers = [
    { name: 'Layer 1', visible: true, locked: false, items: [] }
  ];
  console.log('Layers initialized:', layers);
  updateLayersList();
}

// Create artboard based on document size
function createArtboard() {
  var artboard = document.getElementById('artboardIndicator');
  var canvasRect = document.getElementById('canvas').getBoundingClientRect();
  
  // Calculate scale to fit document in view
  var scaleX = (view.size.width - 100) / documentWidth;
  var scaleY = (view.size.height - 100) / documentHeight;
  var scale = Math.min(scaleX, scaleY, 1);
  
  var artboardWidth = documentWidth * scale;
  var artboardHeight = documentHeight * scale;
  
  artboard.style.left = ((view.size.width - artboardWidth) / 2 + 60) + 'px';
  artboard.style.top = ((view.size.height - artboardHeight) / 2 + 20) + 'px';
  artboard.style.width = artboardWidth + 'px';
  artboard.style.height = artboardHeight + 'px';
  artboard.style.display = 'block';
}

// Tool/Panel Notification System
var notificationTimeout;

function showToolNotification(text) {
  var notification = document.getElementById('toolNotification');
  
  // Clear existing timeout
  if (notificationTimeout) {
    clearTimeout(notificationTimeout);
  }
  
  // Reset animation
  notification.classList.remove('show', 'hide');
  notification.textContent = text;
  
  // Show notification
  requestAnimationFrame(function() {
    notification.classList.add('show');
  });
  
  // Hide after delay
  notificationTimeout = setTimeout(function() {
    notification.classList.remove('show');
    notification.classList.add('hide');
  }, 1500);
}

// Tool activation
function activateTool(name) {
  if (tools[name]) {
    currentTool = tools[name];
    currentTool.activate();
    console.log('Tool activated:', name);
    document.querySelectorAll('.tool-btn').forEach(function(b) { b.classList.remove('active'); });
    var btn = document.getElementById(name + 'Tool');
    if (btn) btn.classList.add('active');
    
    var toolNames = {
      'select': 'Selection Tool',
      'directSelect': 'Direct Selection Tool',
      'pen': 'Pen Tool',
      'pencil': 'Pencil Tool',
      'brush': 'Brush Tool',
      'rectangle': 'Rectangle Tool',
      'ellipse': 'Ellipse Tool',
      'polygon': 'Polygon Tool',
      'star': 'Star Tool',
      'line': 'Line Tool',
      'type': 'Type Tool',
      'typeOnPath': 'Type on Path Tool',
      'touchType': 'Touch Type Tool',
      'shapeBuilder': 'Shape Builder Tool',
      'perspectiveGrid': 'Perspective Grid Tool',
      'freeTransform': 'Free Transform Tool',
      'eyedropper': 'Eyedropper Tool',
      'measure': 'Measure Tool',
      'hand': 'Hand Tool',
      'zoom': 'Zoom Tool'
    };
    
    var statusTool = document.getElementById('statusTool');
    if (statusTool && toolNames[name]) {
      statusTool.textContent = toolNames[name];
    }
    
    // Show notification popup
    if (toolNames[name]) {
      showToolNotification(toolNames[name]);
    }
  } else {
    console.warn('Tool not found:', name);
  }
}

// Selection Tool
tools.select = new Tool();
tools.select.onMouseDown = function(event) {
  var hit = project.hitTest(event.point, {
    fill: true, stroke: true, segments: true, tolerance: 5
  });
  
  if (hit && hit.item && !hit.item.locked) {
    if (!Key.modifiers.shift) {
      project.deselectAll();
    }
    hit.item.selected = true;
  } else if (!Key.modifiers.shift) {
    project.deselectAll();
  }
  
  updateProperties();
};

tools.select.onMouseDrag = function(event) {
  if (project.selectedItems.length) {
    var delta = event.delta;
    if (snapToGrid) {
      delta.x = Math.round(delta.x / gridSize) * gridSize;
      delta.y = Math.round(delta.y / gridSize) * gridSize;
    }
    project.selectedItems.forEach(function(item) {
      if (!item.locked) {
        item.position += delta;
      }
    });
    updateProperties();
  }
};

tools.select.onMouseUp = function() {
  saveState();
};

// Direct Selection Tool
tools.directSelect = new Tool();
tools.directSelect.onMouseDown = function(event) {
  var hit = project.hitTest(event.point, {
    segments: true, tolerance: 5
  });
  
  if (hit && hit.segment) {
    hit.segment.selected = true;
  } else {
    project.deselectAll();
  }
};

tools.directSelect.onMouseDrag = function(event) {
  var selectedSegments = project.activeLayer.segments.filter(function(s) {
    return s.selected;
  });
  
  if (selectedSegments.length) {
    selectedSegments.forEach(function(segment) {
      segment.point += event.delta;
    });
  }
};

// Pen Tool
tools.pen = new Tool();
var penPoints = [];

tools.pen.onMouseDown = function(event) {
  if (Key.modifiers.alt) {
    // Convert point to curve
    var hit = project.hitTest(event.point, { segments: true, tolerance: 5 });
    if (hit && hit.segment) {
      if (hit.segment.hasHandles()) {
        hit.segment.clearHandles();
      } else {
        hit.segment.handleIn = new Point(-20, 0);
        hit.segment.handleOut = new Point(20, 0);
      }
    }
    return;
  }
  
  if (currentPath && penPoints.length > 0 && event.point.isClose(penPoints[0], 5)) {
    // Close path
    currentPath.closed = true;
    currentPath.fillColor = fillColor;
    currentPath.strokeColor = strokeColor;
    currentPath.strokeWidth = strokeWidth;
    currentPath.simplify();
    currentPath.selected = true;
    penPoints = [];
    currentPath = null;
    saveState();
    return;
  }
  
  if (!currentPath) {
    currentPath = new Path();
    currentPath.strokeColor = strokeColor;
    currentPath.strokeWidth = strokeWidth;
    penPoints = [];
  }
  
  currentPath.add(event.point);
  penPoints.push(event.point);
};

tools.pen.onMouseMove = function(event) {
  if (currentPath && penPoints.length > 0) {
    // Draw preview line
    document.body.style.cursor = 'crosshair';
  }
};

tools.pen.onMouseDrag = function(event) {
  if (currentPath && penPoints.length > 0) {
    // Adjust handles for last point
    var lastSegment = currentPath.lastSegment;
    if (lastSegment) {
      lastSegment.handleOut = event.point - lastSegment.point;
      lastSegment.handleIn = lastSegment.handleOut.rotate(180);
    }
  }
};

tools.pen.onKeyDown = function(event) {
  if (event.key === 'escape') {
    if (currentPath) {
      if (currentPath.segments.length > 1) {
        currentPath.fillColor = fillColor;
        currentPath.simplify();
        saveState();
      } else {
        currentPath.remove();
      }
      currentPath = null;
      penPoints = [];
    }
  } else if (event.key === 'enter') {
    if (currentPath) {
      currentPath.closed = true;
      currentPath.fillColor = fillColor;
      currentPath.strokeColor = strokeColor;
      currentPath.strokeWidth = strokeWidth;
      currentPath.simplify();
      currentPath.selected = true;
      currentPath = null;
      penPoints = [];
      saveState();
    }
  }
};

// Pencil Tool
tools.pencil = new Tool();
tools.pencil.minDistance = 5;

tools.pencil.onMouseDown = function(event) {
  currentPath = new Path();
  currentPath.strokeColor = strokeColor;
  currentPath.strokeWidth = strokeWidth;
  currentPath.add(event.point);
};

tools.pencil.onMouseDrag = function(event) {
  currentPath.add(event.point);
};

tools.pencil.onMouseUp = function(event) {
  if (currentPath) {
    currentPath.simplify();
    currentPath.fillColor = fillColor;
    currentPath.selected = true;
    saveState();
    currentPath = null;
  }
};

// Brush Tool
tools.brush = new Tool();
tools.brush.minDistance = 2;

tools.brush.onMouseDown = function(event) {
  currentPath = new Path();
  currentPath.strokeColor = strokeColor;
  currentPath.strokeWidth = strokeWidth;
  currentPath.strokeCap = 'round';
  currentPath.strokeJoin = 'round';
  currentPath.add(event.point);
};

tools.brush.onMouseDrag = function(event) {
  currentPath.add(event.point);
};

tools.brush.onMouseUp = function(event) {
  if (currentPath) {
    currentPath.smooth();
    currentPath.fillColor = fillColor;
    currentPath.selected = true;
    saveState();
    currentPath = null;
  }
};

// Rectangle Tool
tools.rectangle = new Tool();

tools.rectangle.onMouseDown = function(event) {
  startPoint = event.point;
  currentShape = new Path.Rectangle(startPoint, startPoint);
  currentShape.fillColor = fillColor;
  currentShape.strokeColor = strokeColor;
  currentShape.strokeWidth = strokeWidth;
};

tools.rectangle.onMouseDrag = function(event) {
  if (currentShape) {
    var rect = new Rectangle(startPoint, event.point);
    if (Key.modifiers.shift) {
      // Constrain to square
      var size = Math.max(Math.abs(rect.width), Math.abs(rect.height));
      rect = new Rectangle(startPoint, new Point(startPoint.x + size, startPoint.y + size));
    }
    currentShape.remove();
    currentShape = new Path.Rectangle(rect);
    currentShape.fillColor = fillColor;
    currentShape.strokeColor = strokeColor;
    currentShape.strokeWidth = strokeWidth;
  }
};

tools.rectangle.onMouseUp = function() {
  if (currentShape) {
    currentShape.selected = true;
    saveState();
    currentShape = null;
  }
};

// Ellipse Tool
tools.ellipse = new Tool();

tools.ellipse.onMouseDown = function(event) {
  startPoint = event.point;
  currentShape = new Path.Ellipse({
    center: startPoint,
    radius: [0, 0]
  });
  currentShape.fillColor = fillColor;
  currentShape.strokeColor = strokeColor;
  currentShape.strokeWidth = strokeWidth;
};

tools.ellipse.onMouseDrag = function(event) {
  if (currentShape) {
    var rect = new Rectangle(startPoint, event.point);
    if (Key.modifiers.shift) {
      // Constrain to circle
      var size = Math.max(Math.abs(rect.width), Math.abs(rect.height));
      rect = new Rectangle(startPoint, new Point(startPoint.x + size, startPoint.y + size));
    }
    currentShape.remove();
    currentShape = new Path.Ellipse(rect);
    currentShape.fillColor = fillColor;
    currentShape.strokeColor = strokeColor;
    currentShape.strokeWidth = strokeWidth;
  }
};

tools.ellipse.onMouseUp = function() {
  if (currentShape) {
    currentShape.selected = true;
    saveState();
    currentShape = null;
  }
};

// Polygon Tool
tools.polygon = new Tool();

tools.polygon.onMouseDown = function(event) {
  startPoint = event.point;
  var sides = 6;
  currentShape = new Path.RegularPolygon(startPoint, 0, sides);
  currentShape.fillColor = fillColor;
  currentShape.strokeColor = strokeColor;
  currentShape.strokeWidth = strokeWidth;
};

tools.polygon.onMouseDrag = function(event) {
  if (currentShape) {
    var radius = startPoint.getDistance(event.point);
    var sides = 6;
    currentShape.remove();
    currentShape = new Path.RegularPolygon(startPoint, radius, sides);
    currentShape.fillColor = fillColor;
    currentShape.strokeColor = strokeColor;
    currentShape.strokeWidth = strokeWidth;
  }
};

tools.polygon.onMouseUp = function() {
  if (currentShape) {
    currentShape.selected = true;
    saveState();
    currentShape = null;
  }
};

// Star Tool
tools.star = new Tool();

tools.star.onMouseDown = function(event) {
  startPoint = event.point;
  var points = 5;
  currentShape = new Path.Star(startPoint, 0, 0, 0, points);
  currentShape.fillColor = fillColor;
  currentShape.strokeColor = strokeColor;
  currentShape.strokeWidth = strokeWidth;
};

tools.star.onMouseDrag = function(event) {
  if (currentShape) {
    var outerRadius = startPoint.getDistance(event.point);
    var innerRadius = outerRadius * 0.4;
    var points = 5;
    currentShape.remove();
    currentShape = new Path.Star(startPoint, innerRadius, outerRadius, points);
    currentShape.fillColor = fillColor;
    currentShape.strokeColor = strokeColor;
    currentShape.strokeWidth = strokeWidth;
  }
};

tools.star.onMouseUp = function() {
  if (currentShape) {
    currentShape.selected = true;
    saveState();
    currentShape = null;
  }
};

// Line Tool
tools.line = new Tool();

tools.line.onMouseDown = function(event) {
  startPoint = event.point;
  currentShape = new Path.Line(startPoint, startPoint);
  currentShape.strokeColor = strokeColor;
  currentShape.strokeWidth = strokeWidth;
};

tools.line.onMouseDrag = function(event) {
  if (currentShape) {
    if (Key.modifiers.shift) {
      // Constrain to 45-degree angles
      var angle = Math.atan2(event.point.y - startPoint.y, event.point.x - startPoint.x);
      angle = Math.round(angle / (Math.PI / 4)) * (Math.PI / 4);
      var length = startPoint.getDistance(event.point);
      var endPoint = new Point(
        startPoint.x + length * Math.cos(angle),
        startPoint.y + length * Math.sin(angle)
      );
      currentShape.remove();
      currentShape = new Path.Line(startPoint, endPoint);
    } else {
      currentShape.remove();
      currentShape = new Path.Line(startPoint, event.point);
    }
    currentShape.strokeColor = strokeColor;
    currentShape.strokeWidth = strokeWidth;
  }
};

tools.line.onMouseUp = function() {
  if (currentShape) {
    currentShape.selected = true;
    saveState();
    currentShape = null;
  }
};

// Type Tool
tools.type = new Tool();

tools.type.onMouseDown = function(event) {
  var text = prompt('Enter text:', 'Sample Text');
  if (text) {
    var pointText = new PointText(event.point);
    pointText.content = text;
    pointText.fillColor = fillColor;
    pointText.fontSize = 32;
    pointText.fontFamily = 'Arial';
    pointText.selected = true;
    saveState();
  }
};

// Eyedropper Tool
tools.eyedropper = new Tool();

tools.eyedropper.onMouseDown = function(event) {
  var hit = project.hitTest(event.point, {
    fill: true, stroke: true, tolerance: 5
  });
  
  if (hit && hit.item) {
    if (hit.type === 'fill' && hit.item.fillColor) {
      fillColor = hit.item.fillColor.clone();
      var colorHex = fillColor.toCSS(true);
      document.getElementById('fillColor').style.backgroundColor = colorHex;
    }
    if (hit.type === 'stroke' && hit.item.strokeColor) {
      strokeColor = hit.item.strokeColor.clone();
      var colorHex = strokeColor.toCSS(true);
      document.getElementById('strokeColor').style.backgroundColor = colorHex;
    }
  }
};

// Hand Tool (Pan)
tools.hand = new Tool();
var handStart;

tools.hand.onMouseDown = function(event) {
  handStart = event.point;
  document.body.style.cursor = 'grabbing';
};

tools.hand.onMouseDrag = function(event) {
  var delta = event.point.subtract(handStart);
  view.center = view.center.subtract(delta);
};

tools.hand.onMouseUp = function() {
  document.body.style.cursor = 'default';
};

// Zoom Tool
tools.zoom = new Tool();

tools.zoom.onMouseDown = function(event) {
  var zoomFactor = Key.modifiers.alt ? 0.8 : 1.25;
  view.zoom = view.zoom * zoomFactor;
  view.center = event.point;
  updateZoomDisplay();
};

// Update properties panel
function updateProperties() {
  var item = project.selectedItems[0];
  var propX = document.getElementById('propX');
  var propY = document.getElementById('propY');
  var propW = document.getElementById('propW');
  var propH = document.getElementById('propH');
  var propRotation = document.getElementById('propRotation');
  var propShear = document.getElementById('propShear');
  var propOpacity = document.getElementById('propOpacity');
  var propBlendMode = document.getElementById('propBlendMode');
  
  if (item) {
    if (propX) propX.value = Math.round(item.position.x);
    if (propY) propY.value = Math.round(item.position.y);
    if (propW) propW.value = Math.round(item.bounds.width);
    if (propH) propH.value = Math.round(item.bounds.height);
    if (propRotation) propRotation.value = Math.round(item.rotation);
    if (propShear) propShear.value = Math.round(item.shear ? item.shear.x : 0);
    if (propOpacity) propOpacity.value = (item.opacity || 1) * 100;
    if (propBlendMode) propBlendMode.value = item.blendMode || 'normal';
    
    var statusSelection = document.getElementById('statusSelection');
    if (statusSelection) {
      statusSelection.textContent = item.className + ' selected';
    }
  } else {
    if (propX) propX.value = '';
    if (propY) propY.value = '';
    if (propW) propW.value = '';
    if (propH) propH.value = '';
    if (propRotation) propRotation.value = '';
    if (propShear) propShear.value = '';
    
    var statusSelection = document.getElementById('statusSelection');
    if (statusSelection) {
      statusSelection.textContent = 'No selection';
    }
  }
}

// Update transform from properties panel
function updateTransform() {
  var item = project.selectedItems[0];
  if (!item) return;
  
  var x = parseFloat(document.getElementById('propX').value);
  var y = parseFloat(document.getElementById('propY').value);
  var w = parseFloat(document.getElementById('propW').value);
  var h = parseFloat(document.getElementById('propH').value);
  var rotation = parseFloat(document.getElementById('propRotation').value);
  var shear = parseFloat(document.getElementById('propShear').value);
  
  if (!isNaN(x) && !isNaN(y)) {
    item.position = new Point(x, y);
  }
  if (!isNaN(w) && !isNaN(h)) {
    item.bounds.width = w;
    item.bounds.height = h;
  }
  if (!isNaN(rotation)) {
    item.rotation = rotation;
  }
  if (!isNaN(shear)) {
    item.shear = new Point(shear, 0);
  }
  
  saveState();
}

// Update opacity
function updateOpacity() {
  var opacity = parseFloat(document.getElementById('propOpacity').value);
  document.getElementById('opacityVal').textContent = opacity;
  
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.opacity = opacity / 100;
    });
  }
}

// Update blend mode
function updateBlendMode() {
  var blendMode = document.getElementById('propBlendMode').value;
  
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.blendMode = blendMode;
    });
  }
}

// Layers
function updateLayersList() {
  var layersList = document.getElementById('layersList');
  if (!layersList) return;
  
  layersList.innerHTML = '';
  
  for (var i = layers.length - 1; i >= 0; i--) {
    var layer = layers[i];
    var layerItem = document.createElement('div');
    layerItem.className = 'layer-item' + (i === currentLayerIndex ? ' active' : '');
    layerItem.innerHTML = `  
      <span class="layer-icon">\ud83d\udcc4</span>
      <span class="layer-name">${layer.name}</span>
      <div class="layer-actions">
        <button class="btn btn-sm" data-action="toggleLayerVisibility" data-index="${i}">${layer.visible ? '\ud83d\udc41' : '\ud83d\udc41\u200d\ud83d\udde8'}</button>
        <button class="btn btn-sm" data-action="toggleLayerLock" data-index="${i}">${layer.locked ? '\ud83d\udd12' : '\ud83d\udd13'}</button>
      </div>
    `;
    layerItem.onclick = function(e) {
      if (e.target.tagName !== 'BUTTON') {
        selectLayer(i);
      }
    };
    layersList.appendChild(layerItem);
  }
}

function addLayer() {
  layers.push({
    name: 'Layer ' + (layers.length + 1),
    visible: true,
    locked: false,
    items: []
  });
  currentLayerIndex = layers.length - 1;
  updateLayersList();
}

function deleteLayer() {
  if (layers.length > 1) {
    layers.splice(currentLayerIndex, 1);
    currentLayerIndex = Math.min(currentLayerIndex, layers.length - 1);
    updateLayersList();
  }
}

function selectLayer(index) {
  currentLayerIndex = index;
  updateLayersList();
}

function toggleLayerVisibility(index) {
  layers[index].visible = !layers[index].visible;
  updateLayersList();
}

function toggleLayerLock(index) {
  layers[index].locked = !layers[index].locked;
  updateLayersList();
}

// Save/Undo/Redo
function saveState() {
  var json = project.exportJSON({ asString: false });
  undoStack.push(JSON.stringify(json));
  if (undoStack.length > 50) {
    undoStack.shift();
  }
  redoStack = [];
}

function undo() {
  if (undoStack.length > 1) {
    redoStack.push(undoStack.pop());
    project.clear();
    project.importJSON(JSON.parse(undoStack[undoStack.length - 1]));
  }
}

function redo() {
  if (redoStack.length > 0) {
    var state = redoStack.pop();
    undoStack.push(state);
    project.clear();
    project.importJSON(JSON.parse(state));
  }
}

// Edit operations
function cut() {
  if (project.selectedItems.length) {
    clipboard = JSON.stringify(project.selectedItems.map(function(item) {
      return item.exportJSON({ asString: false });
    }));
    project.selectedItems.forEach(function(item) {
      item.remove();
    });
    saveState();
  }
}

function copy() {
  if (project.selectedItems.length) {
    clipboard = JSON.stringify(project.selectedItems.map(function(item) {
      return item.exportJSON({ asString: false });
    }));
  }
}

function paste() {
  if (clipboard) {
    project.deselectAll();
    var items = JSON.parse(clipboard);
    items.forEach(function(itemData) {
      var item = project.importJSON(itemData);
      item.position = item.position.add(new Point(20, 20));
      item.selected = true;
    });
    saveState();
  }
}

function duplicate() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      var clone = item.clone();
      clone.position = item.position.add(new Point(20, 20));
      clone.selected = true;
      item.selected = false;
    });
    saveState();
  }
}

function deleteSelection() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.remove();
    });
    saveState();
    updateProperties();
  }
}

function selectAll() {
  project.activeLayer.children.forEach(function(item) {
    item.selected = true;
  });
  updateProperties();
}

function deselectAll() {
  project.deselectAll();
  updateProperties();
}

// Arrange
function bringToFront() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.sendToFront();
    });
    saveState();
  }
}

function sendToBack() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.sendToBack();
    });
    saveState();
  }
}

function bringForward() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      var siblings = project.activeLayer.children;
      var index = siblings.indexOf(item);
      if (index < siblings.length - 1) {
        item.insertAbove(siblings[index + 1]);
      }
    });
    saveState();
  }
}

function sendBackward() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      var siblings = project.activeLayer.children;
      var index = siblings.indexOf(item);
      if (index > 0) {
        item.insertBelow(siblings[index - 1]);
      }
    });
    saveState();
  }
}

// Group/Ungroup
function groupSelection() {
  if (project.selectedItems.length > 1) {
    var group = new Group(project.selectedItems);
    saveState();
  }
}

function ungroupSelection() {
  project.selectedItems.forEach(function(item) {
    if (item instanceof Group) {
      item.ungroup();
    }
  });
  saveState();
}

function lockSelection() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.locked = true;
    });
  }
}

function unlockAll() {
  project.activeLayer.children.forEach(function(item) {
    item.locked = false;
  });
}

// Transform
function rotateSelection(angle) {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.rotate(angle);
    });
    saveState();
  }
}

function flipSelection(direction) {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      if (direction === 'horizontal') {
        item.scale(-1, 1);
      } else {
        item.scale(1, -1);
      }
    });
    saveState();
  }
}

// Create Outlines - WORKING IMPLEMENTATION
function createOutlines() {
  if (project.selectedItems.length === 0) {
    alert('Please select a text object to create outlines.');
    return;
  }
  
  project.selectedItems.forEach(function(item) {
    if (item instanceof PointText) {
      var outline = item.createOutline();
      if (outline) {
        outline.fillColor = item.fillColor;
        outline.strokeColor = item.strokeColor;
        outline.strokeWidth = item.strokeWidth || 0;
        outline.selected = true;
        item.remove();
        saveState();
      } else {
        alert('Could not create outlines for this text. The text may be empty.');
      }
    }
  });
}

// Pathfinder operations
function pathfinder(operation) {
  var items = project.selectedItems.filter(function(item) {
    return item instanceof Path && item.selected;
  });
  
  if (items.length < 2) {
    alert('Please select at least 2 paths for pathfinder operations.');
    return;
  }
  
  var result;
  switch(operation) {
    case 'unite':
      result = items[0].unite(items[1]);
      break;
    case 'minus':
      result = items[0].exclude(items[1]);
      break;
    case 'intersect':
      result = items[0].intersect(items[1]);
      break;
    case 'exclude':
      result = items[0].exclude(items[1]);
      break;
    case 'divide':
      alert('Divide operation not yet implemented');
      return;
    case 'trim':
      alert('Trim operation not yet implemented');
      return;
    case 'merge':
      alert('Merge operation not yet implemented');
      return;
    case 'crop':
      alert('Crop operation not yet implemented');
      return;
    case 'outline':
      alert('Outline operation not yet implemented');
      return;
  }
  
  if (result) {
    items.forEach(function(item) {
      if (item !== result) item.remove();
    });
    result.fillColor = fillColor;
    result.strokeColor = strokeColor;
    result.strokeWidth = strokeWidth;
    saveState();
  }
}

// Select same
function selectSameFill() {
  if (project.selectedItems.length === 0) return;
  
  var targetColor = project.selectedItems[0].fillColor;
  if (!targetColor) return;
  
  project.deselectAll();
  
  project.activeLayer.children.forEach(function(item) {
    if (item.fillColor && item.fillColor.toCSS() === targetColor.toCSS()) {
      item.selected = true;
    }
  });
}

function selectSameStroke() {
  if (project.selectedItems.length === 0) return;
  
  var targetColor = project.selectedItems[0].strokeColor;
  if (!targetColor) return;
  
  project.deselectAll();
  
  project.activeLayer.children.forEach(function(item) {
    if (item.strokeColor && item.strokeColor.toCSS() === targetColor.toCSS()) {
      item.selected = true;
    }
  });
}

function selectSameStrokeWidth() {
  if (project.selectedItems.length === 0) return;
  
  var targetWidth = project.selectedItems[0].strokeWidth;
  
  project.deselectAll();
  
  project.activeLayer.children.forEach(function(item) {
    if (item.strokeWidth === targetWidth) {
      item.selected = true;
    }
  });
}

// Zoom
function zoomIn() {
  view.zoom = view.zoom * 1.25;
  updateZoomDisplay();
}

function zoomOut() {
  view.zoom = view.zoom * 0.8;
  updateZoomDisplay();
}

function zoomToFit() {
  if (project.activeLayer.children.length > 0) {
    view.fitBounds(project.activeLayer.bounds);
  } else {
    view.zoom = 1;
  }
  updateZoomDisplay();
}

function zoomTo100() {
  view.zoom = 1;
  updateZoomDisplay();
}

function updateZoomDisplay() {
  var zoomPercent = Math.round(view.zoom * 100);
  var statusZoom = document.getElementById('statusZoom');
  if (statusZoom) {
    statusZoom.textContent = zoomPercent + '%';
  }
}

// View options
function toggleGrid() {
  showGrid = !showGrid;
}

function toggleRulers() {
  showRulers = !showRulers;
  var rulerH = document.getElementById('rulerH');
  var rulerV = document.getElementById('rulerV');
  var rulerCorner = document.getElementById('rulerCorner');
  
  if (rulerH) rulerH.style.display = showRulers ? 'block' : 'none';
  if (rulerV) rulerV.style.display = showRulers ? 'block' : 'none';
  if (rulerCorner) rulerCorner.style.display = showRulers ? 'block' : 'none';
}

function toggleSnap() {
  snapToGrid = !snapToGrid;
}

// Draw grid
function onFrame(event) {
  if (showGrid) {
    // Grid would be drawn here
  }
}

// Export functions
function exportSVG() {
  var svg = project.exportSVG({ asString: true, embedImages: true });
  var blob = new Blob([svg], { type: 'image/svg+xml' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'artwork.svg';
  a.click();
  URL.revokeObjectURL(url);
}

function exportPNG() {
  var canvas = view.element;
  canvas.toBlob(function(blob) {
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'artwork.png';
    a.click();
    URL.revokeObjectURL(url);
  }, 'image/png');
}

function exportPDF() {
  var svg = project.exportSVG({ asString: true, embedImages: true });
  var blob = new Blob([svg], { type: 'application/pdf' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'artwork.pdf';
  a.click();
  URL.revokeObjectURL(url);
}

// File operations - NEW DOCUMENT WITH SIZE OPTIONS
function newDocument() {
  var modal = document.getElementById('newDocumentModal');
  if (modal) {
    modal.classList.add('active');
  }
}

function closeNewDocumentModal() {
  var modal = document.getElementById('newDocumentModal');
  if (modal) {
    modal.classList.remove('active');
  }
}

function createNewDocument() {
  var width = parseInt(document.getElementById('docWidth').value);
  var height = parseInt(document.getElementById('docHeight').value);
  
  if (isNaN(width) || isNaN(height) || width < 1 || height < 1) {
    alert('Please enter valid document dimensions.');
    return;
  }
  
  documentWidth = width;
  documentHeight = height;
  
  // Clear the project properly
  project.activeLayer.removeChildren();
  undoStack = [];
  redoStack = [];
  layers = [];
  initLayers();
  createArtboard();
  saveState();
  updateLayersList();
  updateProperties();
  
  // Update status bar
  var statusMemory = document.getElementById('statusMemory');
  if (statusMemory) {
    statusMemory.textContent = 'Document: ' + width + ' x ' + height;
  }
  
  closeNewDocumentModal();
  console.log('New document created:', width, 'x', height);
  
  // Make sure the canvas is visible
  var loader = document.getElementById('loader');
  if (loader) {
    loader.style.display = 'none';
  }
}

function saveDocument() {
  var json = project.exportJSON({ asString: true });
  var blob = new Blob([json], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'document.json';
  a.click();
  URL.revokeObjectURL(url);
}

function saveDocumentAs() {
  saveDocument();
}

function handleOpen(event) {
  var file = event.target.files[0];
  if (file) {
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = e.target.result;
        if (file.name.endsWith('.json')) {
          project.clear();
          project.importJSON(data);
        } else if (file.name.endsWith('.svg')) {
          project.clear();
          project.importSVG(data);
        }
        saveState();
        console.log('File loaded successfully');
      } catch (error) {
        console.error('Error loading file:', error);
        alert('Error loading file. Please check the file format.');
      }
    };
    if (file.name.endsWith('.json')) {
      reader.readAsText(file);
    } else {
      reader.readAsText(file);
    }
  }
  event.target.value = '';
}

function handlePlace(event) {
  var file = event.target.files[0];
  if (file) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var raster = new Raster({
        source: e.target.result,
        position: view.center
      });
      raster.onLoad = function() {
        console.log('Image loaded:', raster.size);
        raster.selected = true;
        saveState();
      };
    };
    reader.readAsDataURL(file);
  }
  event.target.value = '';
}

// Type operations
function findFont() {
  alert('Font search feature coming soon!');
}

function showTransformDialog() {
  alert('Transform dialog - coming soon!');
}

// Placeholder functions for other features
function convertToPoint() {
  console.log('Convert to point - coming soon!');
}

function convertToCurve() {
  console.log('Convert to curve - coming soon!');
}

function align(alignment) {
  if (!project || !project.selectedItems || project.selectedItems.length < 2) {
    alert('Please select at least 2 objects to align.');
    return;
  }
  
  var items = project.selectedItems;
  var bounds = items.map(function(item) { return item.bounds; });
  
  switch(alignment) {
    case 'left':
      items.forEach(function(item) { item.position.x = bounds[0].left; });
      break;
    case 'right':
      items.forEach(function(item) { item.position.x = bounds[0].right - (item.bounds.width / 2); });
      break;
    case 'top':
      items.forEach(function(item) { item.position.y = bounds[0].top; });
      break;
    case 'bottom':
      items.forEach(function(item) { item.position.y = bounds[0].bottom - (item.bounds.height / 2); });
      break;
    case 'center-h':
      items.forEach(function(item) { item.position.x = bounds[0].center.x; });
      break;
    case 'center-v':
      items.forEach(function(item) { item.position.y = bounds[0].center.y; });
      break;
  }
  saveState();
}

function distribute(distribution) {
  if (!project || !project.selectedItems || project.selectedItems.length < 3) {
    alert('Please select at least 3 objects to distribute.');
    return;
  }
  
  var items = project.selectedItems;
  alert('Distribute feature - arrange items evenly');
}

function addFill() {
  var appearanceList = document.getElementById('appearanceList');
  if (appearanceList) {
    var item = document.createElement('div');
    item.className = 'appearance-item';
    item.innerHTML = `
      <span class="type">Fill</span>
      <div class="color-preview" style="background-color: #ff0000"></div>
      <span class="value">#ff0000</span>
    `;
    appearanceList.appendChild(item);
  }
}

function addStroke() {
  var appearanceList = document.getElementById('appearanceList');
  if (appearanceList) {
    var item = document.createElement('div');
    item.className = 'appearance-item';
    item.innerHTML = `
      <span class="type">Stroke</span>
      <div class="color-preview" style="background-color: #000000"></div>
      <span class="value">#000000</span>
    `;
    appearanceList.appendChild(item);
  }
}

function setStrokeCap(cap) {
  if (project && project.selectedItems && project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.strokeCap = cap;
    });
  }
}

function setStrokeJoin(join) {
  if (project && project.selectedItems && project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.strokeJoin = join;
    });
  }
}

function updateStroke() {
  var weight = parseFloat(document.getElementById('strokeWeight').value);
  var dash = document.getElementById('strokeDash').value;
  var color = document.getElementById('strokeColorInput').value;
  
  if (project && project.selectedItems && project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.strokeWidth = weight;
      if (dash) {
        var dashArray = dash.split(',').map(function(d) { return parseFloat(d.trim()); });
        item.dashArray = dashArray;
      } else {
        item.dashArray = [];
      }
      item.strokeColor = color;
    });
  }
}

function updateTypography() {
  if (!project || !project.selectedItems || project.selectedItems.length === 0) return;
  
  var fontFamily = document.getElementById('fontFamily').value;
  var fontSize = parseInt(document.getElementById('fontSize').value);
  var lineHeight = parseInt(document.getElementById('lineHeight').value);
  var letterSpacing = parseInt(document.getElementById('letterSpacing').value);
  
  project.selectedItems.forEach(function(item) {
    if (item instanceof PointText) {
      item.fontFamily = fontFamily;
      item.fontSize = fontSize;
      item.leading = lineHeight;
    }
  });
}

function setFontStyle(style) {
  if (!project || !project.selectedItems || project.selectedItems.length === 0) return;
  
  project.selectedItems.forEach(function(item) {
    if (item instanceof PointText) {
      switch(style) {
        case 'bold':
          item.fontWeight = 'bold';
          break;
        case 'italic':
          item.fontStyle = 'italic';
          break;
        case 'underline':
          // Text decoration not directly available in Paper.js
          break;
      }
    }
  });
}

function setTextAlign(align) {
  if (!project || !project.selectedItems || project.selectedItems.length === 0) return;
  
  project.selectedItems.forEach(function(item) {
    if (item instanceof PointText) {
      item.justification = align;
    }
  });
}

function addSwatch() {
  var color = prompt('Enter hex color:', '#000000');
  if (color && /^#[0-9A-Fa-f]{6}$/.test(color)) {
    // Would add to swatches
    console.log('Add swatch:', color);
  }
}

function clearSwatches() {
  if (confirm('Clear all custom swatches?')) {
    // Would clear swatches
    console.log('Clear swatches');
  }
}

function setGradientType(type) {
  alert('Gradient type: ' + type);
}

function showPanel(panelName) {
  document.querySelectorAll('.panel-tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.panel-section').forEach(function(s) { s.classList.remove('active'); });
  
  var tab = document.querySelector('.panel-tab[data-panel="' + panelName + '"]');
  if (tab) tab.classList.add('active');
  
  var section = document.getElementById('panel-' + panelName);
  if (section) section.classList.add('active');
  
  // Show dock if hidden
  var dock = document.getElementById('panelDock');
  if (dock) {
    dock.classList.add('visible');
    dock.classList.remove('hidden');
    var dockToggle = document.getElementById('dockToggle');
    if (dockToggle) dockToggle.textContent = '\u25c0';
  }
  
  // Show notification with panel name
  var panelNames = {
    'properties': 'Properties Panel',
    'layers': 'Layers Panel',
    'appearance': 'Appearance Panel',
    'swatches': 'Swatches Panel',
    'gradient': 'Gradient Panel',
    'stroke': 'Stroke Panel',
    'align': 'Align Panel',
    'character': 'Character Panel',
    'paragraph': 'Paragraph Panel'
  };
  
  if (panelNames[panelName]) {
    showToolNotification(panelNames[panelName]);
  }
}

// Context menu
document.addEventListener('contextmenu', function(event) {
  event.preventDefault();
  var contextMenu = document.getElementById('contextMenu');
  if (contextMenu) {
    contextMenu.style.display = 'block';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';
  }
});

document.addEventListener('click', function(event) {
  var contextMenu = document.getElementById('contextMenu');
  if (contextMenu) {
    contextMenu.style.display = 'none';
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(event) {
  if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
  
  // File shortcuts
  if ((event.ctrlKey || event.metaKey) && (event.key === 'n' || event.key === 'N')) {
    if (event.shiftKey) {
      event.preventDefault();
      event.stopPropagation();
      newDocument();
    }
  }
  if ((event.ctrlKey || event.metaKey) && (event.key === 's' || event.key === 'S')) {
    if (event.shiftKey) {
      event.preventDefault();
      event.stopPropagation();
      saveDocument();
    }
  }
  if ((event.ctrlKey || event.metaKey) && (event.key === 'o' || event.key === 'O')) {
    event.preventDefault();
    event.stopPropagation();
    document.getElementById('openFile').click();
  }
  
  // Tool shortcuts
  if (event.key === 'v' || event.key === 'V') {
    if (!event.ctrlKey && !event.metaKey) activateTool('select');
  }
  if (event.key === 'a' || event.key === 'A') {
    if (!event.ctrlKey && !event.metaKey) activateTool('directSelect');
  }
  if (event.key === 'p' || event.key === 'P') {
    if (!event.ctrlKey && !event.metaKey) activateTool('pen');
  }
  if (event.key === 'n' || event.key === 'N') {
    if (!event.ctrlKey && !event.metaKey) activateTool('pencil');
  }
  if (event.key === 'b' || event.key === 'B') {
    if (!event.ctrlKey && !event.metaKey) activateTool('brush');
  }
  if (event.key === 'm' || event.key === 'M') {
    if (!event.ctrlKey && !event.metaKey) activateTool('rectangle');
  }
  if (event.key === 'l' || event.key === 'L') {
    if (!event.ctrlKey && !event.metaKey) activateTool('ellipse');
  }
  if (event.key === 't' || event.key === 'T') {
    if (!event.ctrlKey && !event.metaKey) activateTool('type');
  }
  if (event.key === 'i' || event.key === 'I') {
    if (!event.ctrlKey && !event.metaKey) activateTool('eyedropper');
  }
  if (event.key === 'h' || event.key === 'H') {
    if (!event.ctrlKey && !event.metaKey) activateTool('hand');
  }
  if (event.key === 'z' || event.key === 'Z') {
    if (event.ctrlKey || event.metaKey) {
      event.preventDefault();
      if (event.shiftKey) {
        redo();
      } else {
        undo();
      }
    } else {
      activateTool('zoom');
    }
  }
  
  // Edit shortcuts
  if ((event.ctrlKey || event.metaKey) && event.key === 'c') copy();
  if ((event.ctrlKey || event.metaKey) && event.key === 'x') cut();
  if ((event.ctrlKey || event.metaKey) && event.key === 'v') {
    if (!event.shiftKey) paste();
  }
  if ((event.ctrlKey || event.metaKey) && event.key === 'd') {
    event.preventDefault();
    duplicate();
  }
  if (event.key === 'Delete' || event.key === 'Backspace') {
    if (event.target.tagName !== 'INPUT') {
      deleteSelection();
    }
  }
  if ((event.ctrlKey || event.metaKey) && event.key === 'a') {
    event.preventDefault();
    selectAll();
  }
  if ((event.ctrlKey || event.metaKey) && event.shiftKey && (event.key === 'a' || event.key === 'A')) {
    event.preventDefault();
    deselectAll();
  }
  if ((event.ctrlKey || event.metaKey) && event.key === 'g') {
    event.preventDefault();
    if (event.shiftKey) {
      ungroupSelection();
    } else {
      groupSelection();
    }
  }
  
  // Arrange shortcuts
  if ((event.ctrlKey || event.metaKey) && event.key === ']') {
    if (event.shiftKey) {
      bringToFront();
    } else {
      bringForward();
    }
  }
  if ((event.ctrlKey || event.metaKey) && event.key === '[') {
    if (event.shiftKey) {
      sendToBack();
    } else {
      sendBackward();
    }
  }
  
  // Zoom shortcuts
  if ((event.ctrlKey || event.metaKey) && (event.key === '=' || event.key === '+')) {
    event.preventDefault();
    zoomIn();
  }
  if ((event.ctrlKey || event.metaKey) && event.key === '-') {
    event.preventDefault();
    zoomOut();
  }
  if ((event.ctrlKey || event.metaKey) && event.key === '0') {
    event.preventDefault();
    zoomToFit();
  }
  if ((event.ctrlKey || event.metaKey) && event.key === '1') {
    event.preventDefault();
    zoomTo100();
  }
  
  // Escape key
  if (event.key === 'Escape') {
    deselectAll();
    if (currentPath) {
      currentPath.remove();
      currentPath = null;
      penPoints = [];
    }
  }
});

// Mouse position tracking for desktop
view.onMouseMove = function(event) {
  var statusPosition = document.getElementById('statusPosition');
  if (statusPosition) {
    statusPosition.textContent = 'X: ' + Math.round(event.point.x) + ' Y: ' + Math.round(event.point.y);
  }
};

// Selection changed handler
project.on('selectionchanged', updateProperties);

// Initialize
console.log('Initializing layers...');
initLayers();
console.log('Activating selection tool...');
activateTool('select');
console.log('Saving initial state...');
saveState();
console.log('Creating default artboard...');
createArtboard();
console.log('Paper.js setup complete!');

// Hide loader after a short delay
view.onFrame = function(event) {
  if (event.count === 10) {
    var loader = document.getElementById('loader');
    if (loader) {
      loader.style.display = 'none';
      console.log('Loader hidden, editor ready!');
    }
  }
};

// Expose functions to global scope for HTML onclick handlers
window.newDocument = newDocument;
window.closeNewDocumentModal = closeNewDocumentModal;
window.createNewDocument = createNewDocument;
window.saveDocument = saveDocument;
window.saveDocumentAs = saveDocumentAs;
window.handleOpen = handleOpen;
window.handlePlace = handlePlace;
window.exportSVG = exportSVG;
window.exportPNG = exportPNG;
window.exportPDF = exportPDF;
window.undo = undo;
window.redo = redo;
window.cut = cut;
window.copy = copy;
window.paste = paste;
window.duplicate = duplicate;
window.deleteSelection = deleteSelection;
window.selectAll = selectAll;
window.deselectAll = deselectAll;
window.groupSelection = groupSelection;
window.ungroupSelection = ungroupSelection;
window.lockSelection = lockSelection;
window.unlockAll = unlockAll;
window.bringToFront = bringToFront;
window.sendToBack = sendToBack;
window.bringForward = bringForward;
window.sendBackward = sendBackward;
window.rotateSelection = rotateSelection;
window.flipSelection = flipSelection;
window.showTransformDialog = showTransformDialog;
window.pathfinder = pathfinder;
window.createOutlines = createOutlines;
window.findFont = findFont;
window.selectSameFill = selectSameFill;
window.selectSameStroke = selectSameStroke;
window.selectSameStrokeWidth = selectSameStrokeWidth;
window.zoomIn = zoomIn;
window.zoomOut = zoomOut;
window.zoomToFit = zoomToFit;
window.zoomTo100 = zoomTo100;
window.toggleGrid = toggleGrid;
window.toggleRulers = toggleRulers;
window.toggleSnap = toggleSnap;
window.showPanel = showPanel;
window.updateTransform = updateTransform;
window.updateOpacity = updateOpacity;
window.updateBlendMode = updateBlendMode;
window.convertToPoint = convertToPoint;
window.convertToCurve = convertToCurve;
window.addLayer = addLayer;
window.deleteLayer = deleteLayer;
window.addFill = addFill;
window.addStroke = addStroke;
window.addSwatch = addSwatch;
window.clearSwatches = clearSwatches;
window.setGradientType = setGradientType;
window.updateStroke = updateStroke;
window.setStrokeCap = setStrokeCap;
window.setStrokeJoin = setStrokeJoin;
window.align = align;
window.distribute = distribute;
window.updateTypography = updateTypography;
window.setFontStyle = setFontStyle;
window.setTextAlign = setTextAlign;

</script>

<script>
// Panel tab switching
document.querySelectorAll('.panel-tab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.panel-tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.panel-section').forEach(function(s) { s.classList.remove('active'); });
    
    this.classList.add('active');
    var panelName = this.dataset.panel;
    var section = document.getElementById('panel-' + panelName);
    if (section) section.classList.add('active');
  });
});

// Dock toggle - Fixed to work properly
var dock = document.getElementById('panelDock');
var dockToggle = document.getElementById('dockToggle');
var panelCloseBtn = document.getElementById('panelCloseBtn');
var dockVisible = true;

function toggleDock() {
  dockVisible = !dockVisible;
  if (dock) {
    dock.classList.toggle('visible', dockVisible);
    dock.classList.toggle('hidden', !dockVisible);
  }
  if (dockToggle) {
    dockToggle.textContent = dockVisible ? '\u25c0' : '\u25b6';
  }
}

if (dockToggle) {
  dockToggle.onclick = toggleDock;
}

if (panelCloseBtn) {
  panelCloseBtn.onclick = toggleDock;
}

// Document preset handler
document.getElementById('docPreset').addEventListener('change', function() {
  var preset = this.value;
  if (preset !== 'custom') {
    var dimensions = preset.split('x');
    document.getElementById('docWidth').value = dimensions[0];
    document.getElementById('docHeight').value = dimensions[1];
  }
});

// Action handler for menu items and buttons
document.addEventListener('click', function(event) {
  var element = event.target;
  var action = element.dataset.action;
  
  // Handle click on buttons with data-action
  if (action) {
    console.log('Action clicked:', action);
    
    switch(action) {
      // File menu actions
      case 'newDocument':
        if (window.newDocument) window.newDocument();
        break;
      case 'openFile':
        var openInput = document.getElementById('openFile');
        if (openInput) openInput.click();
        break;
      case 'saveDocument':
        if (window.saveDocument) window.saveDocument();
        break;
      case 'saveDocumentAs':
        if (window.saveDocumentAs) window.saveDocumentAs();
        break;
      case 'placeImage':
        var placeInput = document.getElementById('placeImage');
        if (placeInput) placeInput.click();
        break;
      case 'exportSVG':
        if (window.exportSVG) window.exportSVG();
        break;
      case 'exportPNG':
        if (window.exportPNG) window.exportPNG();
        break;
      case 'exportPDF':
        if (window.exportPDF) window.exportPDF();
        break;
      
      // Edit menu actions
      case 'undo':
        if (window.undo) window.undo();
        break;
      case 'redo':
        if (window.redo) window.redo();
        break;
      case 'cut':
        if (window.cut) window.cut();
        break;
      case 'copy':
        if (window.copy) window.copy();
        break;
      case 'paste':
        if (window.paste) window.paste();
        break;
      case 'duplicate':
        if (window.duplicate) window.duplicate();
        break;
      case 'deleteSelection':
        if (window.deleteSelection) window.deleteSelection();
        break;
      case 'selectAll':
        if (window.selectAll) window.selectAll();
        break;
      case 'deselectAll':
        if (window.deselectAll) window.deselectAll();
        break;
      
      // Object menu actions
      case 'groupSelection':
        if (window.groupSelection) window.groupSelection();
        break;
      case 'ungroupSelection':
        if (window.ungroupSelection) window.ungroupSelection();
        break;
      case 'lockSelection':
        if (window.lockSelection) window.lockSelection();
        break;
      case 'unlockAll':
        if (window.unlockAll) window.unlockAll();
        break;
      case 'bringToFront':
        if (window.bringToFront) window.bringToFront();
        break;
      case 'sendToBack':
        if (window.sendToBack) window.sendToBack();
        break;
      case 'bringForward':
        if (window.bringForward) window.bringForward();
        break;
      case 'sendBackward':
        if (window.sendBackward) window.sendBackward();
        break;
      case 'rotateSelectionCW':
        if (window.rotateSelection) window.rotateSelection(-90);
        break;
      case 'rotateSelectionCCW':
        if (window.rotateSelection) window.rotateSelection(90);
        break;
      case 'flipSelectionHorizontal':
        if (window.flipSelection) window.flipSelection('horizontal');
        break;
      case 'flipSelectionVertical':
        if (window.flipSelection) window.flipSelection('vertical');
        break;
      case 'showTransformDialog':
        if (window.showTransformDialog) window.showTransformDialog();
        break;
      case 'pathfinderUnite':
        if (window.pathfinder) window.pathfinder('unite');
        break;
      case 'pathfinderMinus':
        if (window.pathfinder) window.pathfinder('minus');
        break;
      case 'pathfinderIntersect':
        if (window.pathfinder) window.pathfinder('intersect');
        break;
      case 'pathfinderExclude':
        if (window.pathfinder) window.pathfinder('exclude');
        break;
      case 'pathfinderDivide':
        if (window.pathfinder) window.pathfinder('divide');
        break;
      case 'pathfinderTrim':
        if (window.pathfinder) window.pathfinder('trim');
        break;
      case 'pathfinderMerge':
        if (window.pathfinder) window.pathfinder('merge');
        break;
      case 'pathfinderCrop':
        if (window.pathfinder) window.pathfinder('crop');
        break;
      case 'pathfinderOutline':
        if (window.pathfinder) window.pathfinder('outline');
        break;
      
      // Type menu actions
      case 'createOutlines':
        if (window.createOutlines) window.createOutlines();
        break;
      case 'findFont':
        if (window.findFont) window.findFont();
        break;
      
      // Select menu actions
      case 'selectSameFill':
        if (window.selectSameFill) window.selectSameFill();
        break;
      case 'selectSameStroke':
        if (window.selectSameStroke) window.selectSameStroke();
        break;
      case 'selectSameStrokeWidth':
        if (window.selectSameStrokeWidth) window.selectSameStrokeWidth();
        break;
      
      // View menu actions
      case 'zoomIn':
        if (window.zoomIn) window.zoomIn();
        break;
      case 'zoomOut':
        if (window.zoomOut) window.zoomOut();
        break;
      case 'zoomToFit':
        if (window.zoomToFit) window.zoomToFit();
        break;
      case 'zoomTo100':
        if (window.zoomTo100) window.zoomTo100();
        break;
      case 'toggleGrid':
        if (window.toggleGrid) window.toggleGrid();
        break;
      case 'toggleRulers':
        if (window.toggleRulers) window.toggleRulers();
        break;
      case 'toggleSnap':
        if (window.toggleSnap) window.toggleSnap();
        break;
      
      // Window menu actions
      case 'showPanelProperties':
        if (window.showPanel) window.showPanel('properties');
        break;
      case 'showPanelLayers':
        if (window.showPanel) window.showPanel('layers');
        break;
      case 'showPanelAppearance':
        if (window.showPanel) window.showPanel('appearance');
        break;
      case 'showPanelSwatches':
        if (window.showPanel) window.showPanel('swatches');
        break;
      case 'showPanelGradient':
        if (window.showPanel) window.showPanel('gradient');
        break;
      case 'showPanelStroke':
        if (window.showPanel) window.showPanel('stroke');
        break;
      case 'showPanelAlign':
        if (window.showPanel) window.showPanel('align');
        break;
      case 'showPanelCharacter':
        if (window.showPanel) window.showPanel('character');
        break;
      case 'showPanelParagraph':
        if (window.showPanel) window.showPanel('paragraph');
        break;
      
      // Layer actions
      case 'addLayer':
        if (window.addLayer) window.addLayer();
        break;
      case 'deleteLayer':
        if (window.deleteLayer) window.deleteLayer();
        break;
      case 'toggleLayerVisibility':
        var index = parseInt(element.dataset.index);
        if (!isNaN(index) && window.toggleLayerVisibility) {
          window.toggleLayerVisibility(index);
        }
        break;
      case 'toggleLayerLock':
        var index = parseInt(element.dataset.index);
        if (!isNaN(index) && window.toggleLayerLock) {
          window.toggleLayerLock(index);
        }
        break;
      
      // Appearance actions
      case 'addFill':
        if (window.addFill) window.addFill();
        break;
      case 'addStroke':
        if (window.addStroke) window.addStroke();
        break;
      
      // Swatch actions
      case 'addSwatch':
        if (window.addSwatch) window.addSwatch();
        break;
      case 'clearSwatches':
        if (window.clearSwatches) window.clearSwatches();
        break;
      
      // Gradient actions
      case 'gradientLinear':
        if (window.setGradientType) window.setGradientType('linear');
        break;
      case 'gradientRadial':
        if (window.setGradientType) window.setGradientType('radial');
        break;
      
      // Stroke actions
      case 'strokeCapButt':
        if (window.setStrokeCap) window.setStrokeCap('butt');
        break;
      case 'strokeCapRound':
        if (window.setStrokeCap) window.setStrokeCap('round');
        break;
      case 'strokeCapSquare':
        if (window.setStrokeCap) window.setStrokeCap('square');
        break;
      case 'strokeJoinMiter':
        if (window.setStrokeJoin) window.setStrokeJoin('miter');
        break;
      case 'strokeJoinRound':
        if (window.setStrokeJoin) window.setStrokeJoin('round');
        break;
      case 'strokeJoinBevel':
        if (window.setStrokeJoin) window.setStrokeJoin('bevel');
        break;
      
      // Align actions
      case 'alignLeft':
        if (window.align) window.align('left');
        break;
      case 'alignRight':
        if (window.align) window.align('right');
        break;
      case 'alignTop':
        if (window.align) window.align('top');
        break;
      case 'alignBottom':
        if (window.align) window.align('bottom');
        break;
      case 'alignCenterH':
        if (window.align) window.align('center-h');
        break;
      case 'alignCenterV':
        if (window.align) window.align('center-v');
        break;
      case 'distributeLeft':
        if (window.distribute) window.distribute('left');
        break;
      case 'distributeRight':
        if (window.distribute) window.distribute('right');
        break;
      case 'distributeTop':
        if (window.distribute) window.distribute('top');
        break;
      case 'distributeBottom':
        if (window.distribute) window.distribute('bottom');
        break;
      case 'distributeCenterH':
        if (window.distribute) window.distribute('center-h');
        break;
      case 'distributeCenterV':
        if (window.distribute) window.distribute('center-v');
        break;
      
      // Typography actions
      case 'fontStyleBold':
        if (window.setFontStyle) window.setFontStyle('bold');
        break;
      case 'fontStyleItalic':
        if (window.setFontStyle) window.setFontStyle('italic');
        break;
      case 'fontStyleUnderline':
        if (window.setFontStyle) window.setFontStyle('underline');
        break;
      case 'textAlignLeft':
        if (window.setTextAlign) window.setTextAlign('left');
        break;
      case 'textAlignCenter':
        if (window.setTextAlign) window.setTextAlign('center');
        break;
      case 'textAlignRight':
        if (window.setTextAlign) window.setTextAlign('right');
        break;
      case 'textAlignJustify':
        if (window.setTextAlign) window.setTextAlign('justify');
        break;
      
      // Transform actions
      case 'convertToPoint':
        if (window.convertToPoint) window.convertToPoint();
        break;
      case 'convertToCurve':
        if (window.convertToCurve) window.convertToCurve();
        break;
    }
  }
  
  // Handle tool buttons
  var tool = element.dataset.tool;
  if (tool && window.activateTool) {
    window.activateTool(tool);
  }
});

// Tool button click handlers
document.querySelectorAll('.tool-btn[data-tool]').forEach(function(btn) {
  btn.addEventListener('click', function(event) {
    var tool = this.dataset.tool;
    if (window.activateTool) {
      window.activateTool(tool);
    }
  });
});

// Property change handlers
document.getElementById('propX').addEventListener('change', function() {
  if (window.updateTransform) window.updateTransform();
});
document.getElementById('propY').addEventListener('change', function() {
  if (window.updateTransform) window.updateTransform();
});
document.getElementById('propW').addEventListener('change', function() {
  if (window.updateTransform) window.updateTransform();
});
document.getElementById('propH').addEventListener('change', function() {
  if (window.updateTransform) window.updateTransform();
});
document.getElementById('propRotation').addEventListener('change', function() {
  if (window.updateTransform) window.updateTransform();
});
document.getElementById('propShear').addEventListener('change', function() {
  if (window.updateTransform) window.updateTransform();
});
document.getElementById('propOpacity').addEventListener('input', function() {
  if (window.updateOpacity) window.updateOpacity();
});
document.getElementById('propBlendMode').addEventListener('change', function() {
  if (window.updateBlendMode) window.updateBlendMode();
});

// Gradient controls
document.getElementById('gradientAngle').addEventListener('input', function() {
  document.getElementById('gradientAngleVal').textContent = this.value + '\u00b0';
});

// Stroke controls
document.getElementById('strokeWeight').addEventListener('input', function() {
  document.getElementById('strokeWeightVal').textContent = this.value + ' px';
  if (window.updateStroke) window.updateStroke();
});
document.getElementById('strokeDash').addEventListener('input', function() {
  if (window.updateStroke) window.updateStroke();
});
document.getElementById('strokeColorInput').addEventListener('input', function() {
  if (window.updateStroke) window.updateStroke();
});

// Typography controls
document.getElementById('fontFamily').addEventListener('change', function() {
  if (window.updateTypography) window.updateTypography();
});
document.getElementById('fontSize').addEventListener('change', function() {
  if (window.updateTypography) window.updateTypography();
});
document.getElementById('lineHeight').addEventListener('change', function() {
  if (window.updateTypography) window.updateTypography();
});
document.getElementById('letterSpacing').addEventListener('change', function() {
  if (window.updateTypography) window.updateTypography();
});

// Window resize handler
window.addEventListener('resize', function() {
  if (window.innerWidth > 900) {
    // On desktop, always show dock
    if (dock) {
      dock.classList.add('visible');
      dock.classList.remove('hidden');
      dockVisible = true;
    }
    if (dockToggle) {
      dockToggle.textContent = '\u25c0';
    }
  }
});

// Swatches
var defaultSwatches = [
  '#000000', '#ffffff', '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff',
  '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#6c5ce7', '#fd79a8',
  '#e17055', '#00b894', '#0984e3', '#6c5ce7', '#fdcb6e', '#636e72', '#2d3436', '#b2bec3'
];

function initSwatches() {
  var swatchGrid = document.getElementById('swatchGrid');
  if (!swatchGrid) return;
  
  swatchGrid.innerHTML = '';
  defaultSwatches.forEach(function(color) {
    var swatch = document.createElement('div');
    swatch.className = 'swatch';
    swatch.style.backgroundColor = color;
    swatch.onclick = function() {
      if (window.project && window.project.selectedItems && window.project.selectedItems.length) {
        window.project.selectedItems.forEach(function(item) {
          item.fillColor = color;
        });
      }
    };
    swatchGrid.appendChild(swatch);
  });
}

// File input handlers
document.getElementById('openFile').addEventListener('change', function(event) {
  if (window.handleOpen) window.handleOpen(event);
});

document.getElementById('placeImage').addEventListener('change', function(event) {
  if (window.handlePlace) window.handlePlace(event);
});

// Color pickers
document.getElementById('fillColor').addEventListener('click', function() {
  var fillColor = window.fillColor;
  var colorStr = fillColor && fillColor.toCSS ? fillColor.toCSS(true) : '#ff0000';
  var color = prompt('Enter fill color (hex):', colorStr);
  if (color) {
    window.fillColor = new paper.Color(color);
    this.style.backgroundColor = color;
    if (window.project && window.project.selectedItems && window.project.selectedItems.length) {
      window.project.selectedItems.forEach(function(item) {
        item.fillColor = new paper.Color(color);
      });
    }
  }
});

document.getElementById('strokeColor').addEventListener('click', function() {
  var strokeColor = window.strokeColor;
  var colorStr = strokeColor && strokeColor.toCSS ? strokeColor.toCSS(true) : '#000000';
  var color = prompt('Enter stroke color (hex):', colorStr);
  if (color) {
    window.strokeColor = new paper.Color(color);
    this.style.backgroundColor = color;
    if (window.project && window.project.selectedItems && window.project.selectedItems.length) {
      window.project.selectedItems.forEach(function(item) {
        item.strokeColor = new paper.Color(color);
      });
    }
  }
});

document.getElementById('defaultColors').addEventListener('click', function() {
  window.fillColor = new paper.Color('#ff0000');
  window.strokeColor = new paper.Color('#000000');
  document.getElementById('fillColor').style.backgroundColor = '#ff0000';
  document.getElementById('strokeColor').style.backgroundColor = '#000000';
});

// Initialize on load
window.addEventListener('load', function() {
  initSwatches();
  addFill();
  addStroke();
});

// Desktop mouse position tracking
document.addEventListener('mousemove', function(event) {
  var canvas = document.getElementById('canvas');
  var statusPosition = document.getElementById('statusPosition');
  
  if (canvas && statusPosition) {
    var rect = canvas.getBoundingClientRect();
    if (event.clientX >= rect.left && event.clientX <= rect.right &&
        event.clientY >= rect.top && event.clientY <= rect.bottom) {
      // Calculate position accounting for zoom and scroll
      var x = Math.round(event.clientX - rect.left - 60);
      var y = Math.round(event.clientY - rect.top - 20);
      statusPosition.textContent = 'X: ' + x + ' Y: ' + y;
    }
  }
});

// Mobile touch support for position tracking
document.addEventListener('DOMContentLoaded', function() {
  var canvas = document.getElementById('canvas');
  if (canvas) {
    canvas.addEventListener('touchmove', function(e) {
      if (e.touches.length > 0) {
        var touch = e.touches[0];
        var rect = canvas.getBoundingClientRect();
        var x = touch.clientX - rect.left - 60;
        var y = touch.clientY - rect.top - 20;
        var statusPosition = document.getElementById('statusPosition');
        if (statusPosition) {
          statusPosition.textContent = 'X: ' + Math.round(x) + ' Y: ' + Math.round(y);
        }
      }
    }, { passive: true });
  }
});
</script>
</body>
</html>
