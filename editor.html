
Sam
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Image Editor – BowesProduct</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*, *::before, *::after { box-sizing: border-box; }
html, body {
  margin: 0;
  background: #020617;
  color: white;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  overflow-x: hidden;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ================= HEADER ================= */
.site-header {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: rgba(2,6,23,0.95);
  border-bottom: 1px solid #1e293b;
}

.header-inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0.6rem 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 1.6rem;
}
.logo a {
  font-size: 1.3rem;
  font-weight: 700;
  color: white;
  text-decoration: none;
  white-space: nowrap;
}
.main-nav {
  display: flex;
  gap: 1.4rem;
}
.main-nav a {
  color: #e5e7eb;
  text-decoration: none;
  font-size: 0.95rem;
}
.main-nav a:hover { color:#60a5fa; }

.header-right {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  min-height: 44px;
}

#profilePic {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 2px solid #60a5fa;
  object-fit: cover;
  display: none;
}

.login-btn {
  padding: 0.45rem 1.1rem;
  border-radius: 999px;
  border: 1.5px solid #60a5fa;
  background: transparent;
  color: #60a5fa;
  font-size: 0.95rem;
  cursor: pointer;
}

#levelInfo {
  display: none;
  width: 140px;
  font-size: 0.8rem;
  color: #cbd5e1;
}
#levelText {
  white-space: nowrap;
}
#xpOuter {
  width: 100%;
  height: 5px;
  background: #1e293b;
  border-radius: 3px;
  margin-top: 4px;
}
#xpBar {
  height: 100%;
  width: 0%;
  background: #60a5fa;
  border-radius: 3px;
  transition: width 0.35s ease;
}

@media (max-width: 768px) {
  .header-inner {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }
  .header-left {
    justify-content: space-between;
  }
  .header-right {
    justify-content: space-between;
    width: 100%;
  }
  #levelInfo {
    width: 100%;
  }
}

/* ================= EDITOR LAYOUT ================= */
.editor-container {
  flex: 1;
  display: flex;
  overflow: hidden;
  background: #020617;
}

/* LEFT PANEL - Original Image */
.left-panel {
  width: 280px;
  background: #0f172a;
  border-right: 1px solid #1e293b;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

.left-panel h3 {
  color: #60a5fa;
  padding: 1rem;
  margin: 0;
  font-size: 1rem;
  border-bottom: 1px solid #1e293b;
}

.upload-section {
  padding: 1rem;
  border-bottom: 1px solid #1e293b;
}

.upload-btn {
  width: 100%;
  padding: 0.75rem;
  border: 2px dashed #60a5fa;
  background: transparent;
  color: #60a5fa;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.upload-btn:hover {
  background: rgba(96, 165, 250, 0.1);
}

.original-image-container {
  flex: 1;
  padding: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: auto;
}

.original-image-container img {
  max-width: 100%;
  max-height: 300px;
  border-radius: 8px;
  border: 1px solid #1e293b;
}

/* CENTER - Canvas */
.center-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #020617;
  overflow: hidden;
}

.toolbar {
  padding: 0.75rem 1rem;
  background: #0f172a;
  border-bottom: 1px solid #1e293b;
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.toolbar button {
  padding: 0.5rem 1rem;
  border: 1px solid #60a5fa;
  background: transparent;
  color: #60a5fa;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: all 0.2s;
}

.toolbar button:hover {
  background: #60a5fa;
  color: #020617;
}

.toolbar button.primary {
  background: #60a5fa;
  color: #020617;
}

.canvas-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: auto;
  padding: 1rem;
}

canvas {
  max-width: 100%;
  max-height: 100%;
  border-radius: 8px;
  border: 1px solid #1e293b;
}

/* RIGHT PANEL - Adjustments */
.right-panel {
  width: 340px;
  background: #0f172a;
  border-left: 1px solid #1e293b;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.tabs {
  display: flex;
  background: #020617;
  border-bottom: 1px solid #1e293b;
  overflow-x: auto;
}

.tab-btn {
  padding: 0.75rem 1rem;
  background: transparent;
  color: #94a3b8;
  border: none;
  border-right: 1px solid #1e293b;
  cursor: pointer;
  white-space: nowrap;
  font-size: 0.85rem;
  transition: all 0.2s;
}

.tab-btn:hover {
  color: #60a5fa;
  background: rgba(96, 165, 250, 0.05);
}

.tab-btn.active {
  color: #60a5fa;
  background: #0f172a;
}

.panel-content {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
}

.panel-section {
  margin-bottom: 1.5rem;
}

.panel-section h4 {
  color: #60a5fa;
  margin: 0 0 0.75rem 0;
  font-size: 0.9rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.panel-section h4 .toggle {
  font-size: 0.75rem;
  padding: 0.2rem 0.5rem;
  border: 1px solid #1e293b;
  border-radius: 4px;
  cursor: pointer;
}

.panel-section h4 .toggle.on {
  background: #60a5fa;
  color: #020617;
  border-color: #60a5fa;
}

/* CONTROLS */
.control-group {
  margin-bottom: 0.75rem;
}

.control-group label {
  display: block;
  color: #cbd5e1;
  font-size: 0.8rem;
  margin-bottom: 0.35rem;
}

.control-group label span {
  float: right;
  color: #94a3b8;
}

input[type="range"] {
  width: 100%;
  height: 6px;
  -webkit-appearance: none;
  background: #1e293b;
  border-radius: 3px;
  outline: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: #60a5fa;
  border-radius: 50%;
  cursor: pointer;
}

input[type="checkbox"] {
  margin-right: 0.5rem;
  accent-color: #60a5fa;
}

input[type="color"] {
  width: 100%;
  height: 35px;
  border: 1px solid #1e293b;
  border-radius: 4px;
  background: #020617;
  cursor: pointer;
}

select {
  width: 100%;
  padding: 0.5rem;
  background: #1e293b;
  color: #cbd5e1;
  border: 1px solid #1e293b;
  border-radius: 4px;
  font-size: 0.85rem;
}

.curves-editor {
  background: #020617;
  border: 1px solid #1e293b;
  border-radius: 8px;
  padding: 0.75rem;
}

.curves-canvas {
  width: 100%;
  height: 180px;
  background: #020617;
  border-radius: 4px;
}

/* ================= FOOTER ================= */
.site-footer {
  background: rgba(2,6,23,0.95);
  border-top: 1px solid #1e293b;
  padding: 1.5rem 1rem;
}

.footer-inner {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
}

.footer-nav {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.footer-nav a {
  color: #cbd5e1;
  text-decoration: none;
  font-size: 0.85rem;
}

.footer-nav a:hover {
  color: #60a5fa;
}

.site-footer p {
  margin: 0;
  color: #94a3b8;
  font-size: 0.85rem;
}

/* EFFECT LAYERS */
.effects-stack {
  background: #020617;
  border: 1px solid #1e293b;
  border-radius: 8px;
  padding: 0.75rem;
  max-height: 200px;
  overflow-y: auto;
}

.effect-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem;
  background: #0f172a;
  border-radius: 4px;
  margin-bottom: 0.5rem;
  font-size: 0.8rem;
}

.effect-item.disabled {
  opacity: 0.5;
}

.effect-item .effect-name {
  flex: 1;
}

.effect-item .effect-controls {
  display: flex;
  gap: 0.5rem;
}

.effect-item button {
  padding: 0.2rem 0.5rem;
  border: 1px solid #1e293b;
  background: transparent;
  color: #94a3b8;
  border-radius: 3px;
  cursor: pointer;
  font-size: 0.75rem;
}

.effect-item button:hover {
  border-color: #60a5fa;
  color: #60a5fa;
}
</style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>

<body>

<!-- HEADER -->
<header class="site-header">
  <div class="header-inner">

    <div class="header-left">
      <div class="logo"><a href="index.html">BowesProduct</a></div>
      <nav class="main-nav">
        <a href="index.html">Home</a>
        <a href="models.html">Models</a>
        <a href="retexture.html">Retexture</a>
      </nav>
    </div>

    <div class="header-right">
      <img id="profilePic" alt="Profile">

      <div id="levelInfo">
        <div id="levelText"></div>
        <div id="xpOuter"><div id="xpBar"></div></div>
      </div>

      <button id="authBtn" class="login-btn">Login</button>
    </div>

  </div>
</header>

<!-- EDITOR -->
<div class="editor-container">

  <!-- LEFT PANEL -->
  <div class="left-panel">
    <h3>Original Image</h3>
    <div class="upload-section">
      <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
        Upload Image
      </button>
      <input type="file" id="imageInput" accept="image/*" style="display:none">
    </div>
    <div class="original-image-container">
      <img id="originalImage" src="" alt="No image uploaded">
    </div>
  </div>

  <!-- CENTER PANEL -->
  <div class="center-panel">
    <div class="toolbar">
      <button onclick="resetAll()">Reset All</button>
      <button onclick="undo()">Undo</button>
      <button onclick="redo()">Redo</button>
      <button class="primary" onclick="exportImage()">Export PNG</button>
    </div>
    <div class="canvas-container">
      <canvas id="canvas"></canvas>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">
    <div class="tabs">
      <button class="tab-btn active" data-tab="basic">Basic</button>
      <button class="tab-btn" data-tab="color">Color</button>
      <button class="tab-btn" data-tab="blur">Blur</button>
      <button class="tab-btn" data-tab="stylize">Stylize</button>
      <button class="tab-btn" data-tab="artistic">Artistic</button>
      <button class="tab-btn" data-tab="distort">Distort</button>
      <button class="tab-btn" data-tab="noise">Noise</button>
      <button class="tab-btn" data-tab="effects">Effects</button>
    </div>

    <div class="panel-content" id="panelContent">
      <!-- Content loaded dynamically -->
    </div>
  </div>

</div>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="footer-inner">
    <nav class="footer-nav">
      <a href="about.html">About</a>
      <a href="privacy.html">Privacy</a>
      <a href="terms.html">Terms</a>
      <a href="license.html">License</a>
      <a href="refund.html">Refund</a>
      <a href="rewards.html">Rewards</a>
    </nav>
    <p>© 2025 BowesProduct</p>
  </div>
</footer>

<!-- ================= JAVASCRIPT ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB4JMVBMcWcN2wKsaVYmnggHH5ue1mUfaA",
  authDomain: "bowesproduct.firebaseapp.com",
  projectId: "bowesproduct"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const authBtn = document.getElementById("authBtn");
const profilePic = document.getElementById("profilePic");
const levelInfo = document.getElementById("levelInfo");
const levelText = document.getElementById("levelText");
const xpBar = document.getElementById("xpBar");

authBtn.onclick = () =>
  auth.currentUser ? signOut(auth) : signInWithPopup(auth, provider);

onAuthStateChanged(auth, async (user) => {
 if (!user) {
  authBtn.textContent = "Login";
  profilePic.style.display = "none";
  levelInfo.style.display = "none";
  return;
 }

 authBtn.textContent = "Logout";
 profilePic.src = user.photoURL || "";
 profilePic.style.display = "block";

 const ref = doc(db, "users", user.uid);
 let snap = await getDoc(ref);

 if (!snap.exists()) {
  await setDoc(ref, { xp: 10 });
  snap = await getDoc(ref);
 }

 const xp = snap.data().xp || 0;
 const levels = [0, 200, 500, 1000, 2000];
 let level = levels.filter(v => xp >= v).length - 1;
 let next = levels[level + 1] ?? levels[level];
 let progress = next === levels[level] ? 100 :
  ((xp - levels[level]) / (next - levels[level])) * 100;

 levelText.textContent = Level ${level} • ${xp} XP;
 xpBar.style.width = progress + "%";
 levelInfo.style.display = "block";
});
</script>

<script>
// ================= IMAGE EDITOR ENGINE =================

class ImageEditor {
  constructor() {
    this.canvas = document.getElementById('canvas');
    this.ctx = this.canvas.getContext('2d');
    this.originalImage = null;
    this.currentImageData = null;
    this.undoStack = [];
    this.redoStack = [];
    this.adjustments = {};
    this.effectStack = [];
    
    this.initControls();
    this.initEventListeners();
  }

  initControls() {
    // Default adjustment values
    this.adjustments = {
      brightness: 0,
      contrast: 0,
      exposure: 0,
      hueRotate: 0,
      saturation: 100,
      lightness: 0,
      temperature: 0,
      tint: 0,
      invert: false,
      grayscale: false,
      sepia: false,
      blur: 0,
      sharpen: 0,
      vignette: 0,
      dropShadow: { enabled: false, x: 5, y: 5, blur: 10, opacity: 50, color: '#000000' },
      innerGlow: { enabled: false, blur: 20, opacity: 50, color: '#60a5fa' },
      outerGlow: { enabled: false, blur: 20, opacity: 50, color: '#60a5fa' }
    };

    // Initialize tabs
    this.tabs = {
      basic: this.getBasicControls(),
      color: this.getColorControls(),
      blur: this.getBlurControls(),
      stylize: this.getStylizeControls(),
      artistic: this.getArtisticControls(),
      distort: this.getDistortControls(),
      noise: this.getNoiseControls(),
      effects: this.getEffectsControls()
    };

    this.loadTab('basic');
  }

  getBasicControls() {
    return `
      <div class="panel-section" data-section="brightness">
        <h4>Brightness <span class="toggle" onclick="editor.toggleEffect('brightness')">ON</span></h4>
        <div class="control-group">
          <label>Brightness <span id="brightness-val">0</span></label>
          <input type="range" min="-100" max="100" value="0" data-param="brightness">
        </div>
      </div>
      <div class="panel-section" data-section="contrast">
        <h4>Contrast <span class="toggle on" onclick="editor.toggleEffect('contrast')">ON</span></h4>
        <div class="control-group">
          <label>Contrast <span id="contrast-val">0</span></label>
          <input type="range" min="-100" max="100" value="0" data-param="contrast">
        </div>
      </div>
      <div class="panel-section" data-section="exposure">
        <h4>Exposure <span class="toggle on" onclick="editor.toggleEffect('exposure')">ON</span></h4>
        <div class="control-group">
          <label>Exposure <span id="exposure-val">0</span></label>
          <input type="range" min="-5" max="5" value="0" step="0.1" data-param="exposure">
        </div>
      </div>
      <div class="panel-section" data-section="sharpen">
        <h4>Sharpen <span class="toggle" onclick="editor.toggleEffect('sharpen')">OFF</span></h4>
        <div class="control-group">
          <label>Amount <span id="sharpen-val">0</span></label>
          <input type="range" min="0" max="100" value="0" data-param="sharpen">
        </div>
      </div>
    `;
  }

  getColorControls() {
    return `
      <div class="panel-section" data-section="hsl">
        <h4>Hue/Saturation/Lightness <span class="toggle on" onclick="editor.toggleEffect('hsl')">ON</span></h4>
        <div class="control-group">
          <label>Hue Rotate <span id="hueRotate-val">0°</span></label>
          <input type="range" min="-180" max="180" value="0" data-param="hueRotate">
        </div>
        <div class="control-group">
          <label>Saturation <span id="saturation-val">100%</span></label>
          <input type="range" min="0" max="200" value="100" data-param="saturation">
        </div>
        <div class="control-group">
          <label>Lightness <span id="lightness-val">0%</span></label>
          <input type="range" min="-100" max="100" value="0" data-param="lightness">
        </div>
      </div>
      <div class="panel-section" data-section="temperature">
        <h4>Temperature & Tint <span class="toggle on" onclick="editor.toggleEffect('temperature')">ON</span></h4>
        <div class="control-group">
          <label>Temperature <span id="temperature-val">0</span></label>
          <input type="range" min="-100" max="100" value="0" data-param="temperature">
        </div>
        <div class="control-group">
          <label>Tint <span id="tint-val">0</span></label>
          <input type="range" min="-100" max="100" value="0" data-param="tint">
        </div>
      </div>
      <div class="panel-section" data-section="basic-color">
        <h4>Basic Color <span class="toggle on" onclick="editor.toggleEffect('basic-color')">ON</span></h4>
        <div class="control-group">
          <label><input type="checkbox" data-param="invert"> Invert Colors</label>
        </div>
        <div class="control-group">
          <label><input type="checkbox" data-param="grayscale"> Grayscale</label>
        </div>
        <div class="control-group">
          <label><input type="checkbox" data-param="sepia"> Sepia</label>
        </div>
      </div>
    `;
  }

  getBlurControls() {
    return `
      <div class="panel-section" data-section="blur">
        <h4>Gaussian Blur <span class="toggle" onclick="editor.toggleEffect('blur')">OFF</span></h4>
        <div class="control-group">
          <label>Radius <span id="blur-val">0px</span></label>
          <input type="range" min="0" max="50" value="0" data-param="blur">
        </div>
      </div>
      <div class="panel-section" data-section="motion-blur">
        <h4>Motion Blur <span class="toggle" onclick="editor.toggleEffect('motionBlur')">OFF</span></h4>
        <div class="control-group">
          <label>Angle <span id="motionAngle-val">0°</span></label>
          <input type="range" min="0" max="360" value="0" data-param="motionAngle">
        </div>
        <div class="control-group">
          <label>Amount <span id="motionAmount-val">0</span></label>
          <input type="range" min="0" max="50" value="0" data-param="motionAmount">
        </div>
      </div>
    `;
  }

  getStylizeControls() {
    return `
      <div class="panel-section" data-section="drop-shadow">
        <h4>Drop Shadow <span class="toggle" id="dropShadow-toggle" onclick="editor.toggleEffect('dropShadow')">OFF</span></h4>
        <div class="control-group">
          <label>Offset X <span id="dropShadow-x-val">5</span></label>
          <input type="range" min="-50" max="50" value="5" data-param="dropShadow-x">
        </div>
        <div class="control-group">
          <label>Offset Y <span id="dropShadow-y-val">5</span></label>
          <input type="range" min="-50" max="50" value="5" data-param="dropShadow-y">
        </div>
        <div class="control-group">
          <label>Blur <span id="dropShadow-blur-val">10</span></label>
          <input type="range" min="0" max="50" value="10" data-param="dropShadow-blur">
        </div>
        <div class="control-group">
          <label>Opacity <span id="dropShadow-opacity-val">50%</span></label>
          <input type="range" min="0" max="100" value="50" data-param="dropShadow-opacity">
        </div>
        <div class="control-group">
          <label>Color</label>
          <input type="color" value="#000000" data-param="dropShadow-color">
        </div>
      </div>
      <div class="panel-section" data-section="inner-glow">
        <h4>Inner Glow <span class="toggle" id="innerGlow-toggle" onclick="editor.toggleEffect('innerGlow')">OFF</span></h4>
        <div class="control-group">
          <label>Blur <span id="innerGlow-blur-val">20</span></label>
          <input type="range" min="0" max="100" value="20" data-param="innerGlow-blur">
        </div>
        <div class="control-group">
          <label>Opacity <span id="innerGlow-opacity-val">50%</span></label>
          <input type="range" min="0" max="100" value="50" data-param="innerGlow-opacity">
        </div>
        <div class="control-group">
          <label>Color</label>
          <input type="color" value="#60a5fa" data-param="innerGlow-color">
        </div>
      </div>
      <div class="panel-section" data-section="outer-glow">
        <h4>Outer Glow <span class="toggle" id="outerGlow-toggle" onclick="editor.toggleEffect('outerGlow')">OFF</span></h4>
        <div class="control-group">
          <label>Blur <span id="outerGlow-blur-val">20</span></label>
          <input type="range" min="0" max="100" value="20" data-param="outerGlow-blur">
        </div>
        <div class="control-group">
          <label>Opacity <span id="outerGlow-opacity-val">50%</span></label>
          <input type="range" min="0" max="100" value="50" data-param="outerGlow-opacity">
        </div>
        <div class="control-group">
          <label>Color</label>
          <input type="color" value="#60a5fa" data-param="outerGlow-color">
        </div>
      </div>
      <div class="panel-section" data-section="vignette">
        <h4>Vignette <span class="toggle" onclick="editor.toggleEffect('vignette')">OFF</span></h4>
        <div class="control-group">
          <label>Strength <span id="vignette-val">0</span></label>
          <input type="range" min="0" max="100" value="0" data-param="vignette">
        </div>
      </div>
    `;
  }

  getArtisticControls() {
    const effects = ['coloredPencil', 'cutout', 'dryBrush', 'filmGrain', 'fresco', 'neonGlow', 'paintDaubs', 'posterEdges', 'watercolor'];
    let html = '';
    
    effects.forEach(effect => {
      const label = effect.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
      html += `
        <div class="panel-section" data-section="${effect}">
          <h4>${label} <span class="toggle" onclick="editor.toggleEffect('${effect}')">OFF</span></h4>
          <div class="control-group">
            <label>Intensity <span id="${effect}-val">0</span></label>
            <input type="range" min="0" max="100" value="0" data-param="${effect}">
          </div>
        </div>
      `;
    });
    
    return html;
  }

  getDistortControls() {
    const effects = ['ripple', 'twirl', 'wave', 'zigzag', 'glass'];
    let html = '';
    
    effects.forEach(effect => {
      const label = effect.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
      html += `
        <div class="panel-section" data-section="${effect}">
          <h4>${label} <span class="toggle" onclick="editor.toggleEffect('${effect}')">OFF</span></h4>
          <div class="control-group">
            <label>Amount <span id="${effect}-val">0</span></label>
            <input type="range" min="0" max="100" value="0" data-param="${effect}">
          </div>
        </div>
      `;
    });
    
    return html;
  }

  getNoiseControls() {
    return `
      <div class="panel-section" data-section="noise">
        <h4>Add Noise <span class="toggle" onclick="editor.toggleEffect('noise')">OFF</span></h4>
        <div class="control-group">
          <label>Amount <span id="noise-val">0</span></label>
          <input type="range" min="0" max="100" value="0" data-param="noise">
        </div>
        <div class="control-group">
          <label>Distribution</label>
          <select data-param="noise-dist">
            <option value="gaussian">Gaussian</option>
            <option value="uniform">Uniform</option>
          </select>
        </div>
      </div>
      <div class="panel-section" data-section="pixelate">
        <h4>Pixelate/Mosaic <span class="toggle" onclick="editor.toggleEffect('pixelate')">OFF</span></h4>
        <div class="control-group">
          <label>Block Size <span id="pixelate-val">1</span></label>
          <input type="range" min="1" max="50" value="1" data-param="pixelate">
        </div>
      </div>
      <div class="panel-section" data-section="halftone">
        <h4>Halftone <span class="toggle" onclick="editor.toggleEffect('halftone')">OFF</span></h4>
        <div class="control-group">
          <label>Dot Size <span id="halftone-val">1</span></label>
          <input type="range" min="1" max="20" value="1" data-param="halftone">
        </div>
      </div>
    `;
  }

  getEffectsControls() {
    return `
      <div class="panel-section">
        <h4>Effect Stack</h4>
        <div class="effects-stack" id="effectsStack">
          <p style="color: #64748b; font-size: 0.8rem; text-align: center; padding: 1rem;">No active effects</p>
        </div>
      </div>
      <div class="panel-section">
        <h4>Blend Mode</h4>
        <div class="control-group">
          <select data-param="blendMode">
            <option value="normal">Normal</option>
            <option value="multiply">Multiply</option>
            <option value="screen">Screen</option>
            <option value="overlay">Overlay</option>
            <option value="soft-light">Soft Light</option>
            <option value="hard-light">Hard Light</option>
            <option value="color-dodge">Color Dodge</option>
            <option value="color-burn">Color Burn</option>
            <option value="difference">Difference</option>
            <option value="exclusion">Exclusion</option>
          </select>
        </div>
      </div>
    `;
  }

  loadTab(tabName) {
    const content = this.tabs[tabName] || '';
    document.getElementById('panelContent').innerHTML = content;
    this.attachControlListeners();
  }

  attachControlListeners() {
    document.querySelectorAll('.panel-content input, .panel-content select').forEach(input => {
      input.addEventListener('input', (e) => {
        this.handleInputChange(e.target);
      });
      input.addEventListener('change', (e) => {
        this.handleInputChange(e.target);
      });
    });
  }

  handleInputChange(target) {
    const param = target.dataset.param;
    let value;
    
    if (target.type === 'checkbox') {
      value = target.checked;
    } else if (target.type === 'range' || target.type === 'number') {
      value = parseFloat(target.value);
    } else {
      value = target.value;
    }

    // Update value display
    const valDisplay = document.getElementById(${param}-val);
    if (valDisplay) {
      let displayValue = value;
      if (param.includes('hueRotate') || param.includes('Angle')) displayValue += '°';
      else if (param.includes('saturation') || param.includes('lightness') || 
               param.includes('opacity')) displayValue += '%';
      else if (param.includes('blur') || param.includes('Blur')) displayValue += 'px';
      valDisplay.textContent = displayValue;
    }

    // Parse compound parameters
    if (param.includes('-')) {
      const parts = param.split('-');
      const section = parts[0];
      const subParam = parts[1];
      if (!this.adjustments[section]) {
        this.adjustments[section] = {};
      }
      this.adjustments[section][subParam] = value;
    } else {
      this.adjustments[param] = value;
    }

    this.applyEffects();
  }

  toggleEffect(effectName) {
    const toggle = document.querySelector([data-section="${effectName}"] .toggle) || 
                   document.getElementById(${effectName}-toggle);
    
    if (toggle) {
      const isOn = toggle.classList.contains('on');
      toggle.classList.toggle('on');
      toggle.textContent = isOn ? 'OFF' : 'ON';
    }

    // Update adjustments state
    if (!this.adjustments.enabled) {
      this.adjustments.enabled = {};
    }
    this.adjustments.enabled[effectName] = !this.adjustments.enabled[effectName];
    this.applyEffects();
  }

  initEventListeners() {
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.loadTab(btn.dataset.tab);
      });
    });

    // Image upload
    document.getElementById('imageInput').addEventListener('change', (e) => {
      this.loadImage(e.target.files[0]);
    });

    // Canvas interaction
    this.canvas.addEventListener('click', () => {
      // Future: Click to apply curves
    });
  }

  loadImage(file) {
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        this.originalImage = img;
        document.getElementById('originalImage').src = e.target.result;
        
        // Resize canvas to fit image
        const maxWidth = 800;
        const maxHeight = 600;
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (maxWidth / width) * height;
          width = maxWidth;
        }
        if (height > maxHeight) {
          width = (maxHeight / height) * width;
          height = maxHeight;
        }
        
        this.canvas.width = width;
        this.canvas.height = height;
        
        // Draw initial image
        this.ctx.drawImage(img, 0, 0, width, height);
        this.currentImageData = this.ctx.getImageData(0, 0, width, height);
        this.saveState();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  saveState() {
    this.undoStack.push(this.currentImageData);
    this.redoStack = [];
    if (this.undoStack.length > 50) {
      this.undoStack.shift();
    }
  }

  applyEffects() {
    if (!this.originalImage) return;

    // Reset canvas
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    
    // Build filter string for CSS filters
    let filterString = '';
    
    // Basic adjustments
    const brightness = this.adjustments.brightness || 0;
    const contrast = this.adjustments.contrast || 0;
    const exposure = this.adjustments.exposure || 0;
    
    filterString += brightness(${1 + brightness / 100 + exposure / 5}) ;
    filterString += contrast(${1 + contrast / 100}) ;
    
    // Color adjustments
    const hueRotate = this.adjustments.hueRotate || 0;
    const saturation = this.adjustments.saturation || 100;
    const lightness = this.adjustments.lightness || 0;
    
    filterString += hue-rotate(${hueRotate}deg) ;
    filterString += saturate(${saturation}%) ;
    
    // Basic color effects
    if (this.adjustments.invert) {
      filterString += 'invert(100%) ';
    }
    if (this.adjustments.grayscale) {
      filterString += 'grayscale(100%) ';
    }
    if (this.adjustments.sepia) {
      filterString += 'sepia(100%) ';
    }
    
    // Blur
    const blur = this.adjustments.blur || 0;
    if (blur > 0) {
      filterString += blur(${blur}px) ;
    }
    
    this.ctx.filter = filterString;
    this.ctx.drawImage(this.originalImage, 0, 0, this.canvas.width, this.canvas.height);
    this.ctx.filter = 'none';
    
    // Get image data for pixel manipulation
    let imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
    
    // Apply pixel-level effects
    imageData = this.applyTemperatureTint(imageData);
    imageData = this.applyVignette(imageData);
    imageData = this.applyNoise(imageData);
    imageData = this.applySharpen(imageData);
    
    // Put modified image data back
    this.ctx.putImageData(imageData, 0, 0);
    
    // Apply layer-based effects (shadows, glows)
    this.applyLayerEffects();
    
    // Update current state
    this.currentImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
  }

  applyTemperatureTint(imageData) {
    const temperature = this.adjustments.temperature || 0;
    const tint = this.adjustments.tint || 0;
    
    if (temperature === 0 && tint === 0) return imageData;
    
    const data = imageData.data;
    for (let i = 0; i < data.length; i += 4) {
      // Temperature (warm/cool)
      if (temperature > 0) {
        data[i] = Math.min(255, data[i] + temperature);     // R
        data[i + 2] = Math.max(0, data[i + 2] - temperature); // B
      } else {
        data[i] = Math.max(0, data[i] + temperature);     // R
        data[i + 2] = Math.min(255, data[i + 2] - temperature); // B
      }
      
      // Tint (green/magenta)
      if (tint > 0) {
        data[i + 1] = Math.min(255, data[i + 1] + tint);   // G
      } else {
        data[i] = Math.max(0, data[i] + tint);     // R
        data[i + 2] = Math.max(0, data[i + 2] + tint); // B
      }
    }
    
    return imageData;
  }

  applyVignette(imageData) {
    const vignette = this.adjustments.vignette || 0;
    if (vignette === 0) return imageData;
    
    const width = this.canvas.width;
    const height = this.canvas.height;
    const centerX = width / 2;
    const centerY = height / 2;
    const maxDist = Math.sqrt(centerX * centerX + centerY * centerY);
    
    const data = imageData.data;
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const idx = (y * width + x) * 4;
        const dist = Math.sqrt((x - centerX) * 2 + (y - centerY) * 2);
        const factor = 1 - (dist / maxDist) * (vignette / 100);
        
        data[idx] *= factor;
        data[idx + 1] *= factor;
        data[idx + 2] *= factor;
      }
    }
    
    return imageData;
  }

  applyNoise(imageData) {
    const noise = this.adjustments.noise || 0;
    if (noise === 0) return imageData;
    
    const data = imageData.data;
    const distribution = this.adjustments['noise-dist'] || 'gaussian';
    
    for (let i = 0; i < data.length; i += 4) {
      let noiseValue;
      if (distribution === 'gaussian') {
        // Box-Muller transform for Gaussian
        const u1 = Math.random();
        const u2 = Math.random();
        const gaussian = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        noiseValue = gaussian * noise;
      } else {
        noiseValue = (Math.random() - 0.5) * 2 * noise;
      }
      
      data[i] = Math.max(0, Math.min(255, data[i] + noiseValue));
      data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + noiseValue));
      data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + noiseValue));
    }
    
    return imageData;
  }

  applySharpen(imageData) {
    const sharpen = this.adjustments.sharpen || 0;
    if (sharpen === 0) return imageData;
    
    const width = this.canvas.width;
    const height = this.canvas.height;
    const data = imageData.data;
    const copy = new Uint8ClampedArray(data);
    
    const amount = sharpen / 100;
    const kernel = [
      0, -amount, 0,
      -amount, 1 + 4 * amount, -amount,
      0, -amount, 0
    ];
    
    for (let y = 1; y < height - 1; y++) {
      for (let x = 1; x < width - 1; x++) {
        for (let c = 0; c < 3; c++) {
          let sum = 0;
          for (let ky = -1; ky <= 1; ky++) {
            for (let kx = -1; kx <= 1; kx++) {
              const idx = ((y + ky) * width + (x + kx)) * 4 + c;
              sum += copy[idx] * kernel[(ky + 1) * 3 + (kx + 1)];
            }
          }
          data[(y * width + x) * 4 + c] = sum;
        }
      }
    }
    
    return imageData;
  }

  applyLayerEffects() {
    const dropShadow = this.adjustments.dropShadow || {};
    const innerGlow = this.adjustments.innerGlow || {};
    const outerGlow = this.adjustments.outerGlow || {};
    
    // Drop Shadow
    if (dropShadow.enabled) {
      this.ctx.save();
      this.ctx.shadowOffsetX = dropShadow.x || 0;
      this.ctx.shadowOffsetY = dropShadow.y || 0;
      this.ctx.shadowBlur = dropShadow.blur || 0;
      this.ctx.shadowColor = this.hexToRgba(dropShadow.color || '#000000', dropShadow.opacity / 100);
      this.ctx.drawImage(this.canvas, 0, 0);
      this.ctx.restore();
    }
    
    // Inner Glow
    if (innerGlow.enabled) {
      this.ctx.save();
      this.ctx.globalCompositeOperation = 'source-atop';
      this.ctx.shadowBlur = innerGlow.blur || 0;
      this.ctx.shadowColor = this.hexToRgba(innerGlow.color || '#60a5fa', innerGlow.opacity / 100);
      this.ctx.beginPath();
      this.ctx.rect(0, 0, this.canvas.width, this.canvas.height);
      this.ctx.stroke();
      this.ctx.restore();
    }
    
    // Outer Glow
    if (outerGlow.enabled) {
      this.ctx.save();
      this.ctx.shadowBlur = outerGlow.blur || 0;
      this.ctx.shadowColor = this.hexToRgba(outerGlow.color || '#60a5fa', outerGlow.opacity / 100);
      this.ctx.drawImage(this.canvas, 0, 0);
      this.ctx.restore();
    }
  }

  hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return rgba(${r}, ${g}, ${b}, ${alpha});
  }

  resetAll() {
    this.adjustments = {
      brightness: 0,
      contrast: 0,
      exposure: 0,
      hueRotate: 0,
      saturation: 100,
      lightness: 0,
      temperature: 0,
      tint: 0,
      invert: false,
      grayscale: false,
      sepia: false,
      blur: 0,
      sharpen: 0,
      vignette: 0,
      dropShadow: { enabled: false, x: 5, y: 5, blur: 10, opacity: 50, color: '#000000' },
      innerGlow: { enabled: false, blur: 20, opacity: 50, color: '#60a5fa' },
      outerGlow: { enabled: false, blur: 20, opacity: 50, color: '#60a5fa' }
    };
    
    this.loadTab(document.querySelector('.tab-btn.active').dataset.tab);
    this.applyEffects();
    this.saveState();
  }

  undo() {
    if (this.undoStack.length > 1) {
      this.redoStack.push(this.undoStack.pop());
      this.currentImageData = this.undoStack[this.undoStack.length - 1];
      this.ctx.putImageData(this.currentImageData, 0, 0);
    }
  }

  redo() {
    if (this.redoStack.length > 0) {
      const imageData = this.redoStack.pop();
      this.undoStack.push(imageData);
      this.currentImageData = imageData;
      this.ctx.putImageData(imageData, 0, 0);
    }
  }

  exportImage() {
    if (!this.originalImage) {
      alert('Please upload an image first');
      return;
    }
    
    const link = document.createElement('a');
    link.download = 'edited-image.png';
    link.href = this.canvas.toDataURL('image/png');
    link.click();
  }
}

// Initialize editor
const editor = new ImageEditor();

// Global functions
function resetAll() {
  editor.resetAll();
}

function undo() {
  editor.undo();
}

function redo() {
  editor.redo();
}

function exportImage() {
  editor.exportImage();
}
</script>

</body>
</html>
