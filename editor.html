<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vector Editor Pro ‚Äì BowesProduct (Illustrator 2026)</title>
  <style>
  *, *::before, *::after { box-sizing: border-box; }
  html, body { margin: 0; height: 100%; background: #020617; color: white; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; -webkit-font-smoothing: antialiased; }
  
  /* ================= HEADER (logo + nav only) ================= */
  .site-header {
    position: sticky; top: 0; z-index: 1000; background: rgba(2,6,23,0.95); border-bottom: 1px solid #1e293b; backdrop-filter: blur(10px);
  }
  .header-inner { max-width: 1400px; margin: 0 auto; padding: 0.6rem 1rem; display: flex; align-items: center; justify-content: space-between; }
  .header-left { display: flex; align-items: center; gap: 1.6rem; }
  .logo a { font-size: 1.3rem; font-weight: 700; color: white; text-decoration: none; white-space: nowrap; }
  .main-nav { display: flex; gap: 1.4rem; }
  .main-nav a { color: #e5e7eb; text-decoration: none; font-size: 0.95rem; }
  .main-nav a:hover, .main-nav a.active { color: #60a5fa; }
  .header-right { display: flex; align-items: center; gap: 0.8rem; min-height: 44px; }
  #profilePic { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #60a5fa; object-fit: cover; display: none; }
  .login-btn { padding: 0.45rem 1.1rem; border-radius: 999px; border: 1.5px solid #60a5fa; background: transparent; color: #60a5fa; font-size: 0.95rem; cursor: pointer; }

  /* ================= APPLICATION MENU BAR ================= */
  .app-menu-bar {
    background: rgba(15,23,42,0.98); border-bottom: 1px solid #1e293b; padding: 0; padding-left: 150px; display: flex; gap: 0; font-size: 0.85rem; position: sticky; top: 70px; z-index: 999; backdrop-filter: blur(10px); flex-wrap: wrap; height: 36px; align-items: center;
  }
  .menu-bar { display: flex; height: 100%; }
  .menu-bar > div {
    position: relative; cursor: pointer; padding: 0.5rem 1rem; height: 100%; display: flex; align-items: center; user-select: none;
  }
  .menu-bar > div:hover { color: #60a5fa; background: rgba(96, 165, 250, 0.1); }
  .dropdown {
    position: absolute; top: 100%; left: 0; background: #0f172a; border: 1px solid #1e293b; min-width: 260px; display: none; flex-direction: column; box-shadow: 0 8px 25px rgba(0,0,0,0.6); border-radius: 6px; overflow: hidden; z-index: 10000; margin-top: 2px;
  }
  .dropdown div { padding: 0.6rem 1.2rem; text-align: left; white-space: nowrap; transition: background 0.15s; font-size: 0.85rem; cursor: pointer; }
  .dropdown div:hover { background: #1e293b; }
  .dropdown div:active { background: #334155; }
  .dropdown .shortcut { float: right; color: #64748b; font-size: 0.75rem; margin-left: 2rem; }
  .dropdown hr { border: none; border-top: 1px solid #1e293b; margin: 0.4rem 0; }
  .dropdown .submenu { position: absolute; left: 100%; top: 0; min-width: 220px; display: none; }
  .dropdown div:hover .submenu { display: flex; }
  .menu-bar > div:hover .dropdown, .dropdown:hover { display: flex; }

  /* ================= MAIN LAYOUT ================= */
  #container { position: relative; width: 100%; height: 100%; padding-top: 106px; padding-bottom: 0; display: flex; }
  
  /* ================= CANVAS AREA ================= */
  #canvas-container {
    flex: 1; position: relative; background: #0a0a0a; overflow: hidden; display: flex; flex-direction: column;
  }
  
  /* Rulers */
  .ruler { position: absolute; background: #1e293b; color: #64748b; font-size: 10px; z-index: 10; }
  .ruler-h { top: 0; left: 60px; right: 0; height: 20px; border-bottom: 1px solid #334155; }
  .ruler-v { top: 20px; left: 0; width: 60px; bottom: 0; border-right: 1px solid #334155; }
  .ruler-corner { position: absolute; top: 0; left: 0; width: 60px; height: 20px; background: #1e293b; border-right: 1px solid #334155; border-bottom: 1px solid #334155; z-index: 11; }
  
  #canvas { display: block; width: 100%; height: 100%; touch-action: none; outline: none; margin-top: 20px; margin-left: 60px; background: #0a0a0a; }
  
  /* Artboard */
  .artboard {
    position: absolute; background: white; box-shadow: 0 0 0 1px #334155, 0 4px 20px rgba(0,0,0,0.5);
  }
  .artboard-label {
    position: absolute; bottom: -25px; left: 0; color: #64748b; font-size: 11px; white-space: nowrap;
  }

  /* ================= LEFT TOOLBAR ================= */
#floatingToolbar {
  position: fixed;
  left: 20px;
  top: 116px;
  background: rgba(30, 41, 59, 0.95);
  padding: 10px;
  border-radius: 12px;
  border: 1px solid #1e293b;
  backdrop-filter: blur(8px);
  z-index: 1150;
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: calc(100vh - 180px);
  overflow-y: auto;
}
  .tool-group { display: flex; flex-direction: column; gap: 2px; padding: 4px 0; border-bottom: 1px solid #1e293b; }
  .tool-group:last-child { border-bottom: none; }
  .tool-btn {
    width: 42px; height: 42px; border-radius: 6px; border: 1px solid transparent; background: transparent; color: #94a3b8; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; font-size: 1.3rem; position: relative;
  }
  .tool-btn:hover { background: rgba(51, 65, 85, 1); color: white; }
  .tool-btn.active { color: #60a5fa; background: rgba(96, 165, 250, 0.1); border-color: #60a5fa; }
  .tool-btn .tooltip {
    position: absolute; left: 100%; top: 50%; transform: translateY(-50%); background: #1e293b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; margin-left: 8px; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 1000;
  }
  .tool-btn:hover .tooltip { opacity: 1; }

  /* ================= RIGHT PANEL DOCK ================= */
  .panel-dock {
    position: fixed; right: 20px; top: 116px; width: 320px; max-height: calc(100vh - 140px); background: rgba(2, 6, 23, 0.95); border: 1px solid #1e293b; border-radius: 12px; overflow: hidden; z-index: 20; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.4); display: flex; flex-direction: column;
  }
  
  #dockToggle { 
    position: absolute; left: -50px; top: 50%; transform: translateY(-50%); width: 50px; height: 100px; background: rgba(2, 6, 23, 0.98); border: 1px solid #1e293b; border-right: none; border-radius: 12px 0 0 12px; color: #60a5fa; font-size: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 21; backdrop-filter: blur(12px); box-shadow: 0 6px 30px rgba(0,0,0,0.5); transition: all 0.3s ease;
  }
  #dockToggle:hover { background: rgba(30, 41, 59, 0.98); color: white; transform: translateY(-50%) translateX(-4px); }

  .panel-tabs { display: flex; background: #0f172a; border-bottom: 1px solid #1e293b; overflow-x: auto; }
  .panel-tab {
    padding: 0.6rem 1rem; background: transparent; border: none; color: #94a3b8; cursor: pointer; font-size: 0.8rem; white-space: nowrap; transition: all 0.2s; flex-shrink: 0;
  }
  .panel-tab:hover { color: #e5e7eb; }
  .panel-tab.active { color: #60a5fa; background: rgba(96, 165, 250, 0.1); border-bottom: 2px solid #60a5fa; }

  .panel-content { padding: 1rem; overflow-y: auto; flex: 1; }
  .panel-section { display: none; }
  .panel-section.active { display: block; }

  .panel-section h3 { 
    color: #60a5fa; margin: 1rem 0 0.8rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #1e293b; padding-bottom: 0.4rem; font-weight: 600;
  }
  .panel-section h3:first-child { margin-top: 0; }

  .control-group { margin-bottom: 1rem; }
  .control-group label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.4rem; }
  .control-row { display: flex; gap: 0.5rem; align-items: center; }
  
  input[type="text"], input[type="number"], select {
    width: 100%; padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb; font-size: 0.85rem;
  }
  input[type="text"]:focus, input[type="number"]:focus, select:focus { outline: none; border-color: #60a5fa; }
  
  input[type="range"] { width: 100%; accent-color: #60a5fa; }
  input[type="color"] { width: 100%; height: 36px; padding: 2px; border: 1px solid #334155; border-radius: 4px; background: #0f172a; cursor: pointer; }
  
  .btn {
    padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #e5e7eb; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;
  }
  .btn:hover { background: #334155; border-color: #475569; }
  .btn-primary { background: #60a5fa; border-color: #60a5fa; color: white; }
  .btn-primary:hover { background: #3b82f6; border-color: #3b82f6; }
  .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
  .btn-group { display: flex; gap: 0.25rem; }
  .btn-group .btn { flex: 1; }

  /* Layers Panel */
  .layer-item { 
    display: flex; align-items: center; gap: 8px; padding: 0.5rem; background: #0f172a; border-radius: 6px; margin-bottom: 0.4rem; cursor: pointer; transition: all 0.15s;
  }
  .layer-item:hover { background: #1e293b; }
  .layer-item.active { background: #1e293b; border: 1px solid #60a5fa; }
  .layer-item .layer-icon { width: 20px; text-align: center; font-size: 0.9rem; }
  .layer-item .layer-name { flex: 1; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .layer-item .layer-actions { display: flex; gap: 4px; }
  .layer-item .layer-actions button { padding: 2px 6px; font-size: 0.75rem; }

  /* Appearance Panel */
  .appearance-item { 
    padding: 0.6rem; background: #0f172a; border-radius: 6px; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.5rem;
  }
  .appearance-item .type { font-size: 0.75rem; color: #64748b; width: 40px; }
  .appearance-item .color-preview { width: 24px; height: 24px; border-radius: 4px; border: 1px solid #334155; }
  .appearance-item .value { flex: 1; font-size: 0.8rem; }

  /* Swatches */
  .swatch-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }
  .swatch { 
    width: 100%; aspect-ratio: 1; border-radius: 4px; cursor: pointer; border: 1px solid #334155; transition: all 0.15s;
  }
  .swatch:hover { transform: scale(1.1); }
  .swatch.selected { border: 2px solid #60a5fa; }

  /* Alignment */
  .align-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
  .align-btn { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border: 1px solid #334155; background: #0f172a; border-radius: 4px; cursor: pointer; transition: all 0.15s; }
  .align-btn:hover { background: #1e293b; }

  /* Status Bar */
  .status-bar {
    position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.95); border-top: 1px solid #1e293b; padding: 0.4rem 1rem; font-size: 0.75rem; color: #64748b; display: flex; justify-content: space-between; z-index: 1000; backdrop-filter: blur(10px);
  }
  .status-bar .left { display: flex; gap: 2rem; }
  .status-bar .right { display: flex; gap: 1rem; }

  /* Mobile */
  @media (max-width: 900px) {
    #floatingToolbar { 
      left: 10px; top: 111px; padding: 6px; max-height: calc(100vh - 160px);
    }
    .tool-btn { width: 38px; height: 38px; font-size: 1.1rem; }
    .panel-dock { 
      top: auto; bottom: 30px; right: 0; left: 0; width: 100%; max-height: 70vh; border-radius: 20px 20px 0 0; transform: translateY(calc(100% - 50px));
    }
    .panel-dock.visible { transform: translateY(0); }
    #dockToggle { display: none; }
    .ruler-h { left: 50px; }
    .ruler-v { display: none; }
    #canvas { margin-left: 50px; }
    .app-menu-bar { gap: 1rem; padding-left: 60px; }
    .menu-bar > div { padding: 0.3rem 0.5rem; font-size: 0.8rem; }
  }

  #loader { 
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #60a5fa; font-size: 1.2rem; font-weight: 600; pointer-events: none; z-index: 5;
  }

  /* Context Menu */
  .context-menu {
    position: fixed; background: #0f172a; border: 1px solid #1e293b; min-width: 180px; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); z-index: 2000; display: none;
  }
  .context-menu div { padding: 0.6rem 1rem; cursor: pointer; font-size: 0.85rem; }
  .context-menu div:hover { background: #1e293b; }
  .context-menu hr { border: none; border-top: 1px solid #1e293b; margin: 0.3rem 0; }
    
  </style>
<!-- Load Paper.js -->
<script src="https://cdn.jsdelivr.net/npm/paper@0.12.17/dist/paper-full.min.js"></script>
<script>
  
<script>
// Clean working Paper.js setup - final version
paper.install(window);
paper.setup(document.getElementById('canvas'));

// Basic state
var tools = {};
var currentTool = null;
var fillColor = '#ff0000';
var strokeColor = '#000000';
var strokeWidth = 1;
var currentPath = null;
var startPoint = null;
var currentShape = null;

// Activate tool
function activateTool(name) {
  if (tools[name]) {
    currentTool = tools[name];
    currentTool.activate();
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById(name + 'Tool');
    if (btn) btn.classList.add('active');
    const status = document.getElementById('statusTool');
    if (status) status.textContent = name.charAt(0).toUpperCase() + name.slice(1) + ' Tool';
  }
}

// Selection Tool
tools.select = new Tool();
tools.select.onMouseDown = function(event) {
  const hit = project.hitTest(event.point, { fill: true, stroke: true, tolerance: 10 });
  if (hit && hit.item) {
    if (!event.modifiers.shift) project.deselectAll();
    hit.item.selected = true;
  } else if (!event.modifiers.shift) {
    project.deselectAll();
  }
};
tools.select.onMouseDrag = function(event) {
  project.selectedItems.forEach(item => item.position += event.delta);
};

// Pen Tool
tools.pen = new Tool();
tools.pen.onMouseDown = function(event) {
  currentPath = new Path({ strokeColor: strokeColor, strokeWidth: strokeWidth });
  currentPath.add(event.point);
};
tools.pen.onMouseDrag = function(event) {
  currentPath.add(event.point);
  currentPath.smooth();
};
tools.pen.onMouseUp = function() {
  currentPath.simplify();
  currentPath.fillColor = fillColor;
  currentPath.selected = true;
  currentPath = null;
};

// Rectangle Tool
tools.rectangle = new Tool();
tools.rectangle.onMouseDown = function(event) {
  startPoint = event.point;
};
tools.rectangle.onMouseDrag = function(event) {
  if (currentShape) currentShape.remove();
  let rect = new Rectangle(startPoint, event.point);
  if (event.modifiers.shift) {
    const size = Math.max(Math.abs(rect.width), Math.abs(rect.height));
    rect = new Rectangle(startPoint, startPoint.add(size * Math.sign(rect.width), size * Math.sign(rect.height)));
  }
  currentShape = new Path.Rectangle(rect);
  currentShape.fillColor = fillColor;
  currentShape.strokeColor = strokeColor;
  currentShape.strokeWidth = strokeWidth;
};
tools.rectangle.onMouseUp = function() {
  if (currentShape) {
    currentShape.selected = true;
    currentShape = null;
  }
};

// Hand Tool
tools.hand = new Tool();
var lastPoint;
tools.hand.onMouseDown = function(event) {
  lastPoint = event.point;
};
tools.hand.onMouseDrag = function(event) {
  view.center -= event.point - lastPoint;
  lastPoint = event.point;
};

// Zoom Tool
tools.zoom = new Tool();
tools.zoom.onMouseDown = function(event) {
  view.zoom *= event.modifiers.alt ? 0.9 : 1.1;
  view.center = event.point;
};

// Connect buttons
document.getElementById('selectTool')?.addEventListener('click', () => activateTool('select'));
document.getElementById('penTool')?.addEventListener('click', () => activateTool('pen'));
document.getElementById('rectangleTool')?.addEventListener('click', () => activateTool('rectangle'));
document.getElementById('handTool')?.addEventListener('click', () => activateTool('hand'));
document.getElementById('zoomTool')?.addEventListener('click', () => activateTool('zoom'));

// Hide loader and start
document.getElementById('loader').style.display = 'none';
activateTool('select');
</script>

<!-- Firebase Auth -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB4JMVBMcWcN2wKsaVYmnggHH5ue1mUfaA",
  authDomain: "bowesproduct.firebaseapp.com",
  projectId: "bowesproduct"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const authBtn = document.getElementById("authBtn");
const profilePic = document.getElementById("profilePic");

authBtn.onclick = () => auth.currentUser ? signOut(auth) : signInWithPopup(auth, provider);

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    authBtn.textContent = "Login";
    profilePic.style.display = "none";
    return;
  }
  authBtn.textContent = "Logout";
  profilePic.src = user.photoURL || "";
  profilePic.style.display = "block";
});
</script>

<!-- Paper.js Vector Editor -->
<script type="text/paperscript" canvas="canvas">
// Global state
var tools = {};
var currentTool;
var fillColor = '#ff0000';
var strokeColor = '#000000';
var strokeWidth = 1;
var currentPath;
var isDrawing = false;
var startPoint;
var currentShape;
var clipboard = null;
var undoStack = [];
var redoStack = [];
var showGrid = false;
var showRulers = true;
var snapToGrid = false;
var gridSize = 20;
var layers = [];
var currentLayerIndex = 0;
var zoomLevel = 1;

// Initialize layers
function initLayers() {
  layers = [
    { name: 'Layer 1', visible: true, locked: false, items: [] }
  ];
  updateLayersList();
}

// Tool activation
function activateTool(name) {
  if (tools[name]) {
    currentTool = tools[name];
    currentTool.activate();
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    var btn = document.getElementById(name + 'Tool');
    if (btn) btn.classList.add('active');
    
    var toolNames = {
      'select': 'Selection Tool',
      'directSelect': 'Direct Selection Tool',
      'pen': 'Pen Tool',
      'pencil': 'Pencil Tool',
      'brush': 'Brush Tool',
      'rectangle': 'Rectangle Tool',
      'ellipse': 'Ellipse Tool',
      'polygon': 'Polygon Tool',
      'star': 'Star Tool',
      'line': 'Line Tool',
      'type': 'Type Tool',
      'typeOnPath': 'Type on Path Tool',
      'touchType': 'Touch Type Tool',
      'shapeBuilder': 'Shape Builder Tool',
      'perspectiveGrid': 'Perspective Grid Tool',
      'freeTransform': 'Free Transform Tool',
      'eyedropper': 'Eyedropper Tool',
      'measure': 'Measure Tool',
      'hand': 'Hand Tool',
      'zoom': 'Zoom Tool'
    };
    
    var statusTool = document.getElementById('statusTool');
    if (statusTool && toolNames[name]) {
      statusTool.textContent = toolNames[name];
    }
  }
}

// Selection Tool
tools.select = new Tool();
tools.select.onMouseDown = function(event) {
  var hit = project.hitTest(event.point, {
    fill: true, stroke: true, segments: true, tolerance: 5
  });
  
  if (hit && hit.item && !hit.item.locked) {
    if (!Key.modifiers.shift) {
      project.deselectAll();
    }
    hit.item.selected = true;
  } else if (!Key.modifiers.shift) {
    project.deselectAll();
  }
  
  updateProperties();
};

tools.select.onMouseDrag = function(event) {
  if (project.selectedItems.length) {
    var delta = event.delta;
    if (snapToGrid) {
      delta.x = Math.round(delta.x / gridSize) * gridSize;
      delta.y = Math.round(delta.y / gridSize) * gridSize;
    }
    project.selectedItems.forEach(function(item) {
      if (!item.locked) {
        item.position += delta;
      }
    });
    updateProperties();
  }
};

tools.select.onMouseUp = function() {
  saveState();
};

// Direct Selection Tool
tools.directSelect = new Tool();
tools.directSelect.onMouseDown = function(event) {
  var hit = project.hitTest(event.point, {
    segments: true, tolerance: 5
  });
  
  if (hit && hit.segment) {
    hit.segment.selected = true;
  } else {
    project.deselectAll();
  }
};

tools.directSelect.onMouseDrag = function(event) {
  var selectedSegments = project.activeLayer.segments.filter(function(s) {
    return s.selected;
  });
  
  if (selectedSegments.length) {
    selectedSegments.forEach(function(segment) {
      segment.point += event.delta;
    });
  }
};

// Pen Tool
tools.pen = new Tool();
var penPoints = [];

tools.pen.onMouseDown = function(event) {
  if (Key.modifiers.alt) {
    // Convert point to curve
    var hit = project.hitTest(event.point, { segments: true, tolerance: 5 });
    if (hit && hit.segment) {
      if (hit.segment.hasHandles()) {
        hit.segment.clearHandles();
      } else {
        hit.segment.handleIn = new Point(-20, 0);
        hit.segment.handleOut = new Point(20, 0);
      }
    }
    return;
  }
  
  if (currentPath && penPoints.length > 0 && event.point.isClose(penPoints[0], 5)) {
    // Close path
    currentPath.closed = true;
    currentPath.fillColor = fillColor;
    currentPath.strokeColor = strokeColor;
    currentPath.strokeWidth = strokeWidth;
    currentPath.simplify();
    currentPath.selected = true;
    penPoints = [];
    currentPath = null;
    saveState();
    return;
  }
  
  if (!currentPath) {
    currentPath = new Path();
    currentPath.strokeColor = strokeColor;
    currentPath.strokeWidth = strokeWidth;
    penPoints = [];
  }
  
  currentPath.add(event.point);
  penPoints.push(event.point);
};

tools.pen.onMouseMove = function(event) {
  if (currentPath && penPoints.length > 0) {
    // Draw preview line
    document.body.style.cursor = 'crosshair';
  }
};

tools.pen.onMouseDrag = function(event) {
  if (currentPath && penPoints.length > 0) {
    // Adjust handles for last point
    var lastSegment = currentPath.lastSegment;
    if (lastSegment) {
      lastSegment.handleOut = event.point - lastSegment.point;
      lastSegment.handleIn = lastSegment.handleOut.rotate(180);
    }
  }
};

tools.pen.onKeyDown = function(event) {
  if (event.key === 'escape') {
    if (currentPath) {
      if (currentPath.segments.length > 1) {
        currentPath.fillColor = fillColor;
        currentPath.simplify();
        saveState();
      } else {
        currentPath.remove();
      }
      currentPath = null;
      penPoints = [];
    }
  } else if (event.key === 'enter') {
    if (currentPath) {
      currentPath.closed = true;
      currentPath.fillColor = fillColor;
      currentPath.strokeColor = strokeColor;
      currentPath.strokeWidth = strokeWidth;
      currentPath.simplify();
      currentPath.selected = true;
      currentPath = null;
      penPoints = [];
      saveState();
    }
  }
};

// Pencil Tool
tools.pencil = new Tool();
tools.pencil.minDistance = 5;

tools.pencil.onMouseDown = function(event) {
  currentPath = new Path();
  currentPath.strokeColor = strokeColor;
  currentPath.strokeWidth = strokeWidth;
  currentPath.add(event.point);
};

tools.pencil.onMouseDrag = function(event) {
  currentPath.add(event.point);
};

tools.pencil.onMouseUp = function(event) {
  if (currentPath) {
    currentPath.simplify();
    currentPath.fillColor = fillColor;
    currentPath.selected = true;
    saveState();
    currentPath = null;
  }
};

// Brush Tool
tools.brush = new Tool();
tools.brush.minDistance = 2;

tools.brush.onMouseDown = function(event) {
  currentPath = new Path();
  currentPath.strokeColor = strokeColor;
  currentPath.strokeWidth = strokeWidth;
  currentPath.strokeCap = 'round';
  currentPath.strokeJoin = 'round';
  currentPath.add(event.point);
};

tools.brush.onMouseDrag = function(event) {
  currentPath.add(event.point);
};

tools.brush.onMouseUp = function(event) {
  if (currentPath) {
    currentPath.smooth();
    currentPath.fillColor = fillColor;
    currentPath.selected = true;
    saveState();
    currentPath = null;
  }
};

// Rectangle Tool
tools.rectangle = new Tool();

tools.rectangle.onMouseDown = function(event) {
  startPoint = event.point;
  currentShape = new Path.Rectangle(startPoint, startPoint);
  currentShape.fillColor = fillColor;
  currentShape.strokeColor = strokeColor;
  currentShape.strokeWidth = strokeWidth;
};

tools.rectangle.onMouseDrag = function(event) {
  if (currentShape) {
    var rect = new Rectangle(startPoint, event.point);
    if (Key.modifiers.shift) {
      // Constrain to square
      var size = Math.max(Math.abs(rect.width), Math.abs(rect.height));
      rect = new Rectangle(startPoint, new Point(startPoint.x + size, startPoint.y + size));
    }
    currentShape.remove();
    currentShape = new Path.Rectangle(rect);
    currentShape.fillColor = fillColor;
    currentShape.strokeColor = strokeColor;
    currentShape.strokeWidth = strokeWidth;
  }
};

tools.rectangle.onMouseUp = function() {
  if (currentShape) {
    currentShape.selected = true;
    saveState();
    currentShape = null;
  }
};

// Ellipse Tool
tools.ellipse = new Tool();

tools.ellipse.onMouseDown = function(event) {
  startPoint = event.point;
  currentShape = new Path.Ellipse({
    center: startPoint,
    radius: [0, 0]
  });
  currentShape.fillColor = fillColor;
  currentShape.strokeColor = strokeColor;
  currentShape.strokeWidth = strokeWidth;
};

tools.ellipse.onMouseDrag = function(event) {
  if (currentShape) {
    var rect = new Rectangle(startPoint, event.point);
    if (Key.modifiers.shift) {
      // Constrain to circle
      var size = Math.max(Math.abs(rect.width), Math.abs(rect.height));
      rect = new Rectangle(startPoint, new Point(startPoint.x + size, startPoint.y + size));
    }
    currentShape.remove();
    currentShape = new Path.Ellipse(rect);
    currentShape.fillColor = fillColor;
    currentShape.strokeColor = strokeColor;
    currentShape.strokeWidth = strokeWidth;
  }
};

tools.ellipse.onMouseUp = function() {
  if (currentShape) {
    currentShape.selected = true;
    saveState();
    currentShape = null;
  }
};

// Polygon Tool
tools.polygon = new Tool();

tools.polygon.onMouseDown = function(event) {
  startPoint = event.point;
  var sides = 6;
  currentShape = new Path.RegularPolygon(startPoint, 0, sides);
  currentShape.fillColor = fillColor;
  currentShape.strokeColor = strokeColor;
  currentShape.strokeWidth = strokeWidth;
};

tools.polygon.onMouseDrag = function(event) {
  if (currentShape) {
    var radius = startPoint.getDistance(event.point);
    var sides = 6;
    currentShape.remove();
    currentShape = new Path.RegularPolygon(startPoint, radius, sides);
    currentShape.fillColor = fillColor;
    currentShape.strokeColor = strokeColor;
    currentShape.strokeWidth = strokeWidth;
  }
};

tools.polygon.onMouseUp = function() {
  if (currentShape) {
    currentShape.selected = true;
    saveState();
    currentShape = null;
  }
};

// Star Tool
tools.star = new Tool();

tools.star.onMouseDown = function(event) {
  startPoint = event.point;
  var points = 5;
  currentShape = new Path.Star(startPoint, 0, 0, 0, points);
  currentShape.fillColor = fillColor;
  currentShape.strokeColor = strokeColor;
  currentShape.strokeWidth = strokeWidth;
};

tools.star.onMouseDrag = function(event) {
  if (currentShape) {
    var outerRadius = startPoint.getDistance(event.point);
    var innerRadius = outerRadius * 0.4;
    var points = 5;
    currentShape.remove();
    currentShape = new Path.Star(startPoint, innerRadius, outerRadius, points);
    currentShape.fillColor = fillColor;
    currentShape.strokeColor = strokeColor;
    currentShape.strokeWidth = strokeWidth;
  }
};

tools.star.onMouseUp = function() {
  if (currentShape) {
    currentShape.selected = true;
    saveState();
    currentShape = null;
  }
};

// Line Tool
tools.line = new Tool();

tools.line.onMouseDown = function(event) {
  startPoint = event.point;
  currentShape = new Path.Line(startPoint, startPoint);
  currentShape.strokeColor = strokeColor;
  currentShape.strokeWidth = strokeWidth;
};

tools.line.onMouseDrag = function(event) {
  if (currentShape) {
    if (Key.modifiers.shift) {
      // Constrain to 45-degree angles
      var angle = Math.atan2(event.point.y - startPoint.y, event.point.x - startPoint.x);
      angle = Math.round(angle / (Math.PI / 4)) * (Math.PI / 4);
      var length = startPoint.getDistance(event.point);
      var endPoint = new Point(
        startPoint.x + length * Math.cos(angle),
        startPoint.y + length * Math.sin(angle)
      );
      currentShape.remove();
      currentShape = new Path.Line(startPoint, endPoint);
    } else {
      currentShape.remove();
      currentShape = new Path.Line(startPoint, event.point);
    }
    currentShape.strokeColor = strokeColor;
    currentShape.strokeWidth = strokeWidth;
  }
};

tools.line.onMouseUp = function() {
  if (currentShape) {
    currentShape.selected = true;
    saveState();
    currentShape = null;
  }
};

// Type Tool
tools.type = new Tool();

tools.type.onMouseDown = function(event) {
  var text = prompt('Enter text:', 'Sample Text');
  if (text) {
    var pointText = new PointText(event.point);
    pointText.content = text;
    pointText.fillColor = fillColor;
    pointText.fontSize = 32;
    pointText.fontFamily = 'Arial';
    pointText.selected = true;
    saveState();
  }
};

// Eyedropper Tool
tools.eyedropper = new Tool();

tools.eyedropper.onMouseDown = function(event) {
  var hit = project.hitTest(event.point, {
    fill: true, stroke: true, tolerance: 5
  });
  
  if (hit && hit.item) {
    if (hit.type === 'fill' && hit.item.fillColor) {
      fillColor = hit.item.fillColor.toCSS(true);
      document.getElementById('fillColor').style.backgroundColor = fillColor;
    }
    if (hit.type === 'stroke' && hit.item.strokeColor) {
      strokeColor = hit.item.strokeColor.toCSS(true);
      document.getElementById('strokeColor').style.backgroundColor = strokeColor;
    }
  }
};

// Hand Tool (Pan)
tools.hand = new Tool();
var handStart;

tools.hand.onMouseDown = function(event) {
  handStart = event.point;
  document.body.style.cursor = 'grabbing';
};

tools.hand.onMouseDrag = function(event) {
  var delta = event.point.subtract(handStart);
  view.center = view.center.subtract(delta);
};

tools.hand.onMouseUp = function() {
  document.body.style.cursor = 'default';
};

// Zoom Tool
tools.zoom = new Tool();

tools.zoom.onMouseDown = function(event) {
  var zoomFactor = Key.modifiers.alt ? 0.8 : 1.25;
  view.zoom = view.zoom * zoomFactor;
  view.center = event.point;
  updateZoomDisplay();
};

// Bind tool buttons
document.getElementById('selectTool').onclick = function() { activateTool('select'); };
document.getElementById('directSelectTool').onclick = function() { activateTool('directSelect'); };
document.getElementById('magicWandTool').onclick = function() { activateTool('select'); };
document.getElementById('penTool').onclick = function() { activateTool('pen'); };
document.getElementById('pencilTool').onclick = function() { activateTool('pencil'); };
document.getElementById('brushTool').onclick = function() { activateTool('brush'); };
document.getElementById('rectangleTool').onclick = function() { activateTool('rectangle'); };
document.getElementById('ellipseTool').onclick = function() { activateTool('ellipse'); };
document.getElementById('polygonTool').onclick = function() { activateTool('polygon'); };
document.getElementById('starTool').onclick = function() { activateTool('star'); };
document.getElementById('lineTool').onclick = function() { activateTool('line'); };
document.getElementById('typeTool').onclick = function() { activateTool('type'); };
document.getElementById('eyedropperTool').onclick = function() { activateTool('eyedropper'); };
document.getElementById('handTool').onclick = function() { activateTool('hand'); };
document.getElementById('zoomTool').onclick = function() { activateTool('zoom'); };

// Color pickers
document.getElementById('fillColor').onclick = function() {
  var color = prompt('Enter fill color (hex):', fillColor);
  if (color) {
    fillColor = color;
    this.style.backgroundColor = color;
    if (project.selectedItems.length) {
      project.selectedItems.forEach(function(item) {
        item.fillColor = color;
      });
    }
  }
};

document.getElementById('strokeColor').onclick = function() {
  var color = prompt('Enter stroke color (hex):', strokeColor);
  if (color) {
    strokeColor = color;
    this.style.backgroundColor = color;
    if (project.selectedItems.length) {
      project.selectedItems.forEach(function(item) {
        item.strokeColor = color;
      });
    }
  }
};

document.getElementById('defaultColors').onclick = function() {
  fillColor = '#ff0000';
  strokeColor = '#000000';
  document.getElementById('fillColor').style.backgroundColor = fillColor;
  document.getElementById('strokeColor').style.backgroundColor = strokeColor;
};

// Update properties panel
function updateProperties() {
  var item = project.selectedItems[0];
  var propX = document.getElementById('propX');
  var propY = document.getElementById('propY');
  var propW = document.getElementById('propW');
  var propH = document.getElementById('propH');
  var propRotation = document.getElementById('propRotation');
  var propShear = document.getElementById('propShear');
  var propOpacity = document.getElementById('propOpacity');
  var propBlendMode = document.getElementById('propBlendMode');
  
  if (item) {
    if (propX) propX.value = Math.round(item.position.x);
    if (propY) propY.value = Math.round(item.position.y);
    if (propW) propW.value = Math.round(item.bounds.width);
    if (propH) propH.value = Math.round(item.bounds.height);
    if (propRotation) propRotation.value = Math.round(item.rotation);
    if (propShear) propShear.value = Math.round(item.shear ? item.shear.x : 0);
    if (propOpacity) propOpacity.value = (item.opacity || 1) * 100;
    if (propBlendMode) propBlendMode.value = item.blendMode || 'normal';
    
    var statusSelection = document.getElementById('statusSelection');
    if (statusSelection) {
      statusSelection.textContent = item.className + ' selected';
    }
  } else {
    if (propX) propX.value = '';
    if (propY) propY.value = '';
    if (propW) propW.value = '';
    if (propH) propH.value = '';
    if (propRotation) propRotation.value = '';
    if (propShear) propShear.value = '';
    
    var statusSelection = document.getElementById('statusSelection');
    if (statusSelection) {
      statusSelection.textContent = 'No selection';
    }
  }
}

// Update transform from properties panel
function updateTransform() {
  var item = project.selectedItems[0];
  if (!item) return;
  
  var x = parseFloat(document.getElementById('propX').value);
  var y = parseFloat(document.getElementById('propY').value);
  var w = parseFloat(document.getElementById('propW').value);
  var h = parseFloat(document.getElementById('propH').value);
  var rotation = parseFloat(document.getElementById('propRotation').value);
  var shear = parseFloat(document.getElementById('propShear').value);
  
  if (!isNaN(x) && !isNaN(y)) {
    item.position = new Point(x, y);
  }
  if (!isNaN(w) && !isNaN(h)) {
    item.bounds.width = w;
    item.bounds.height = h;
  }
  if (!isNaN(rotation)) {
    item.rotation = rotation;
  }
  if (!isNaN(shear)) {
    item.shear = new Point(shear, 0);
  }
  
  saveState();
}

// Update opacity
function updateOpacity() {
  var opacity = parseFloat(document.getElementById('propOpacity').value);
  document.getElementById('opacityVal').textContent = opacity;
  
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.opacity = opacity / 100;
    });
  }
}

// Update blend mode
function updateBlendMode() {
  var blendMode = document.getElementById('propBlendMode').value;
  
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.blendMode = blendMode;
    });
  }
}

// Layers
function updateLayersList() {
  var layersList = document.getElementById('layersList');
  if (!layersList) return;
  
  layersList.innerHTML = '';
  
  for (var i = layers.length - 1; i >= 0; i--) {
    var layer = layers[i];
    var layerItem = document.createElement('div');
    layerItem.className = 'layer-item' + (i === currentLayerIndex ? ' active' : '');
    layerItem.innerHTML = `
      <span class="layer-icon">üìÑ</span>
      <span class="layer-name">${layer.name}</span>
      <div class="layer-actions">
        <button class="btn btn-sm" onclick="toggleLayerVisibility(${i})">${layer.visible ? 'üëÅ' : 'üëÅ‚Äçüó®'}</button>
        <button class="btn btn-sm" onclick="toggleLayerLock(${i})">${layer.locked ? 'üîí' : 'üîì'}</button>
      </div>
    `;
    layerItem.onclick = function(e) {
      if (e.target.tagName !== 'BUTTON') {
        selectLayer(i);
      }
    };
    layersList.appendChild(layerItem);
  }
}

function addLayer() {
  layers.push({
    name: 'Layer ' + (layers.length + 1),
    visible: true,
    locked: false,
    items: []
  });
  currentLayerIndex = layers.length - 1;
  updateLayersList();
}

function deleteLayer() {
  if (layers.length > 1) {
    layers.splice(currentLayerIndex, 1);
    currentLayerIndex = Math.min(currentLayerIndex, layers.length - 1);
    updateLayersList();
  }
}

function selectLayer(index) {
  currentLayerIndex = index;
  updateLayersList();
}

function toggleLayerVisibility(index) {
  layers[index].visible = !layers[index].visible;
  updateLayersList();
}

function toggleLayerLock(index) {
  layers[index].locked = !layers[index].locked;
  updateLayersList();
}

// Save/Undo/Redo
function saveState() {
  var json = project.exportJSON({ asString: false });
  undoStack.push(JSON.stringify(json));
  if (undoStack.length > 50) {
    undoStack.shift();
  }
  redoStack = [];
}

function undo() {
  if (undoStack.length > 1) {
    redoStack.push(undoStack.pop());
    project.clear();
    project.importJSON(JSON.parse(undoStack[undoStack.length - 1]));
  }
}

function redo() {
  if (redoStack.length > 0) {
    var state = redoStack.pop();
    undoStack.push(state);
    project.clear();
    project.importJSON(JSON.parse(state));
  }
}

// Edit operations
function cut() {
  if (project.selectedItems.length) {
    clipboard = JSON.stringify(project.selectedItems.map(function(item) {
      return item.exportJSON({ asString: false });
    }));
    project.selectedItems.forEach(function(item) {
      item.remove();
    });
    saveState();
  }
}

function copy() {
  if (project.selectedItems.length) {
    clipboard = JSON.stringify(project.selectedItems.map(function(item) {
      return item.exportJSON({ asString: false });
    }));
  }
}

function paste() {
  if (clipboard) {
    project.deselectAll();
    var items = JSON.parse(clipboard);
    items.forEach(function(itemData) {
      var item = project.importJSON(itemData);
      item.position = item.position.add(new Point(20, 20));
      item.selected = true;
    });
    saveState();
  }
}

function duplicate() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      var clone = item.clone();
      clone.position = item.position.add(new Point(20, 20));
      clone.selected = true;
      item.selected = false;
    });
    saveState();
  }
}

function deleteSelection() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.remove();
    });
    saveState();
    updateProperties();
  }
}

function selectAll() {
  project.activeLayer.children.forEach(function(item) {
    item.selected = true;
  });
  updateProperties();
}

function deselectAll() {
  project.deselectAll();
  updateProperties();
}

// Arrange
function bringToFront() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.sendToFront();
    });
    saveState();
  }
}

function sendToBack() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.sendToBack();
    });
    saveState();
  }
}

function bringForward() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      var siblings = project.activeLayer.children;
      var index = siblings.indexOf(item);
      if (index < siblings.length - 1) {
        item.insertAbove(siblings[index + 1]);
      }
    });
    saveState();
  }
}

function sendBackward() {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      var siblings = project.activeLayer.children;
      var index = siblings.indexOf(item);
      if (index > 0) {
        item.insertBelow(siblings[index - 1]);
      }
    });
    saveState();
  }
}

// Group/Ungroup
function groupSelection() {
  if (project.selectedItems.length > 1) {
    var group = new Group(project.selectedItems);
    saveState();
  }
}

function ungroupSelection() {
  project.selectedItems.forEach(function(item) {
    if (item instanceof Group) {
      item.ungroup();
    }
  });
  saveState();
}

// Transform
function rotateSelection(angle) {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      item.rotate(angle);
    });
    saveState();
  }
}

function flipSelection(direction) {
  if (project.selectedItems.length) {
    project.selectedItems.forEach(function(item) {
      if (direction === 'horizontal') {
        item.scale(-1, 1);
      } else {
        item.scale(1, -1);
      }
    });
    saveState();
  }
}

// Pathfinder operations
function pathfinder(operation) {
  var items = project.selectedItems.filter(function(item) {
    return item instanceof Path && item.selected;
  });
  
  if (items.length < 2) return;
  
  var result;
  switch(operation) {
    case 'unite':
      result = items[0].unite(items[1]);
      break;
    case 'minus':
      result = items[0].exclude(items[1]);
      break;
    case 'intersect':
      result = items[0].intersect(items[1]);
      break;
    case 'exclude':
      result = items[0].exclude(items[1]);
      break;
  }
  
  if (result) {
    items.forEach(function(item) {
      if (item !== result) item.remove();
    });
    result.fillColor = fillColor;
    result.strokeColor = strokeColor;
    result.strokeWidth = strokeWidth;
    saveState();
  }
}

// Select same
function selectSameFill() {
  if (project.selectedItems.length === 0) return;
  
  var targetColor = project.selectedItems[0].fillColor;
  project.deselectAll();
  
  project.activeLayer.children.forEach(function(item) {
    if (item.fillColor && item.fillColor.toCSS() === targetColor.toCSS()) {
      item.selected = true;
    }
  });
}

function selectSameStroke() {
  if (project.selectedItems.length === 0) return;
  
  var targetColor = project.selectedItems[0].strokeColor;
  project.deselectAll();
  
  project.activeLayer.children.forEach(function(item) {
    if (item.strokeColor && item.strokeColor.toCSS() === targetColor.toCSS()) {
      item.selected = true;
    }
  });
}

function selectSameStrokeWidth() {
  if (project.selectedItems.length === 0) return;
  
  var targetWidth = project.selectedItems[0].strokeWidth;
  project.deselectAll();
  
  project.activeLayer.children.forEach(function(item) {
    if (item.strokeWidth === targetWidth) {
      item.selected = true;
    }
  });
}

// Zoom
function zoomIn() {
  view.zoom = view.zoom * 1.25;
  updateZoomDisplay();
}

function zoomOut() {
  view.zoom = view.zoom * 0.8;
  updateZoomDisplay();
}

function zoomToFit() {
  if (project.activeLayer.children.length > 0) {
    view.fitBounds(project.activeLayer.bounds);
  } else {
    view.zoom = 1;
  }
  updateZoomDisplay();
}

function zoomTo100() {
  view.zoom = 1;
  updateZoomDisplay();
}

function updateZoomDisplay() {
  var zoomPercent = Math.round(view.zoom * 100);
  var statusZoom = document.getElementById('statusZoom');
  if (statusZoom) {
    statusZoom.textContent = zoomPercent + '%';
  }
}

// View options
function toggleGrid() {
  showGrid = !showGrid;
}

function toggleRulers() {
  showRulers = !showRulers;
  var rulerH = document.getElementById('rulerH');
  var rulerV = document.getElementById('rulerV');
  var rulerCorner = document.getElementById('rulerCorner');
  
  if (rulerH) rulerH.style.display = showRulers ? 'block' : 'none';
  if (rulerV) rulerV.style.display = showRulers ? 'block' : 'none';
  if (rulerCorner) rulerCorner.style.display = showRulers ? 'block' : 'none';
}

function toggleSnap() {
  snapToGrid = !snapToGrid;
}

// Draw grid
function onFrame(event) {
  if (showGrid) {
    // Grid would be drawn here
  }
}

// Export functions
function exportSVG() {
  var svg = project.exportSVG({ asString: true });
  var blob = new Blob([svg], { type: 'image/svg+xml' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'artwork.svg';
  a.click();
  URL.revokeObjectURL(url);
}

function exportPNG() {
  var data = view.element.toDataURL('image/png');
  var a = document.createElement('a');
  a.href = data;
  a.download = 'artwork.png';
  a.click();
}

function exportPDF() {
  // Simplified PDF export using SVG
  var svg = project.exportSVG({ asString: true });
  var blob = new Blob([svg], { type: 'application/pdf' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'artwork.pdf';
  a.click();
  URL.revokeObjectURL(url);
}

// File operations
function newDocument() {
  if (confirm('Create new document? All unsaved changes will be lost.')) {
    project.clear();
    undoStack = [];
    redoStack = [];
    initLayers();
    saveState();
  }
}

function saveDocument() {
  var json = project.exportJSON({ asString: true });
  var blob = new Blob([json], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'document.json';
  a.click();
  URL.revokeObjectURL(url);
}

function saveDocumentAs() {
  saveDocument();
}

function handleOpen(event) {
  var file = event.target.files[0];
  if (file) {
    var reader = new FileReader();
    reader.onload = function(e) {
      project.clear();
      project.importJSON(JSON.parse(e.target.result));
      saveState();
    };
    reader.readAsText(file);
  }
}

function handlePlace(event) {
  var file = event.target.files[0];
  if (file) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var raster = new Raster(e.target.result);
      raster.position = view.center;
      saveState();
    };
    reader.readAsDataURL(file);
  }
}

// Type operations
function createOutlines() {
  project.selectedItems.forEach(function(item) {
    if (item instanceof PointText) {
      var outline = item.createOutline();
      item.remove();
      outline.selected = true;
    }
  });
  saveState();
}

function findFont() {
  alert('Font search feature coming soon!');
}

// Context menu
document.addEventListener('contextmenu', function(event) {
  event.preventDefault();
  var contextMenu = document.getElementById('contextMenu');
  if (contextMenu) {
    contextMenu.style.display = 'block';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';
  }
});

document.addEventListener('click', function(event) {
  var contextMenu = document.getElementById('contextMenu');
  if (contextMenu) {
    contextMenu.style.display = 'none';
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(event) {
  if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
  
  // File shortcuts
  if ((event.ctrlKey || event.metaKey) && (event.key === 'n' || event.key === 'N')) {
    if (event.shiftKey) {
      event.preventDefault();
      event.stopPropagation();
      newDocument();
    }
  }
  if ((event.ctrlKey || event.metaKey) && (event.key === 's' || event.key === 'S')) {
    if (event.shiftKey) {
      event.preventDefault();
      event.stopPropagation();
      saveDocument();
    }
  }
  if ((event.ctrlKey || event.metaKey) && (event.key === 'o' || event.key === 'O')) {
    event.preventDefault();
    event.stopPropagation();
    document.getElementById('openFile').click();
  }
  
  // Tool shortcuts
  if (event.key === 'v' || event.key === 'V') {
    if (!event.ctrlKey && !event.metaKey) activateTool('select');
  }
  if (event.key === 'a' || event.key === 'A') {
    if (!event.ctrlKey && !event.metaKey) activateTool('directSelect');
  }
  if (event.key === 'p' || event.key === 'P') {
    if (!event.ctrlKey && !event.metaKey) activateTool('pen');
  }
  if (event.key === 'n' || event.key === 'N') {
    if (!event.ctrlKey && !event.metaKey) activateTool('pencil');
  }
  if (event.key === 'b' || event.key === 'B') {
    if (!event.ctrlKey && !event.metaKey) activateTool('brush');
  }
  if (event.key === 'm' || event.key === 'M') {
    if (!event.ctrlKey && !event.metaKey) activateTool('rectangle');
  }
  if (event.key === 'l' || event.key === 'L') {
    if (!event.ctrlKey && !event.metaKey) activateTool('ellipse');
  }
  if (event.key === 't' || event.key === 'T') {
    if (!event.ctrlKey && !event.metaKey) activateTool('type');
  }
  if (event.key === 'i' || event.key === 'I') {
    if (!event.ctrlKey && !event.metaKey) activateTool('eyedropper');
  }
  if (event.key === 'h' || event.key === 'H') {
    if (!event.ctrlKey && !event.metaKey) activateTool('hand');
  }
  if (event.key === 'z' || event.key === 'Z') {
    if (event.ctrlKey || event.metaKey) {
      event.preventDefault();
      if (event.shiftKey) {
        redo();
      } else {
        undo();
      }
    } else {
      activateTool('zoom');
    }
  }
  
  // Edit shortcuts
  if ((event.ctrlKey || event.metaKey) && event.key === 'c') copy();
  if ((event.ctrlKey || event.metaKey) && event.key === 'x') cut();
  if ((event.ctrlKey || event.metaKey) && event.key === 'v') {
    if (!event.shiftKey) paste();
  }
  if ((event.ctrlKey || event.metaKey) && event.key === 'd') {
    event.preventDefault();
    duplicate();
  }
  if (event.key === 'Delete' || event.key === 'Backspace') {
    if (event.target.tagName !== 'INPUT') {
      deleteSelection();
    }
  }
  if ((event.ctrlKey || event.metaKey) && event.key === 'a') {
    event.preventDefault();
    selectAll();
  }
  if ((event.ctrlKey || event.metaKey) && event.shiftKey && (event.key === 'a' || event.key === 'A')) {
    event.preventDefault();
    deselectAll();
  }
  if ((event.ctrlKey || event.metaKey) && event.key === 'g') {
    event.preventDefault();
    if (event.shiftKey) {
      ungroupSelection();
    } else {
      groupSelection();
    }
  }
  
  // Arrange shortcuts
  if ((event.ctrlKey || event.metaKey) && event.key === ']') {
    if (event.shiftKey) {
      bringToFront();
    } else {
      bringForward();
    }
  }
  if ((event.ctrlKey || event.metaKey) && event.key === '[') {
    if (event.shiftKey) {
      sendToBack();
    } else {
      sendBackward();
    }
  }
  
  // Zoom shortcuts
  if ((event.ctrlKey || event.metaKey) && (event.key === '=' || event.key === '+')) {
    event.preventDefault();
    zoomIn();
  }
  if ((event.ctrlKey || event.metaKey) && event.key === '-') {
    event.preventDefault();
    zoomOut();
  }
  if ((event.ctrlKey || event.metaKey) && event.key === '0') {
    event.preventDefault();
    zoomToFit();
  }
  if ((event.ctrlKey || event.metaKey) && event.key === '1') {
    event.preventDefault();
    zoomTo100();
  }
  
  // Escape key
  if (event.key === 'Escape') {
    deselectAll();
    if (currentPath) {
      currentPath.remove();
      currentPath = null;
      penPoints = [];
    }
  }
});

// Mouse position tracking
view.onMouseMove = function(event) {
  var statusPosition = document.getElementById('statusPosition');
  if (statusPosition) {
    statusPosition.textContent = 'X: ' + Math.round(event.point.x) + ' Y: ' + Math.round(event.point.y);
  }
};

// Selection changed handler
project.on('selectionchanged', updateProperties);

// Initialize
initLayers();
activateTool('select');
saveState();

// Hide loader
setTimeout(function() {
  var loader = document.getElementById('loader');
  if (loader) {
    loader.style.display = 'none';
  }
}, 500);
</script>

<script>
// Panel tab switching
document.querySelectorAll('.panel-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel-section').forEach(s => s.classList.remove('active'));
    
    this.classList.add('active');
    document.getElementById('panel-' + this.dataset.panel).classList.add('active');
  });
});

// Dock toggle
const dock = document.getElementById('panelDock');
const dockToggle = document.getElementById('dockToggle');
let dockVisible = true;

dockToggle.onclick = function() {
  dockVisible = !dockVisible;
  dock.classList.toggle('visible', dockVisible);
  dock.classList.toggle('hidden', !dockVisible);
  dockToggle.textContent = dockVisible ? '‚óÄ' : '‚ñ∂';
};

// Show specific panel
function showPanel(panelName) {
  document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel-section').forEach(s => s.classList.remove('active'));
  
  var tab = document.querySelector('.panel-tab[data-panel="' + panelName + '"]');
  if (tab) tab.classList.add('active');
  
  var section = document.getElementById('panel-' + panelName);
  if (section) section.classList.add('active');
  
  // Show dock if hidden
  dock.classList.add('visible');
  dock.classList.remove('hidden');
  dockVisible = true;
  dockToggle.textContent = '‚óÄ';
}

// Gradient controls
document.getElementById('gradientAngle').addEventListener('input', function() {
  document.getElementById('gradientAngleVal').textContent = this.value + '¬∞';
});

// Stroke controls
document.getElementById('strokeWeight').addEventListener('input', function() {
  document.getElementById('strokeWeightVal').textContent = this.value + ' px';
});

// Mobile bottom sheet toggle
const mobilePanelToggle = document.createElement('div');
mobilePanelToggle.id = 'mobilePanelToggle';
mobilePanelToggle.style.cssText = 'position:fixed;bottom:0;left:0;right:0;height:50px;background:rgba(2,6,23,0.98);border-top:1px solid #1e293b;display:flex;align-items:center;justify-content:center;color:#60a5fa;font-size:0.9rem;cursor:pointer;z-index:999;display:none;';
mobilePanelToggle.innerHTML = '<span>‚ñ≤ Show Panels</span>';
document.body.appendChild(mobilePanelToggle);

if (window.innerWidth <= 900) {
  mobilePanelToggle.style.display = 'flex';
  dock.classList.remove('visible');
  dock.classList.add('hidden');
  dockVisible = false;
}

mobilePanelToggle.onclick = function() {
  dockVisible = !dockVisible;
  dock.classList.toggle('visible', dockVisible);
  dock.classList.toggle('hidden', !dockVisible);
  this.querySelector('span').textContent = dockVisible ? '‚ñº Hide Panels' : '‚ñ≤ Show Panels';
};

// Window resize handler
window.addEventListener('resize', function() {
  if (window.innerWidth <= 900) {
    mobilePanelToggle.style.display = 'flex';
  } else {
    mobilePanelToggle.style.display = 'none';
    dock.classList.add('visible');
    dock.classList.remove('hidden');
    dockVisible = true;
  }
});

// Swatches
const defaultSwatches = [
  '#000000', '#ffffff', '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff',
  '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#6c5ce7', '#fd79a8',
  '#e17055', '#00b894', '#0984e3', '#6c5ce7', '#fdcb6e', '#636e72', '#2d3436', '#b2bec3'
];

function initSwatches() {
  const swatchGrid = document.getElementById('swatchGrid');
  if (!swatchGrid) return;
  
  swatchGrid.innerHTML = '';
  defaultSwatches.forEach(color => {
    const swatch = document.createElement('div');
    swatch.className = 'swatch';
    swatch.style.backgroundColor = color;
    swatch.onclick = function() {
      if (window.project && window.project.selectedItems && window.project.selectedItems.length) {
        window.project.selectedItems.forEach(item => {
          item.fillColor = color;
        });
      }
    };
    swatchGrid.appendChild(swatch);
  });
}

// Appearance panel functions
function addFill() {
  // Add new fill appearance item
  const appearanceList = document.getElementById('appearanceList');
  if (appearanceList) {
    const item = document.createElement('div');
    item.className = 'appearance-item';
    item.innerHTML = `
      <span class="type">Fill</span>
      <div class="color-preview" style="background-color: #ff0000"></div>
      <span class="value">#ff0000</span>
    `;
    appearanceList.appendChild(item);
  }
}

function addStroke() {
  const appearanceList = document.getElementById('appearanceList');
  if (appearanceList) {
    const item = document.createElement('div');
    item.className = 'appearance-item';
    item.innerHTML = `
      <span class="type">Stroke</span>
      <div class="color-preview" style="background-color: #000000"></div>
      <span class="value">#000000</span>
    `;
    appearanceList.appendChild(item);
  }
}

// Stroke panel functions
function setStrokeCap(cap) {
  if (window.project && window.project.selectedItems && window.project.selectedItems.length) {
    window.project.selectedItems.forEach(item => {
      item.strokeCap = cap;
    });
  }
}

function setStrokeJoin(join) {
  if (window.project && window.project.selectedItems && window.project.selectedItems.length) {
    window.project.selectedItems.forEach(item => {
      item.strokeJoin = join;
    });
  }
}

function updateStroke() {
  const weight = parseFloat(document.getElementById('strokeWeight').value);
  const dash = document.getElementById('strokeDash').value;
  const color = document.getElementById('strokeColorInput').value;
  
  if (window.project && window.project.selectedItems && window.project.selectedItems.length) {
    window.project.selectedItems.forEach(item => {
      item.strokeWidth = weight;
      if (dash) {
        const dashArray = dash.split(',').map(d => parseFloat(d.trim()));
        item.dashArray = dashArray;
      } else {
        item.dashArray = [];
      }
      item.strokeColor = color;
    });
  }
}

// Align functions
function align(alignment) {
  if (!window.project || !window.project.selectedItems || window.project.selectedItems.length < 2) return;
  
  const items = window.project.selectedItems;
  const bounds = items.map(item => item.bounds);
  
  switch(alignment) {
    case 'left':
      items.forEach(item => item.position.x = bounds[0].left);
      break;
    case 'right':
      items.forEach(item => item.position.x = bounds[0].right - (item.bounds.width / 2));
      break;
    case 'top':
      items.forEach(item => item.position.y = bounds[0].top);
      break;
    case 'bottom':
      items.forEach(item => item.position.y = bounds[0].bottom - (item.bounds.height / 2));
      break;
    case 'center-h':
      items.forEach(item => item.position.x = bounds[0].center.x);
      break;
    case 'center-v':
      items.forEach(item => item.position.y = bounds[0].center.y);
      break;
  }
}

function distribute(distribution) {
  if (!project || !project.selectedItems || project.selectedItems.length < 3) return;
  
  const items = project.selectedItems;
  // Simplified distribution - would need more complex calculation for proper distribution
  alert('Distribute feature - arrange items evenly');
}

// Typography functions
function updateTypography() {
  if (!window.project || !window.project.selectedItems || window.project.selectedItems.length === 0) return;
  
  const fontFamily = document.getElementById('fontFamily').value;
  const fontSize = parseInt(document.getElementById('fontSize').value);
  const lineHeight = parseInt(document.getElementById('lineHeight').value);
  const letterSpacing = parseInt(document.getElementById('letterSpacing').value);
  
  window.project.selectedItems.forEach(item => {
    if (item instanceof PointText) {
      item.fontFamily = fontFamily;
      item.fontSize = fontSize;
      item.leading = lineHeight;
      // item.letterSpacing = letterSpacing; // May need different property name
    }
  });
}

function setFontStyle(style) {
  if (!window.project || !window.project.selectedItems || window.project.selectedItems.length === 0) return;
  
  window.project.selectedItems.forEach(item => {
    if (item instanceof PointText) {
      switch(style) {
        case 'bold':
          item.fontWeight = 'bold';
          break;
        case 'italic':
          item.fontStyle = 'italic';
          break;
        case 'underline':
          // Text decoration not directly available in Paper.js
          break;
      }
    }
  });
}

function setTextAlign(align) {
  if (!window.project || !window.project.selectedItems || window.project.selectedItems.length === 0) return;
  
  window.project.selectedItems.forEach(item => {
    if (item instanceof PointText) {
      item.justification = align;
    }
  });
}

// Swatch functions
function addSwatch() {
  const color = prompt('Enter hex color:', '#000000');
  if (color && /^#[0-9A-Fa-f]{6}$/.test(color)) {
    defaultSwatches.push(color);
    initSwatches();
  }
}

function clearSwatches() {
  if (confirm('Clear all custom swatches?')) {
    defaultSwatches.length = 8; // Keep original 8
    initSwatches();
  }
}

// Gradient functions
function setGradientType(type) {
  // Would implement gradient application to selected items
  alert('Gradient type: ' + type);
}

// Transform dialog
function showTransformDialog() {
  alert('Transform dialog - coming soon!');
}

// Initialize swatches on load
window.onload = function() {
  initSwatches();
  addFill();
  addStroke();
};

// Mobile touch support
document.addEventListener('touchstart', function(e) {
  // Prevent default touch behaviors that might interfere with drawing
  if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
    // e.preventDefault(); // Commented out to allow scrolling
  }
}, { passive: false });
</script>
</body>
</html>






